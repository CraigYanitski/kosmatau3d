
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kosmatau3d.comparison.model_selection &#8212; kosmatau3d 1.0.3 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/readthedocs-custom.css?v=0fedbe66" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script src="../../../_static/documentation_options.js?v=6e0e1bcd"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/kosmatau3d/comparison/model_selection';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    <p class="title logo__title">kosmatau3d 1.0.3 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../installation.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../properties.html">
                        Clump Properties
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../voxel.html">
                        Voxels
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../model.html">
                        3D Models
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../comparison.html">
                        Comparison to Observations
                      </a>
                    </li>
                
            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-header-nav-more-links">
                    More
                </button>
                <ul id="pst-header-nav-more-links" class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../../development.html">
                        Future Development
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../../_autosummary/kosmatau3d.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../../acknowledgements.html">
                        Acknowledgements
                      </a>
                    </li>
                
                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../installation.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../properties.html">
                        Clump Properties
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../voxel.html">
                        Voxels
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../model.html">
                        3D Models
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../comparison.html">
                        Comparison to Observations
                      </a>
                    </li>
                
            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-header-nav-more-links">
                    More
                </button>
                <ul id="pst-header-nav-more-links" class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../../development.html">
                        Future Development
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../../_autosummary/kosmatau3d.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../../acknowledgements.html">
                        Acknowledgements
                      </a>
                    </li>
                
                </ul>
            </li>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../comparison.html" class="nav-link">kosmatau3d.comparison</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">kosmatau3d.c...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for kosmatau3d.comparison.model_selection</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This subsubpackage contains functions to regrid and resample observational data,</span>
<span class="sd">compute error, compare to grids of :code:`kosmatau3d` models, and plot the results.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">cygrid</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Gaussian1DKernel</span><span class="p">,</span> <span class="n">Gaussian2DKernel</span><span class="p">,</span> <span class="n">convolve</span>
<span class="kn">from</span> <span class="nn">astropy.visualization.wcsaxes.frame</span> <span class="kn">import</span> <span class="n">EllipticalFrame</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">interp2d</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">trapz</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">readsav</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binned_statistic</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">StrMethodFormatter</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">spectres</span> <span class="kn">import</span> <span class="n">spectres</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">.observation</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">kosmatau3d</span> <span class="kn">import</span> <span class="n">models</span>


<span class="n">sedigism_rms_window</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;G014_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>
    <span class="s1">&#39;G312_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;G326_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;G341_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;G000_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
    <span class="s1">&#39;G001_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
    <span class="s1">&#39;G002_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
    <span class="s1">&#39;G003_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
    <span class="s1">&#39;G004_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="s1">&#39;G005_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="s1">&#39;G006_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="s1">&#39;G007_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>
    <span class="s1">&#39;G008_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>
    <span class="s1">&#39;G009_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>
    <span class="s1">&#39;G010_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s1">&#39;G011_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s1">&#39;G012_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s1">&#39;G013_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>
    <span class="s1">&#39;G015_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>
    <span class="s1">&#39;G016_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>
    <span class="s1">&#39;G017_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s1">&#39;G030_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
    <span class="s1">&#39;G301_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G302_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G303_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="s1">&#39;G304_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="s1">&#39;G305_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="s1">&#39;G306_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;G307_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G308_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G309_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G310_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G311_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G313_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G314_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G315_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G316_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G317_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G318_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G319_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G320_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G321_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G322_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G323_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G324_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G324_13CO21_Tmb_DR1.fits.1&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G325_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G327_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;G328_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;G329_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;G330_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;G331_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;G332_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G333_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G334_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G335_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G336_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G337_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G338_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G339_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G340_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G342_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G343_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G344_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G345_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G346_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G347_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G348_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G349_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G350_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G351_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G352_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="s1">&#39;G353_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s1">&#39;G354_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
    <span class="s1">&#39;G355_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
    <span class="s1">&#39;G356_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
    <span class="s1">&#39;G357_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="s1">&#39;G358_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="s1">&#39;G359_13CO21_Tmb_DR1.fits&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">thrumms_rms_window</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;dr3.s300.12co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr3.s306.12co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr3.s312.12co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr3.s318.12co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr3.s324.12co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr3.s330.12co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr3.s336.12co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr3.s342.12co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr3.s348.12co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr3.s354.12co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr4.s300.13co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr4.s306.13co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr4.s312.13co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr4.s318.13co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr4.s324.13co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr4.s330.13co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr4.s336.13co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr4.s342.13co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr4.s348.13co.fits&#39;</span> <span class="p">:</span> <span class="p">(),</span>
    <span class="s1">&#39;dr4.s354.13co.fits&#39;</span> <span class="p">:</span> <span class="p">()</span>
<span class="p">}</span>
<span class="n">sgps_rms_window</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;g010.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span>
    <span class="s1">&#39;g015.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>
    <span class="s1">&#39;g258.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>
    <span class="s1">&#39;g268.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>
    <span class="s1">&#39;g278.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>
    <span class="s1">&#39;g288.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.6</span><span class="p">,</span>
    <span class="s1">&#39;g298.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>
    <span class="s1">&#39;g308.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
    <span class="s1">&#39;g318.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.6</span><span class="p">,</span>
    <span class="s1">&#39;g328.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.7</span><span class="p">,</span>
    <span class="s1">&#39;g338.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.9</span><span class="p">,</span>
    <span class="s1">&#39;g348.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">1.9</span><span class="p">,</span>
    <span class="s1">&#39;g353.hi.fits&#39;</span> <span class="p">:</span> <span class="mf">2.6</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">cobe_idl_linfrq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">115.3</span><span class="p">,</span> <span class="mf">230.5</span><span class="p">,</span> <span class="mf">345.8</span><span class="p">,</span> <span class="mf">424.8</span><span class="p">,</span> <span class="mf">461.0</span><span class="p">,</span> <span class="mf">492.2</span><span class="p">,</span> <span class="mf">556.9</span><span class="p">,</span> <span class="mf">576.3</span><span class="p">,</span> <span class="mf">691.5</span><span class="p">,</span> <span class="mf">808.1</span><span class="p">,</span>
                             <span class="mi">1113</span><span class="p">,</span>  <span class="mi">1460</span><span class="p">,</span>  <span class="mi">2226</span><span class="p">,</span>  <span class="mi">1901</span><span class="p">,</span>  <span class="mi">2060</span><span class="p">,</span>  <span class="mi">2311</span><span class="p">,</span>  <span class="mi">2459</span><span class="p">,</span>  <span class="mi">2589</span><span class="p">,</span> <span class="mf">921.8</span><span class="p">])</span>
<span class="n">cobe_idl_transitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;CO 1&#39;</span><span class="p">,</span>       <span class="s1">&#39;CO 2&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 3&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 4&#39;</span><span class="p">,</span> <span class="s1">&#39;C 1&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 5&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;CO 6&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 7 + C 2&#39;</span><span class="p">,</span> <span class="s1">&#39;C+ 1&#39;</span><span class="p">,</span>  <span class="s1">&#39;O 1&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 8&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="determine_rms">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.determine_rms.html#kosmatau3d.comparison.model_selection.determine_rms">[docs]</a>
<span class="k">def</span> <span class="nf">determine_rms</span><span class="p">(</span><span class="n">hdul</span><span class="p">,</span> <span class="n">mission</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    determine RMS of selected surveys.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">astrokit</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mission</span><span class="p">,</span> <span class="s1">&#39;GOT C+&#39;</span><span class="p">,</span> <span class="n">mission</span><span class="o">==</span><span class="s1">&#39;GOT C+&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;GOT C+&#39;</span><span class="p">:</span>

        <span class="c1"># Create velocity axis</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">astrokit</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">hdul</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">astrokit</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">hdul</span><span class="p">)</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">astrokit</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">hdul</span><span class="p">)</span>

        <span class="c1"># make an empty map</span>
        <span class="n">map_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">map_size</span><span class="p">)</span>
        <span class="n">hdul_rms</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu</span><span class="p">])</span>
        <span class="n">hdul_rms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># remove 3d attributes from header</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">hdul_rms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">attribute</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">hdul_rms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">attribute</span> <span class="o">==</span> <span class="s1">&#39;NAXIS&#39;</span><span class="p">):</span>
                    <span class="n">hdul_rms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">clean_noise</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">rms_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">i_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vel</span><span class="o">&gt;=-</span><span class="mi">150</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vel</span><span class="o">&lt;=</span><span class="mi">50</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat</span><span class="o">&lt;=</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lat</span><span class="o">&gt;=-</span><span class="mi">90</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lon</span><span class="o">&lt;=-</span><span class="mi">10</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">rms_mask</span><span class="p">[</span><span class="n">i_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vel</span><span class="o">&gt;=-</span><span class="mi">100</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vel</span><span class="o">&lt;=</span><span class="mi">150</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat</span><span class="o">&lt;=</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lat</span><span class="o">&gt;=-</span><span class="mi">90</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lon</span><span class="o">&gt;=-</span><span class="mi">10</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lon</span><span class="o">&lt;=</span><span class="mi">10</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">rms_mask</span><span class="p">[</span><span class="n">i_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vel</span><span class="o">&gt;=-</span><span class="mi">50</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vel</span><span class="o">&lt;=</span><span class="mi">200</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat</span><span class="o">&lt;=</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lat</span><span class="o">&gt;=-</span><span class="mi">90</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lon</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">rms_mask</span><span class="p">[</span><span class="n">i_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">clean_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">rms_mask</span><span class="p">)</span>
        <span class="n">clean_noise</span><span class="p">[</span><span class="n">clean_data</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">clean_noise</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">rms</span><span class="p">[</span><span class="n">rms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rms</span><span class="p">[</span><span class="n">rms</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">hdul_rms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">rms</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;COGAL&#39;</span><span class="p">:</span>

        <span class="n">mean</span><span class="o">=</span><span class="kc">True</span>

        <span class="c1"># Ensure data has the correct dimensions (in fits format: glon, glat, vel_lsr)</span>
        <span class="n">cube_co_fix</span> <span class="o">=</span> <span class="n">astrokit</span><span class="o">.</span><span class="n">swap_cube_axis</span><span class="p">(</span><span class="n">hdul</span><span class="p">)</span>

        <span class="c1"># Create the velocity axis</span>
        <span class="n">lon_co</span> <span class="o">=</span> <span class="n">astrokit</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cube_co_fix</span><span class="p">)</span>
        <span class="n">lat_co</span> <span class="o">=</span> <span class="n">astrokit</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cube_co_fix</span><span class="p">)</span>
        <span class="n">vel_co</span> <span class="o">=</span> <span class="n">astrokit</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">cube_co_fix</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e3</span>

        <span class="c1"># make an empty map</span>
        <span class="n">map_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cube_co_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">map_size</span><span class="p">)</span>
        <span class="n">hdul_rms</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu</span><span class="p">])</span>
        <span class="n">hdul_rms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cube_co_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># remove 3d attributes from header</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">hdul_rms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">attribute</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">hdul_rms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">attribute</span> <span class="o">==</span> <span class="s1">&#39;NAXIS&#39;</span><span class="p">):</span>
                    <span class="n">hdul_rms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">mean</span><span class="p">:</span>
            <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">cube_co_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#     print(&#39;mean&#39;, med, &#39;K&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">cube_co_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#     print(&#39;median&#39;, med, &#39;K&#39;)</span>
        <span class="c1"># print(&#39;std for data &lt; median:&#39;, cube_co_fix[0].data[cube_co_fix[0].data &lt; med.reshape(1, *med.shape)].std(), &#39;K&#39;)</span>

        <span class="n">clean_noise</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">cube_co_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">rms_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cube_co_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># i_mask = raw_data &gt; med</span>
        <span class="c1"># rms_mask[i_mask] = 1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape&#39;</span><span class="p">,</span> <span class="n">cube_co_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">i_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vel_co</span><span class="o">&gt;=-</span><span class="mi">50</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vel_co</span><span class="o">&lt;=</span><span class="mi">150</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_co</span><span class="o">&lt;=</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lat_co</span><span class="o">&gt;=-</span><span class="mi">90</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lon_co</span><span class="o">&gt;=-</span><span class="mi">180</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lon_co</span><span class="o">&lt;-</span><span class="mi">70</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">rms_mask</span><span class="p">[</span><span class="n">i_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vel_co</span><span class="o">&gt;=-</span><span class="mi">220</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vel_co</span><span class="o">&lt;=</span><span class="mi">125</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_co</span><span class="o">&lt;=</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lat_co</span><span class="o">&gt;=-</span><span class="mi">90</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lon_co</span><span class="o">&gt;=-</span><span class="mi">70</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lon_co</span><span class="o">&lt;-</span><span class="mi">7</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">rms_mask</span><span class="p">[</span><span class="n">i_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vel_co</span><span class="o">&gt;=-</span><span class="mi">310</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vel_co</span><span class="o">&lt;=</span><span class="mi">320</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_co</span><span class="o">&lt;=</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lat_co</span><span class="o">&gt;=-</span><span class="mi">90</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lon_co</span><span class="o">&gt;=-</span><span class="mi">7</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lon_co</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">rms_mask</span><span class="p">[</span><span class="n">i_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vel_co</span><span class="o">&gt;=-</span><span class="mi">80</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vel_co</span><span class="o">&lt;=</span><span class="mi">200</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_co</span><span class="o">&lt;=</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lat_co</span><span class="o">&gt;=-</span><span class="mi">90</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lon_co</span><span class="o">&gt;=</span><span class="mi">7</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lon_co</span><span class="o">&lt;</span><span class="mi">50</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">rms_mask</span><span class="p">[</span><span class="n">i_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vel_co</span><span class="o">&gt;=-</span><span class="mi">60</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vel_co</span><span class="o">&lt;=</span><span class="mi">75</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_co</span><span class="o">&lt;=</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lat_co</span><span class="o">&gt;=-</span><span class="mi">90</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lon_co</span><span class="o">&gt;=</span><span class="mi">50</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lon_co</span><span class="o">&lt;</span><span class="mi">70</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">rms_mask</span><span class="p">[</span><span class="n">i_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vel_co</span><span class="o">&gt;=-</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vel_co</span><span class="o">&lt;=</span><span class="mi">25</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_co</span><span class="o">&lt;=</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lat_co</span><span class="o">&gt;=-</span><span class="mi">90</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lon_co</span><span class="o">&gt;=</span><span class="mi">70</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lon_co</span><span class="o">&lt;=</span><span class="mi">180</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">rms_mask</span><span class="p">[</span><span class="n">i_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">clean_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">cube_co_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">rms_mask</span><span class="p">)</span>
        <span class="n">clean_noise</span><span class="p">[</span><span class="n">clean_data</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">clean_noise</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">rms</span><span class="p">[</span><span class="n">rms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rms</span><span class="p">[</span><span class="n">rms</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">hdul_rms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">rms</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;SEDIGISM&#39;</span><span class="p">:</span>

        <span class="c1"># Create velocity axis</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">astrokit</span><span class="o">.</span><span class="n">get_axis</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">hdul</span><span class="p">)</span>

        <span class="c1"># Set velocity window of the emission</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">sedigism_rms_window</span><span class="p">[</span><span class="n">file</span><span class="p">]</span>

        <span class="c1"># Calculate the rms noise</span>
        <span class="n">hdul_rms</span> <span class="o">=</span> <span class="n">astrokit</span><span class="o">.</span><span class="n">rms_map</span><span class="p">(</span><span class="n">hdul</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">rms_range</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not available for RMS calculation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mission</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">hdul_rms</span></div>



<div class="viewcode-block" id="regrid_observations">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.regrid_observations.html#kosmatau3d.comparison.model_selection.regrid_observations">[docs]</a>
<span class="k">def</span> <span class="nf">regrid_observations</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;/media/hpc_backup/yanitski/projects/pdr/observational_data/MilkyWay/&#39;</span><span class="p">,</span> <span class="n">mission</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">nu_planck</span><span class="o">=</span><span class="mf">713e9</span><span class="p">,</span> <span class="n">target_header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;obs_regridded.fits&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function will regrid the specified mission data to the specified target header. This prepares the</span>
<span class="sd">    observational data for comparison to simulated data. For now, the target header must</span>

<span class="sd">    :param path: The directory storing the mission folders. Each mission folder should contain the relevant fits files.</span>
<span class="sd">    :param mission: The mission you wish to regrid. The default functionality is to regrid all missions.</span>
<span class="sd">    :param target_header: The target header, which must have longitude on axis 1 and latitude on axis 2. An optional</span>
<span class="sd">        axis 3 may be used for the velocity. If there is not a third dimension, the data will be regridded with a</span>
<span class="sd">        spacing of 1 km/s.</span>
<span class="sd">    :param target_kernel: The kernel to use for regridding.</span>
<span class="sd">    :return: Float -- 0 for success; 1 for fail</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">import</span> <span class="nn">healpy</span> <span class="k">as</span> <span class="nn">hp</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mission</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">mission</span> <span class="o">=</span> <span class="p">[</span><span class="n">mission</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mission</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">mission</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">mission</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mission</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Regridding </span><span class="si">{}</span><span class="s1"> survey&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mission</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid mission... </span><span class="si">{}</span><span class="s1"> observations do not exist or are not downloaded&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mission</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">target_header</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: Please specify target_header to regrid the observations.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Regrid failed.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">target_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                 <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span>
                                 <span class="p">(</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                 <span class="n">num</span><span class="o">=</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: Please enter a target velocity to regrid the spectroscopic observations.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>
        <span class="n">target_vel</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">min_vel</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_vel</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">CO1</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">CO2</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">iCO1</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">iCO2</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dust</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">cobe</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">survey</span> <span class="ow">in</span> <span class="n">mission</span><span class="p">:</span>

        <span class="c1"># COBE data must be located in instrument-separated folders</span>
        <span class="c1"># if survey == &#39;COBE&#39;:</span>
        <span class="c1">#     survey = &#39;COBE-FIRAS&#39;</span>

        <span class="n">temp_header</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">target_header</span><span class="p">)</span>
        <span class="n">twod_header</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">target_header</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;CDELT3&#39;</span> <span class="ow">in</span> <span class="n">twod_header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">survey</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">survey</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span><span class="p">)</span>

        <span class="c1"># Initialise cygrid gridders</span>
        <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COGAL&#39;</span><span class="p">:</span>
            <span class="n">co1_gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">target_header</span><span class="p">)</span>
            <span class="n">co1_gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">co1_gridder_err</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">twod_header</span><span class="p">)</span>
            <span class="n">co1_gridder_err</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">CO1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Mopra&#39;</span><span class="p">:</span>
            <span class="n">co1_gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">target_header</span><span class="p">)</span>
            <span class="n">co1_gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">co1_gridder_err</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">twod_header</span><span class="p">)</span>
            <span class="n">co1_gridder_err</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">CO1</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ico1_gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">target_header</span><span class="p">)</span>
            <span class="n">ico1_gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">ico1_gridder_err</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">twod_header</span><span class="p">)</span>
            <span class="n">ico1_gridder_err</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">iCO1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;ThrUMMS&#39;</span><span class="p">:</span>
            <span class="n">co1_gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">target_header</span><span class="p">)</span>
            <span class="n">co1_gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">co1_gridder_err</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">twod_header</span><span class="p">)</span>
            <span class="n">co1_gridder_err</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">CO1</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ico1_gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">target_header</span><span class="p">)</span>
            <span class="n">ico1_gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">ico1_gridder_err</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">twod_header</span><span class="p">)</span>
            <span class="n">ico1_gridder_err</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">iCO1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;THOR&#39;</span><span class="p">:</span>
            <span class="n">hi_gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">target_header</span><span class="p">)</span>
            <span class="n">hi_gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">hi_gridder_err</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">twod_header</span><span class="p">)</span>
            <span class="n">hi_gridder_err</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;SEDIGISM&#39;</span><span class="p">:</span>
            <span class="n">ico2_gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">target_header</span><span class="p">)</span>
            <span class="n">ico2_gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">ico2_gridder_err</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">twod_header</span><span class="p">)</span>
            <span class="n">ico2_gridder_err</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
            <span class="n">iCO2</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">:</span>
            <span class="n">dust</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">:</span>
            <span class="n">cobe</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Survey </span><span class="si">{}</span><span class="s1"> not available. Choose another.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;regridded&#39;</span> <span class="ow">or</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;temp&#39;</span> <span class="ow">or</span> <span class="s1">&#39;RMS&#39;</span> <span class="ow">in</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;HiGAL&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Grid data and RMS</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COGAL&#39;</span> <span class="ow">and</span> <span class="s1">&#39;interp&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="c1"># Specify transition</span>
                <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CO 1&#39;</span><span class="p">]</span>
                <span class="n">transition_indeces</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Open file</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>

                <span class="c1"># Get axes</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>

                <span class="c1"># Copy header</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>

                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">spectres</span><span class="p">(</span><span class="n">target_vel</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">obs_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">obs_error</span> <span class="o">=</span> <span class="n">determine_rms</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mission</span><span class="o">=</span><span class="n">survey</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">obs_error</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="c1"># obs_error = np.swapaxes(obs_error, 0, 2)</span>
                <span class="c1"># obs_error = np.swapaxes(obs_error, 0, 1)</span>

                <span class="c1"># Grid</span>
                <span class="n">lon_mesh</span><span class="p">,</span> <span class="n">lat_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
                <span class="n">co1_gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">obs_data</span><span class="p">)</span>
                <span class="n">co1_gridder_err</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">obs_error</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_vel</span><span class="p">:</span>
                    <span class="n">min_vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_vel</span><span class="p">:</span>
                    <span class="n">max_vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Mopra&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;_Vfull.fits&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="s1">&#39;12CO&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;13CO&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="n">transition</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Specify transition</span>
                <span class="k">if</span> <span class="s1">&#39;12CO&#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CO 1&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s1">&#39;13CO&#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;13CO 1&#39;</span><span class="p">]</span>
                <span class="n">transition_indeces</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Open file</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">obs_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_Vfull&#39;</span><span class="p">,</span> <span class="s1">&#39;.sigma&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

                <span class="c1"># Get axes</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e3</span>

                <span class="c1"># Copy header</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>

                <span class="c1"># Grid</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">spectres</span><span class="p">(</span><span class="n">target_vel</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">obs_error</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_Vfull&#39;</span><span class="p">,</span> <span class="s1">&#39;.sigma&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">i_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_error</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">obs</span>

                <span class="c1"># Grid</span>
                <span class="n">lon_mesh</span><span class="p">,</span> <span class="n">lat_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;12CO&#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="n">co1_gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">obs_data</span><span class="p">)</span>
                    <span class="n">co1_gridder_err</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">~</span><span class="n">i_nan</span><span class="o">.</span><span class="n">flatten</span><span class="p">()],</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">~</span><span class="n">i_nan</span><span class="o">.</span><span class="n">flatten</span><span class="p">()],</span>
                                         <span class="n">obs_error</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">])</span>
                <span class="k">elif</span> <span class="s1">&#39;13CO&#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="n">ico1_gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">obs_data</span><span class="p">)</span>
                    <span class="n">ico1_gridder_err</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">~</span><span class="n">i_nan</span><span class="o">.</span><span class="n">flatten</span><span class="p">()],</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">~</span><span class="n">i_nan</span><span class="o">.</span><span class="n">flatten</span><span class="p">()],</span>
                                          <span class="n">obs_error</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_vel</span><span class="p">:</span>
                    <span class="n">min_vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_vel</span><span class="p">:</span>
                    <span class="n">max_vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;ThrUMMS&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="n">transition</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

                <span class="c1"># Specify transition</span>
                <span class="k">if</span> <span class="s1">&#39;12&#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CO 1&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s1">&#39;13&#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;13CO 1&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">transition_indeces</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Open file</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>

                <span class="c1"># Get axes</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e3</span>

                <span class="c1"># Copy header</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>

                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">spectres</span><span class="p">(</span><span class="n">target_vel</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;12&#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="c1"># from Barnes et al. (2015)</span>
                    <span class="n">obs_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mf">1.3</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;13&#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="c1"># from Barnes et al. (2015)</span>
                    <span class="n">obs_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mf">0.7</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">obs</span>

                <span class="c1"># Grid</span>
                <span class="n">lon_mesh</span><span class="p">,</span> <span class="n">lat_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;12&#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="n">co1_gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">obs_data</span><span class="p">)</span>
                    <span class="n">co1_gridder_err</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">obs_error</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;13&#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="n">ico1_gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">obs_data</span><span class="p">)</span>
                    <span class="n">ico1_gridder_err</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">obs_error</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_vel</span><span class="p">:</span>
                    <span class="n">min_vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_vel</span><span class="p">:</span>
                    <span class="n">max_vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;THOR&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="c1"># Specify transition</span>
                <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HI&#39;</span><span class="p">]</span>
                <span class="n">transition_indeces</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Open file</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>

                <span class="c1"># Get axes</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e3</span>

                <span class="c1"># Copy header</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>


                <span class="k">if</span> <span class="s1">&#39;THOR&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">obs_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_data</span> <span class="o">*</span> <span class="mf">1.0492224297700237</span><span class="o">*</span><span class="mf">0.21106</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BMAJ&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BMAJ&#39;</span><span class="p">])</span> <span class="c1">#Jy/beam-&gt;Tb</span>
                <span class="k">elif</span> <span class="s1">&#39;.pks.&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;CGPS&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">vel</span> <span class="o">=</span> <span class="n">vel</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;CAR&#39;</span> <span class="ow">in</span> <span class="n">file</span> <span class="ow">or</span> <span class="s1">&#39;SIN&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">spectres</span><span class="p">(</span><span class="n">target_vel</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># obs_error = determine_rms(obs, mission=survey, file=file)[0].data.reshape(-1, 1)</span>
                <span class="c1"># i_nan = np.isnan(obs_error)</span>
                <span class="c1"># print(np.nanmean(obs_error), np.mean(obs_error[~i_nan]))</span>
                <span class="c1"># np.save(&#39;/home/yanitski/obs_error.npy&#39;, obs_error)</span>
                <span class="c1"># exit()</span>
                <span class="k">del</span> <span class="n">obs</span>

                <span class="c1"># Grid</span>
                <span class="n">lon_mesh</span><span class="p">,</span> <span class="n">lat_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
                <span class="n">hi_gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">obs_data</span><span class="p">)</span>
                <span class="n">hi_gridder_err</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="mf">1.6</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_vel</span><span class="p">:</span>
                    <span class="n">min_vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_vel</span><span class="p">:</span>
                    <span class="n">max_vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;SEDIGISM&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="c1"># Specify transition</span>
                <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;13CO 2&#39;</span><span class="p">]</span>
                <span class="n">transition_indeces</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Open file</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>

                <span class="c1"># Get axes</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e3</span>

                <span class="c1"># Copy header</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>


                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">spectres</span><span class="p">(</span><span class="n">target_vel</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">obs_error</span> <span class="o">=</span> <span class="n">determine_rms</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mission</span><span class="o">=</span><span class="n">survey</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">i_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_error</span><span class="p">)</span>
                <span class="c1"># print(np.nanmean(obs_error), np.mean(obs_error[~i_nan]))</span>
                <span class="c1"># np.save(&#39;/home/yanitski/obs_error.npy&#39;, obs_error)</span>
                <span class="c1"># exit()</span>
                <span class="k">del</span> <span class="n">obs</span>

                <span class="c1"># Grid</span>
                <span class="n">lon_mesh</span><span class="p">,</span> <span class="n">lat_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
                <span class="n">ico2_gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">obs_data</span><span class="p">)</span>
                <span class="n">ico2_gridder_err</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">~</span><span class="n">i_nan</span><span class="o">.</span><span class="n">flatten</span><span class="p">()],</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">~</span><span class="n">i_nan</span><span class="o">.</span><span class="n">flatten</span><span class="p">()],</span>
                                      <span class="n">obs_error</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_vel</span><span class="p">:</span>
                    <span class="n">min_vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_vel</span><span class="p">:</span>
                    <span class="n">max_vel</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="c1"># Specify observation type</span>
                <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;550um&#39;</span><span class="p">]</span>

                <span class="c1"># Open file and get data</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ORDERING&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NESTED&#39;</span><span class="p">:</span>
                    <span class="n">nest</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nest</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="s1">&#39;commander&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">obs_tkj</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;I_ML&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span>
                    <span class="n">obs_t</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;TEMP_ML&#39;</span><span class="p">]</span>
                    <span class="n">obs_beta</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;BETA_ML&#39;</span><span class="p">]</span>
                    <span class="n">obs_gamma</span> <span class="o">=</span> <span class="mf">6.646e-34</span><span class="o">/</span><span class="mf">1.38e-23</span><span class="o">/</span><span class="n">obs_t</span>
                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_tkj</span> <span class="c1">#* (nu_planck/545e9)**(obs_beta+1) * (np.exp(obs_gamma*545e9)-1)/(np.exp(obs_gamma*nu_planck)-1)</span>
                    <span class="n">obs_error</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;I_RMS&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span>
                <span class="k">elif</span> <span class="s1">&#39;GNILC&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">freq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">32.56</span> <span class="o">/</span> <span class="n">freq</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="n">obs_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">{}</span><span class="s1"> not available in survey </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">survey</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">nside</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NSIDE&#39;</span><span class="p">]</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="n">nside</span><span class="p">)</span>

                <span class="c1"># fix header</span>
                <span class="k">if</span> <span class="s1">&#39;CDELT3&#39;</span> <span class="ow">in</span> <span class="n">temp_header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>

                <span class="c1"># Gridding parameters (split large files into multiple chuncks)</span>
                <span class="n">chunck</span> <span class="o">=</span> <span class="mi">1000000</span>
                <span class="n">n_chuncks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">obs_data</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">chunck</span><span class="p">))</span>
                <span class="n">lat_mesh</span><span class="p">,</span> <span class="n">lon_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">pix2ang</span><span class="p">(</span><span class="n">nside</span><span class="o">=</span><span class="n">nside</span><span class="p">,</span> <span class="n">ipix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npix</span><span class="p">),</span> <span class="n">nest</span><span class="o">=</span><span class="n">nest</span><span class="p">))</span>
                <span class="n">lat_mesh</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">lat_mesh</span>

                <span class="c1"># Grid</span>
                <span class="n">dust_gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">temp_header</span><span class="p">)</span>
                <span class="n">dust_gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_chuncks</span><span class="p">):</span>
                    <span class="n">dust_gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="p">[</span><span class="n">_</span><span class="o">*</span><span class="n">chunck</span><span class="p">:(</span><span class="n">_</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunck</span><span class="p">],</span>
                                      <span class="n">lat_mesh</span><span class="p">[</span><span class="n">_</span><span class="o">*</span><span class="n">chunck</span><span class="p">:(</span><span class="n">_</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunck</span><span class="p">],</span>
                                      <span class="n">obs_data</span><span class="p">[</span><span class="n">_</span><span class="o">*</span><span class="n">chunck</span><span class="p">:(</span><span class="n">_</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunck</span><span class="p">])</span>
                <span class="n">dust_gridder_err</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">temp_header</span><span class="p">)</span>
                <span class="n">dust_gridder_err</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_chuncks</span><span class="p">):</span>
                    <span class="n">dust_gridder_err</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="p">[</span><span class="n">_</span><span class="o">*</span><span class="n">chunck</span><span class="p">:(</span><span class="n">_</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunck</span><span class="p">],</span>
                                          <span class="n">lat_mesh</span><span class="p">[</span><span class="n">_</span><span class="o">*</span><span class="n">chunck</span><span class="p">:(</span><span class="n">_</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunck</span><span class="p">],</span>
                                          <span class="n">obs_error</span><span class="p">[</span><span class="n">_</span><span class="o">*</span><span class="n">chunck</span><span class="p">:(</span><span class="n">_</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunck</span><span class="p">])</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;save file&#39;</span><span class="p">)</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
                <span class="n">grid_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dust_gridder</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">temp_header</span><span class="p">))</span>
                <span class="n">grid_hdu_err</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dust_gridder_err</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">twod_header</span><span class="p">))</span>
                <span class="n">grid_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/planck_&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_regridded.fits&#39;</span><span class="p">,</span>
                                 <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">grid_hdu_err</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/planck_&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                                     <span class="o">+</span> <span class="s1">&#39;_regridded_error.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">obs_data</span>
                <span class="k">del</span> <span class="n">obs_error</span>
                <span class="k">del</span> <span class="n">obs</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="c1"># Specify transitions</span>
                <span class="k">if</span> <span class="s1">&#39;HIGH&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CO 6&#39;</span><span class="p">,</span> <span class="s1">&#39;C 2&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O f1113&#39;</span><span class="p">,</span> <span class="s1">&#39;N+ 1&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O 2&#39;</span><span class="p">,</span> <span class="s1">&#39;C+ 1&#39;</span><span class="p">,</span> <span class="s1">&#39;O 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Si&#39;</span><span class="p">,</span> <span class="s1">&#39;N+ 2&#39;</span><span class="p">,</span> <span class="s1">&#39;CH 2&#39;</span><span class="p">]</span>   <span class="c1">#&#39;CO 6&#39;, &#39;O 2&#39;</span>
                    <span class="n">transition_indeces</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>   <span class="c1">#0, 6</span>
                <span class="k">elif</span> <span class="s1">&#39;HRES&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CO 1&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 2&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 3&#39;</span><span class="p">,</span> <span class="s1">&#39;O2 13&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 4&#39;</span><span class="p">,</span> <span class="s1">&#39;C 1&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O f557&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 5&#39;</span><span class="p">]</span>
                    <span class="n">transition_indeces</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s1">&#39;LOWF&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CO 1&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 2&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 3&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 4&#39;</span><span class="p">,</span> <span class="s1">&#39;C 1&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 5&#39;</span><span class="p">]</span>
                    <span class="n">transition_indeces</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>

                <span class="c1"># Open data and convert to brightness temperature</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">linfrq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                   <span class="k">if</span> <span class="s1">&#39;LINFRQ&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">])</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;LINE_FLU&#39;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.9979</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">linfrq</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                            <span class="o">/</span> <span class="mf">1.38</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span><span class="p">)</span> <span class="c1">#* np.pi**3*7**2/180**2  # corresponding beam size in sr</span>
                <span class="n">obs_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;LINE_FL2&#39;</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.9979</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">linfrq</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                             <span class="o">/</span> <span class="mf">1.38</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span><span class="p">)</span> <span class="c1">#* np.pi**3*7**2/180**2  # corresponding beam size in sr</span>

                <span class="c1"># Get axes</span>
                <span class="n">lon_mesh</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;GAL_LON&#39;</span><span class="p">]</span>
                <span class="n">lat_mesh</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;GAL_LAT&#39;</span><span class="p">]</span>

                <span class="c1"># Fix header</span>
                <span class="k">if</span> <span class="s1">&#39;CDELT3&#39;</span> <span class="ow">in</span> <span class="n">temp_header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># temp_header[&#39;NAXIS&#39;] = 2</span>
                    <span class="c1"># del temp_header[&#39;NAXIS3&#39;]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Grid</span>
                <span class="n">gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">temp_header</span><span class="p">)</span>
                <span class="n">gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
                <span class="n">gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="p">,</span> <span class="n">lat_mesh</span><span class="p">,</span> <span class="n">obs_data</span><span class="p">)</span>
                <span class="n">gridder_err</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">temp_header</span><span class="p">)</span>
                <span class="n">gridder_err</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
                <span class="n">gridder_err</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="p">,</span> <span class="n">lat_mesh</span><span class="p">,</span> <span class="n">obs_error</span><span class="p">)</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transitions</span><span class="p">)))</span>
                <span class="n">grid_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">gridder</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">temp_header</span><span class="p">))</span>
                <span class="n">grid_hdu_err</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">gridder_err</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">temp_header</span><span class="p">))</span>
                <span class="n">grid_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.FITS&#39;</span><span class="p">,</span> <span class="s1">&#39;_regridded.fits&#39;</span><span class="p">),</span>
                                 <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">grid_hdu_err</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.FITS&#39;</span><span class="p">,</span> <span class="s1">&#39;_regridded_error.fits&#39;</span><span class="p">),</span>
                                     <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;DIRBE_SKYMAP_INFO.FITS&#39;</span> <span class="ow">or</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;additional_files&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

                <span class="c1"># Specify transitions</span>
                <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;240um&#39;</span><span class="p">]</span>
                <span class="n">transition_indeces</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Open data and convert to brightness temperature</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">pixcoord</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/additional_files/DIRBE_SKYMAP_INFO.FITS&#39;</span><span class="p">)</span>
                <span class="n">linfrq</span> <span class="o">=</span> <span class="mf">2.9979e5</span> <span class="o">/</span> <span class="mi">240</span>  <span class="c1"># convert the relevant DIRBE band to GHz</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Resid&#39;</span><span class="p">]],</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.9979</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">linfrq</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                            <span class="o">/</span> <span class="mf">1.38</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">obs_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;StdDev&#39;</span><span class="p">]],</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.9979</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">linfrq</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                             <span class="o">/</span> <span class="mf">1.38</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> 

                <span class="c1"># Get axes</span>
                <span class="n">lon_mesh</span> <span class="o">=</span> <span class="n">pixcoord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;GLON-CSC&#39;</span><span class="p">]</span>
                <span class="n">lat_mesh</span> <span class="o">=</span> <span class="n">pixcoord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;GLAT-CSC&#39;</span><span class="p">]</span>

                <span class="c1"># Fix header</span>
                <span class="k">if</span> <span class="s1">&#39;CDELT3&#39;</span> <span class="ow">in</span> <span class="n">temp_header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># temp_header[&#39;NAXIS&#39;] = 2</span>
                    <span class="c1"># del temp_header[&#39;NAXIS3&#39;]</span>
                    <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>

                <span class="c1"># Grid</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">temp_header</span><span class="p">)</span>
                <span class="n">gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
                <span class="n">gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="p">,</span> <span class="n">lat_mesh</span><span class="p">,</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="n">gridder_err</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">temp_header</span><span class="p">)</span>
                <span class="n">gridder_err</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>
                <span class="n">gridder_err</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="p">,</span> <span class="n">lat_mesh</span><span class="p">,</span> <span class="n">obs_error</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>
                <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transitions</span><span class="p">)))</span>
                <span class="n">grid_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">gridder</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">temp_header</span><span class="p">))</span>
                <span class="n">grid_hdu_err</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">gridder_err</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">temp_header</span><span class="p">))</span>
                <span class="n">grid_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.FITS&#39;</span><span class="p">,</span> <span class="s1">&#39;_regridded.fits&#39;</span><span class="p">),</span>
                                 <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">grid_hdu_err</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.FITS&#39;</span><span class="p">,</span> <span class="s1">&#39;_regridded_error.fits&#39;</span><span class="p">),</span>
                                     <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># print(&#39;The specified survey {} is unavailable. Please add it to ´model selection´.&#39;.format(survey))</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">CO1</span><span class="p">:</span>
            <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CO 1&#39;</span>
            <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">grid_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">co1_gridder</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">temp_header</span><span class="p">))</span>
            <span class="n">grid_hdu_err</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">co1_gridder_err</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">twod_header</span><span class="p">))</span>
            <span class="n">grid_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;co1_test_regridded.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">grid_hdu_err</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;co1_test_regridded_error.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CO2</span><span class="p">:</span>
            <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CO 2&#39;</span>
            <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">grid_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">co2_gridder</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">temp_header</span><span class="p">))</span>
            <span class="n">grid_hdu_err</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">co2_gridder_err</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">twod_header</span><span class="p">))</span>
            <span class="n">grid_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;co2_test_regridded.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">grid_hdu_err</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;co2_test_regridded_error.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iCO1</span><span class="p">:</span>
            <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;13CO 1&#39;</span>
            <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">grid_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ico1_gridder</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">temp_header</span><span class="p">))</span>
            <span class="n">grid_hdu_err</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ico1_gridder_err</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">twod_header</span><span class="p">))</span>
            <span class="n">grid_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;13co1_test_regridded.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">grid_hdu_err</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;13co1_test_regridded_error.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iCO2</span><span class="p">:</span>
            <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;13CO 2&#39;</span>
            <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">grid_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ico2_gridder</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">temp_header</span><span class="p">))</span>
            <span class="n">grid_hdu_err</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ico2_gridder_err</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">twod_header</span><span class="p">))</span>
            <span class="n">grid_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;13co2_test_regridded.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">grid_hdu_err</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;13co2_test_regridded_error.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
            <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;HI&#39;</span>
            <span class="n">temp_header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">grid_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hi_gridder</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">temp_header</span><span class="p">))</span>
            <span class="n">grid_hdu_err</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hi_gridder_err</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">(),</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">twod_header</span><span class="p">))</span>
            <span class="n">grid_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;hi_test_regridded.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">grid_hdu_err</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;hi_test_regridded_error.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="c1"># if dust:</span>
        <span class="c1">#     temp_header[&#39;TRANSL&#39;] = &#39;Dust&#39;</span>
        <span class="c1">#     temp_header[&#39;TRANSI&#39;] = &#39;0&#39;</span>
        <span class="c1">#     grid_hdu = fits.PrimaryHDU(data=dust_gridder.get_datacube(), header=fits.Header(temp_header))</span>
        <span class="c1">#     grid_hdu_err = fits.PrimaryHDU(data=dust_gridder_err.get_datacube(), header=fits.Header(twod_header))</span>
        <span class="c1">#     grid_hdu.writeto(path + survey + &#39;/regridded/temp/planck_dust_&#39; + file + &#39;_regridded.fits&#39;,</span>
        <span class="c1">#                      overwrite=True, output_verify=&#39;ignore&#39;)</span>
        <span class="c1">#     grid_hdu_err.writeto(path + survey + &#39;/regridded/temp/&#39; + &#39;planck_dust_regridded_error.fits&#39;,</span>
        <span class="c1">#                          overwrite=True, output_verify=&#39;ignore&#39;)</span>

        <span class="n">CO1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">CO2</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">iCO1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">iCO2</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">dust</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cobe</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Regrid successfully completed.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="combine_regridded">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.combine_regridded.html#kosmatau3d.comparison.model_selection.combine_regridded">[docs]</a>
<span class="k">def</span> <span class="nf">combine_regridded</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">regridded_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">target_kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_vel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Combine separate regridded files. Useful for large datasets.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># if path==None or regridded_path==None or output_file==None\</span>
    <span class="c1">#         or isinstance(target_header, dict) or isinstance(target_vel, np.ndarray):</span>
    <span class="c1">#     print(&#39;use appropriate kwargs to combine regridded data&#39;)</span>
    <span class="c1">#     return</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">regridded_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;/COBE/&#39;</span> <span class="ow">in</span> <span class="n">path</span> <span class="ow">or</span> <span class="s1">&#39;/COBE-FIRAS/&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">],</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]))</span>

    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                      <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                      <span class="n">num</span><span class="o">=</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                      <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                      <span class="n">num</span><span class="o">=</span><span class="n">target_header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
    <span class="n">lon_mesh</span><span class="p">,</span> <span class="n">lat_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>

    <span class="n">gridder</span> <span class="o">=</span> <span class="n">cygrid</span><span class="o">.</span><span class="n">WcsGrid</span><span class="p">(</span><span class="n">target_header</span><span class="p">)</span>
    <span class="n">gridder</span><span class="o">.</span><span class="n">set_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">target_kernel</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="n">output_file</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="s1">&#39;/COBE/&#39;</span> <span class="ow">in</span> <span class="n">path</span> <span class="ow">or</span> <span class="s1">&#39;/COBE-FIRAS/&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">regridded_path</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">output_data</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">regridded_path</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
            <span class="c1"># obs_data = np.reshape(obs[0].data, ())</span>
            <span class="n">gridder</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lon_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lat_mesh</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
            <span class="c1"># i = output_data == 0</span>
            <span class="c1"># vel = np.linspace(obs[0].header[&#39;CRVAL3&#39;] - obs[0].header[&#39;CDELT3&#39;] * (obs[0].header[&#39;CRPIX3&#39;] - 1),</span>
            <span class="c1">#                   obs[0].header[&#39;CRVAL3&#39;] + obs[0].header[&#39;CDELT3&#39;] * (</span>
            <span class="c1">#                               obs[0].header[&#39;NAXIS3&#39;] - obs[0].header[&#39;CRPIX3&#39;]),</span>
            <span class="c1">#                   num=obs[0].header[&#39;NAXIS3&#39;])</span>
            <span class="c1"># interp = interp1d(vel, np.nan_to_num(obs[0].data), axis=0, fill_value=0, bounds_error=False)</span>
            <span class="c1"># # output_data[i] = output_data[i] + interp(target_vel)[i]</span>
            <span class="c1"># output_data[i] = output_data[i] + np.nan_to_num(obs[0].data[i])</span>

    <span class="n">output_data</span> <span class="o">=</span> <span class="n">gridder</span><span class="o">.</span><span class="n">get_datacube</span><span class="p">()</span>

    <span class="c1"># output = fits.PrimaryHDU(data=output_data, header=fits.Header(obs[0].header))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">output_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">))</span>
    <span class="n">output</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved as &#39;</span> <span class="o">+</span> <span class="n">output_file</span><span class="p">)</span>

    <span class="k">return</span></div>



<div class="viewcode-block" id="view_observation">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.view_observation.html#kosmatau3d.comparison.model_selection.view_observation">[docs]</a>
<span class="k">def</span> <span class="nf">view_observation</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;/mnt/hpc_backup/yanitski/projects/pdr/observational_data/MilkyWay/&#39;</span><span class="p">,</span>
                     <span class="n">mission</span><span class="o">=</span><span class="s1">&#39;COGAL&#39;</span><span class="p">,</span> <span class="n">transition</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">regridded_path</span><span class="o">=</span><span class="s1">&#39;/regridded/&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;CO1_obs_regridded.fits&#39;</span><span class="p">,</span>
                     <span class="n">plot</span><span class="o">=</span><span class="s1">&#39;integrated&#39;</span><span class="p">,</span> <span class="n">integrate_b</span><span class="o">=</span><span class="p">[],</span> <span class="n">i_lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_observations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">clabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">logval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                     <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function will plot the specified (regridded) observation. By default it prints the integrated emission.</span>

<span class="sd">    :param path: Directory containing the observational data.</span>
<span class="sd">    :param mission: Name of the survey you wish to view.</span>
<span class="sd">    :param regridded_path: folder name for the regridded data. This should usually be &#39;/regridded/&#39;, but some surveys</span>
<span class="sd">           might require &#39;/regridded/temp/&#39;</span>
<span class="sd">    :param filename: Directory containing the observational data.</span>
<span class="sd">    :param plot: The type of plot to create with this function.</span>
<span class="sd">           - &#39;integrated&#39;</span>
<span class="sd">           - &#39;pv&#39;</span>
<span class="sd">           By default it &#39;integrated&#39;.</span>
<span class="sd">    :param title: The title of the produced plot.</span>
<span class="sd">    :param list_observations: Set this flag to True to print the available observation files.</span>
<span class="sd">    :return:</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">list_observations</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">mission</span> <span class="o">+</span> <span class="n">regridded_path</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">mission</span> <span class="o">+</span> <span class="n">regridded_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">file</span> <span class="o">!=</span> <span class="s1">&#39;temp&#39;</span><span class="p">]))</span>
        <span class="k">return</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">mission</span> <span class="o">+</span> <span class="n">regridded_path</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">cygrid_data</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">cygrid_data</span><span class="p">[</span><span class="n">cygrid_data</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                      <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                      <span class="n">num</span><span class="o">=</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                      <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                      <span class="n">num</span><span class="o">=</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>

    <span class="n">pprint</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="n">twod_header</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mission</span> <span class="o">!=</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mission</span> <span class="o">!=</span> <span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mission</span> <span class="o">!=</span> <span class="s1">&#39;Planck&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;spectroscopic data&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transition</span> <span class="o">!=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Line transition not in specified file. Please supply the correct line/file.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]))</span>
            <span class="k">return</span>
        <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                          <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                          <span class="n">num</span><span class="o">=</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span>
        <span class="n">cygrid_integrated_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cygrid_integrated_data</span><span class="p">[</span><span class="n">cygrid_integrated_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">cygrid_data</span><span class="p">[</span><span class="n">cygrid_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">elif</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transition</span> <span class="o">!=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Line transition not in specified file. Please supply the correct line/file.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]))</span>
            <span class="k">return</span>
        <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
        <span class="n">cygrid_integrated_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">)</span>
        <span class="n">cygrid_integrated_data</span><span class="p">[</span><span class="n">cygrid_integrated_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">twod_header</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;COBE or Planck&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
            <span class="c1"># del twod_header[&#39;OBSERR&#39;]</span>
            <span class="k">del</span> <span class="n">twod_header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span>
            <span class="c1"># del twod_header[&#39;TRANSI&#39;]</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">))</span>
        <span class="c1"># i_transitions = np.asarray(header[&#39;TRANSI&#39;].split(&#39;, &#39;))</span>
        <span class="n">i_line</span> <span class="o">=</span> <span class="n">transitions</span> <span class="o">==</span> <span class="n">transition</span>
        <span class="c1"># print(&#39;\n&#39;, transitions, &#39;\n&#39;, transition, i_line, int(lat.size/2), &#39;\n&#39;)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">i_line</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Line transition </span><span class="si">{}</span><span class="s1"> not in specified file. Please supply the correct line/file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transition</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">:</span>
            <span class="n">cygrid_integrated_data</span> <span class="o">=</span> <span class="n">cygrid_data</span><span class="p">[</span><span class="n">i_line</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cygrid_integrated_data</span> <span class="o">=</span> <span class="n">cygrid_data</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">twod_header</span><span class="p">)</span>

    <span class="n">twod_wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">twod_header</span><span class="p">)</span>

    <span class="c1"># for i_vel in [0, 720, 1440]:</span>
    <span class="c1">#     fig = plt.figure(figsize=(20, 20))</span>
    <span class="c1">#     ax = fig.add_subplot(111, projection=twod_wcs, frame_class=EllipticalFrame, slices=(&#39;x&#39;, &#39;y&#39;, 250))</span>
    <span class="c1">#     #     ax = fig.add_subplot(111)</span>
    <span class="c1">#     ax.imshow(cygrid_data[i_vel, :, :], vmin=0, vmax=10)</span>
    <span class="c1">#     plt.show()</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">cygrid_integrated_data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">cygrid_integrated_data</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">cygrid_integrated_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">twod_wcs</span><span class="p">,</span> <span class="n">frame_class</span><span class="o">=</span><span class="n">EllipticalFrame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logval</span><span class="p">:</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cygrid_integrated_data</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cygrid_integrated_data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="c1"># ax.set_aspect(np.abs(twod_wcs.wcs.cdelt[1] / twod_wcs.wcs.cdelt[0]))</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clabel</span><span class="p">:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">clabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Integrated Intensity ($K \frac</span><span class="si">{km}{s}</span><span class="s1">$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span> <span class="ow">or</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;PV&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of finite-valued sightlines:&#39;</span><span class="p">,</span> <span class="n">cygrid_data</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i_lat</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">i_lat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">cygrid_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">integrate_b</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;integrate latitude&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[(</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))),</span>
                      <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">max&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[(</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))),</span>
                      <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">NaN?&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[(</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))))</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">cygrid_data</span><span class="p">[(</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[:,</span> <span class="p">(</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))),</span>
                      <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">max&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[:,</span> <span class="p">(</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))),</span>
                      <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">NaN?&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[:,</span> <span class="p">(</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))))</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[:,</span> <span class="p">(</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">integrate_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
                               <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;at latitude&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="p">[</span><span class="n">i_lat</span><span class="p">],</span> <span class="s1">&#39;deg&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">:]),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">:]),</span>
                      <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">:]))</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cygrid_data</span><span class="p">[</span><span class="n">i_lat</span><span class="p">,</span> <span class="p">:],</span>
                               <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">:]),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">:]),</span>
                      <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cygrid_data</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">:]))</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">cygrid_data</span><span class="p">[:,</span> <span class="n">i_lat</span><span class="p">,</span> <span class="p">:],</span>
                               <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xlabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\lambda \ \left( ^\circ \right)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$V_</span><span class="si">{LSR}</span><span class="s1"> \ \left( \frac</span><span class="si">{km}{s}</span><span class="s1"> \right)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clabel</span><span class="p">:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">clabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Intensity ($K$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;spectrum&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i_lat</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">i_lat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">cygrid_integrated_data</span><span class="p">[</span><span class="n">i_lat</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> degrees&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="n">i_lat</span><span class="p">]),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xlabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\lambda \ \left( ^\circ \right)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$T_</span><span class="si">{int}</span><span class="s1"> \ \left( K \frac</span><span class="si">{km}{s}</span><span class="s1"> \right)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please select a valid plotting method.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">mission</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">transition</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">plot</span> <span class="o">+</span> <span class="s1">&#39; plot&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">mission</span> <span class="o">+</span> <span class="n">regridded_path</span> <span class="o">+</span> <span class="n">transition</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.fits&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">plot</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span></div>



<div class="viewcode-block" id="error_correction">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.error_correction.html#kosmatau3d.comparison.model_selection.error_correction">[docs]</a>
<span class="k">def</span> <span class="nf">error_correction</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate configuration error</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">data_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">conf</span> <span class="o">==</span> <span class="s1">&#39;axisymmetric&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">])</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_copy</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data_copy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">avg</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">correction</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))):</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_copy</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_copy</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data_copy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">avg</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">correction</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">],</span> <span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_copy</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="k">continue</span>
                        <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_copy</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data_copy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">avg</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">correction</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">correction</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">correction</span></div>




<div class="viewcode-block" id="model_selection_old">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.model_selection_old.html#kosmatau3d.comparison.model_selection.model_selection_old">[docs]</a>
<span class="k">def</span> <span class="nf">model_selection_old</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;/mnt/hpc_backup/yanitski/projects/pdr/KT3_history/MilkyWay&#39;</span><span class="p">,</span> <span class="n">missions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">model_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">model_param</span><span class="o">=</span><span class="p">[[]],</span> <span class="n">comp_type</span><span class="o">=</span><span class="s1">&#39;pv&#39;</span><span class="p">,</span> <span class="n">log_comp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gist_ncar&#39;</span><span class="p">,</span>
                    <span class="n">PLOT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PRINT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function will compare the Milky Way models to the position-velocity observations depending on the</span>
<span class="sd">      dataset. It will utilise the sightlines of the dataset.</span>

<span class="sd">      :param path: directory containing the model folders.</span>
<span class="sd">      :param model_dir: directory format for each model in the grid.</span>
<span class="sd">      :param model_param: a list of lists containing the parameter space of the models.</span>
<span class="sd">      :param resolution: the voxel size (in pc) of the models used in the comparison; used in model folder name.</span>
<span class="sd">      :param missions: as this is setup for the Milky Way, the mission selection is</span>
<span class="sd">             - COBE-FIRAS</span>
<span class="sd">             - COBE-DIRBE</span>
<span class="sd">             - COGAL</span>
<span class="sd">             - Mopra</span>
<span class="sd">             - ThrUMMS</span>
<span class="sd">             - SEDIGISM</span>
<span class="sd">             - Planck</span>
<span class="sd">             - THOR (partial)</span>
<span class="sd">             - Hi-GAL (abandoned)</span>
<span class="sd">      :param cmap: color map for the plots.</span>
<span class="sd">      :param PLOT: flag to save plots.</span>
<span class="sd">      :param PRINT: flag to enable verbose output.</span>
<span class="sd">      :param debug: flag to run in debug mode.</span>

<span class="sd">      currently, this will look solely at the galactic plane.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Check that the missions are specified properly.</span>
    <span class="k">if</span> <span class="n">missions</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">missions</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">missions</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">missions</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;KT3_history&#39;</span><span class="p">,</span> <span class="s1">&#39;observational_data&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">missions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">missions</span> <span class="o">=</span> <span class="p">[</span><span class="n">missions</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">missions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Use both COBE instruments if simply &#39;COBE&#39; is specified</span>
        <span class="k">if</span> <span class="s1">&#39;COBE&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span> <span class="n">missions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span> <span class="n">missions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span>
            <span class="n">missions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">)</span>
            <span class="n">missions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please specify a list of missions to compare the models.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">model_dir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">model_param</span> <span class="o">==</span> <span class="p">[[]]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please specify both model_dir and model_param.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">model_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">model_param</span><span class="p">)</span>
    <span class="c1"># model_params = zip(np.transpose([model_params[n].flatten() for n in range(len(model_param))]))</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">model_params</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_param</span><span class="p">))])</span>

    <span class="k">if</span> <span class="n">log_comp</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">comp_type</span> <span class="o">+</span> <span class="s1">&#39;_logT&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">comp_type</span>

    <span class="n">obs_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vel</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">survey</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">  </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">survey</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;HiGAL&#39;</span><span class="p">,</span> <span class="s1">&#39;GRS&#39;</span><span class="p">,</span> <span class="s1">&#39;THOR&#39;</span><span class="p">,</span> <span class="s1">&#39;CGPS&#39;</span><span class="p">,</span> <span class="s1">&#39;SGPS&#39;</span><span class="p">,</span> <span class="s1">&#39;VGPS&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;KT3_history&#39;</span><span class="p">,</span> <span class="s1">&#39;observational_data&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span>
        <span class="c1"># if mission == &#39;COBE-FIRAS&#39;:</span>
        <span class="c1">#     directory += &#39;temp/&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no data is available.&#39;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>

        <span class="c1"># Loop through the different models</span>
        <span class="c1"># for i_obs in range(len(obs_data)):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">file</span> <span class="ow">or</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">obs_error</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_error.fits&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">elif</span> <span class="s1">&#39;.sav&#39;</span> <span class="ow">in</span> <span class="n">file</span> <span class="ow">or</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;craig.idl&#39;</span><span class="p">:</span>

                    <span class="c1"># This file requires a comparison to the galactic plane</span>
                    <span class="c1"># lat = 0</span>

                    <span class="c1"># these values are hard-coded since the data is not in the file</span>
                    <span class="n">linfrq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">115.3</span><span class="p">,</span> <span class="mf">230.5</span><span class="p">,</span> <span class="mf">345.8</span><span class="p">,</span> <span class="mf">424.8</span><span class="p">,</span> <span class="mf">461.0</span><span class="p">,</span> <span class="mf">492.2</span><span class="p">,</span> <span class="mf">556.9</span><span class="p">,</span> <span class="mf">576.3</span><span class="p">,</span> <span class="mf">691.5</span><span class="p">,</span> <span class="mf">808.1</span><span class="p">,</span>
                                       <span class="mi">1113</span><span class="p">,</span> <span class="mi">1460</span><span class="p">,</span> <span class="mi">2226</span><span class="p">,</span> <span class="mi">1901</span><span class="p">,</span> <span class="mi">2060</span><span class="p">,</span> <span class="mi">2311</span><span class="p">,</span> <span class="mi">2459</span><span class="p">,</span> <span class="mi">2589</span><span class="p">,</span> <span class="mf">921.8</span><span class="p">])</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;CO 1&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 2&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 3&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 4&#39;</span><span class="p">,</span> <span class="s1">&#39;C 3&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 5&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;CO 6&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 7 + C 1&#39;</span><span class="p">,</span> <span class="s1">&#39;C+ 1&#39;</span><span class="p">,</span> <span class="s1">&#39;O 1&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 8&#39;</span><span class="p">])</span>
                    <span class="n">transition_indeces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">18</span><span class="p">])</span>

                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.9979</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">linfrq</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">1.38</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span>
                    <span class="n">obs_error</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.9979</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">linfrq</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">1.38</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span>
                    <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span>
                    <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">i_lat_obs_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">pprint</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                    <span class="c1"># obs_error = obs[0].header[&#39;OBSERR&#39;].split()</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                    <span class="n">transition_indeces</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                    <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                          <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                          <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
                    <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                          <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                          <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                    <span class="n">i_lat_obs_init</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">:</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">pprint</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="c1"># obs_error = obs[0].header[&#39;OBSERR&#39;].split()</span>
                <span class="n">transitions</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                <span class="n">transition_indeces</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                      <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
                <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                      <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                <span class="n">i_lat_obs_init</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">pprint</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="c1"># obs_error = obs[0].header[&#39;OBSERR&#39;]</span>
                <span class="n">transitions</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                <span class="n">transition_indeces</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                      <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
                <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                      <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                <span class="n">vel_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                      <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span>
                <span class="n">i_lat_obs_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_data</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  fitting&#39;</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>

                <span class="n">chi2_grid</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">loglikelihood_grid</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                        <span class="n">obs_error_conf</span> <span class="o">=</span> <span class="n">error_correction</span><span class="p">(</span><span class="n">obs_data</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">])],</span>
                                                          <span class="n">conf</span><span class="o">=</span><span class="s1">&#39;axisymmetric&#39;</span><span class="p">)</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="n">obs_data</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                        <span class="n">vmax</span> <span class="o">=</span> <span class="n">obs_data</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">obs_error_conf</span> <span class="o">=</span> <span class="n">error_correction</span><span class="p">(</span><span class="n">obs_data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="p">:,</span> <span class="p">:],</span>
                                                          <span class="n">conf</span><span class="o">=</span><span class="s1">&#39;axisymmetric&#39;</span><span class="p">)</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="n">obs_data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                        <span class="n">vmax</span> <span class="o">=</span> <span class="n">obs_data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="c1"># print(transition)</span>
                    <span class="c1"># print(vmin, vmax)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">obs_error_conf</span> <span class="o">=</span> <span class="n">error_correction</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="s1">&#39;axisymmetric&#39;</span><span class="p">)</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">obs_data</span><span class="p">)</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">obs_data</span><span class="p">)</span>

                <span class="c1"># print(&#39;Average error in observation: {}&#39;.format(np.nanmean(obs_error)))</span>
                <span class="c1"># print(&#39;Correction due to axisymmetry: {}&#39;.format(np.nanmean(obs_error_conf)))</span>

                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model_params</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;    </span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

                    <span class="c1"># Check existance of model</span>
                    <span class="n">dir_model</span> <span class="o">=</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;synthetic_intensity.fits&#39;</span>
                        <span class="c1"># &#39;/r{}_cm{}-{}_d{}_uv{}/channel_intensity.fits&#39;.format(resolution, fcl,</span>
                        <span class="c1">#                                                               ficl, fden, fuv)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">dir_model</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  missing&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Open the model</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">dir_model</span><span class="p">)</span>
                    <span class="c1"># pprint(model[1].header)</span>

                    <span class="c1"># Locate the species transition (only one dust value is considered; constant background)</span>
                    <span class="k">if</span> <span class="n">survey</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Planck&#39;</span><span class="p">,</span> <span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">):</span>
                        <span class="n">i_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SPECIES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">))</span> <span class="o">==</span> <span class="n">transition</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i_spec</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{}</span><span class="s1"> not in model.            &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transition</span><span class="p">))</span>
                        <span class="k">break</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     i_spec = i_spec[0]</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span>
                                     <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">transition</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">transition</span><span class="p">))</span>

                    <span class="c1"># Create arrays for the longitude and velocity axes</span>
                    <span class="n">lat_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                    <span class="n">lon_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                    <span class="c1"># if not (mission == &#39;COGAL&#39;):</span>
                    <span class="c1">#     lon_model[lon_model&lt;0] += 360</span>
                    <span class="n">vel_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS4&#39;</span><span class="p">])</span>
                    <span class="c1"># breakpoint()</span>

                    <span class="c1"># Identify the common latitudes between the observations and the model</span>
                    <span class="k">if</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span> <span class="ow">and</span>
                        <span class="ow">not</span> <span class="p">(</span><span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">)):</span>
                        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">lat</span>
                        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lat</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">lat_obs</span><span class="p">[</span><span class="n">i_lat_obs_init</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lat_obs</span><span class="p">[</span><span class="n">i_lat_obs_init</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">:</span>
                        <span class="n">i_lon_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon_model</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">lon_obs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                        <span class="n">i_lat_model</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_model</span> <span class="o">&gt;=</span> <span class="n">lat_min</span><span class="p">)</span> \
                                      <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_model</span> <span class="o">&lt;=</span> <span class="n">lat_max</span><span class="p">)</span>
                        <span class="n">i_lat_obs</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_obs</span> <span class="o">&gt;=</span> <span class="n">lat_model</span><span class="p">[</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> \
                                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_obs</span> <span class="o">&lt;=</span> <span class="n">lat_model</span><span class="p">[</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i_lat_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_model</span> <span class="o">&gt;=</span> <span class="n">lat_min</span><span class="p">)</span>
                                               <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_model</span> <span class="o">&lt;=</span> <span class="n">lat_max</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">i_lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_obs</span> <span class="o">&gt;=</span> <span class="n">lat_model</span><span class="p">[</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                             <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_obs</span> <span class="o">&lt;=</span> <span class="n">lat_model</span><span class="p">[</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Interpolate at the observational axes</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">):</span>
                        <span class="n">idx_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">,</span> <span class="n">i_spec</span><span class="p">)</span>
                        <span class="c1"># idx_d = np.ix_(np.arange(vel_model.size), i_lat_model, i_lon_model, [0])</span>
                        <span class="n">idx_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="c1"># print(i_lat_model.size, i_lon_model.size)</span>
                        <span class="c1"># print(vel_model.shape,</span>
                        <span class="c1">#       model[1].data[idx_t].shape,</span>
                        <span class="c1">#       model[2].data[idx_d].shape,</span>
                        <span class="c1">#       i_lat_obs.size)</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx_t</span><span class="p">]</span> \
                                     <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx_d</span><span class="p">]</span>
                        <span class="n">model_interp</span> <span class="o">=</span> <span class="n">trapz</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span> <span class="n">vel_model</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">model_data</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                        <span class="k">if</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                            <span class="n">idx_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span>
                            <span class="n">obs_data_final</span> <span class="o">=</span> <span class="n">obs_data</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="c1">#[:, int(transition_indeces[i])]</span>
                            <span class="c1"># print(obs_data_final.shape)</span>
                            <span class="c1"># print(obs_error[:, int(transition_indeces[i])].shape, obs_error_conf.shape)</span>
                            <span class="c1"># print(obs_error[idx_obs].shape, obs_error_conf.shape)</span>
                            <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_error</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">**</span><span class="mi">2</span>
                                                      <span class="o">+</span><span class="n">obs_error_conf</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="c1">#[:, int(transition_indeces[i])]</span>
                            <span class="c1"># print(obs_error_final.shape)</span>
                            <span class="n">model_interp</span> <span class="o">=</span> <span class="n">model_interp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">idx_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">])],</span> <span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                            <span class="n">obs_data_final</span> <span class="o">=</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">idx_obs</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="c1">#[int(transition_indeces[i]), i_lat_obs, :]</span>
                            <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_error</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">obs_error_conf</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="n">idx_obs</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="c1">#[int(transition_indeces[i]), i_lat_obs, :]</span>
                            <span class="n">model_interp</span> <span class="o">=</span> <span class="n">model_interp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># print(model_interp.shape, obs_data_final.shape)</span>

                    <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">:</span>
                        <span class="c1"># idx_d = np.ix_([0], i_lat_model, np.arange(lon_model.size), [0])</span>
                        <span class="n">idx_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_model</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="c1"># model_interp = model[2].data[idx_d][0, :, :, 0]#[0, i_lat_model, :, i_spec]</span>
                        <span class="n">model_interp</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx_d</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="c1">#[0, i_lat_model, :, i_spec]</span>
                        <span class="n">idx_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">obs_data_final</span> <span class="o">=</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">idx_obs</span><span class="p">]</span><span class="c1">#[i_lat_obs, :]</span>
                        <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_error</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">obs_error_conf</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="n">idx_obs</span><span class="p">]</span><span class="c1">#[i_lat_obs, :]</span>
                        <span class="c1"># print(model_interp.shape, obs_data_final.shape)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># print(vel_model.shape,</span>
                        <span class="c1">#       model[1].data[:, i_lat_model, :, i_spec].shape,</span>
                        <span class="c1">#       model[2].data[:, i_lat_model, :, 0].shape,</span>
                        <span class="c1">#       obs_data[:, i_lat_obs, :].shape,</span>
                        <span class="c1">#       np.swapaxes(obs_data[:, i_lat_obs, :], 0, 1).shape)</span>
                        <span class="c1"># input()</span>
                        <span class="n">idx_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">i_lat_model</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_model</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">i_spec</span><span class="p">)</span>
                        <span class="c1"># idx_d = np.ix_(np.arange(vel_model.size), i_lat_model, np.arange(lon_model.size), [0])</span>
                        <span class="n">idx_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_model</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx_t</span><span class="p">]</span>
                                      <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx_d</span><span class="p">])</span>
                        <span class="n">idx_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vel_obs</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_obs</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                        <span class="n">idx_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_obs</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                        <span class="n">obs_data_temp</span> <span class="o">=</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">idx_obs</span><span class="p">]</span><span class="c1">#np.swapaxes(obs_data[idx_obs], 0, 1)</span>
                        <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                            <span class="c1"># This will give an incorrect result if either the latitude or longitude axes are the same</span>
                            <span class="c1"># size as the velocity axis</span>
                            <span class="n">model_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span> <span class="n">vel_model</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">model_data</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                            <span class="n">obs_data_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">obs_data_temp</span><span class="p">,</span> <span class="n">vel_obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">obs_data_temp</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vel_obs</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                            <span class="n">obs_error_final</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vel_obs</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_error</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">obs_error_conf</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="n">idx_obs</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span>
                            <span class="n">model_interp</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="c1">#np.swapaxes(model_data, 0, 1)</span>
                            <span class="n">obs_data_final</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">obs_data_temp</span><span class="p">)</span>
                            <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_error</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">obs_error_conf</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="n">idx_obs</span><span class="p">]</span>
                            <span class="c1"># obs_error_final = np.swapaxes([obs_error[i_lat_obs, :]]*obs_data_temp.shape[1], 0, 1)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR &gt;&gt; Comparison type </span><span class="si">{}</span><span class="s1"> not valid; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_type</span><span class="p">)</span> <span class="o">+</span>
                                  <span class="s1">&#39;please choose &quot;pv&quot; or &quot;integrated&quot;&#39;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="mi">1</span>

                        <span class="n">model_interp</span><span class="p">[</span><span class="n">model_interp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="c1"># print(vel)</span>
                            <span class="c1"># print(lon)</span>
                            <span class="c1"># print(vel_model)</span>
                            <span class="c1"># print(lon_model)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmin</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">obs_data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">vel</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">model_interp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                            <span class="c1"># lon_model_grid, vel_model_grid = np.meshgrid(lon_model, vel_model)</span>
                            <span class="c1"># plt.pcolormesh(lon_model_grid, vel_model_grid, model_data,</span>
                            <span class="c1">#                norm=colors.SymLogNorm(base=10, linthresh=0.1, vmin=0, vmax=vmax),</span>
                            <span class="c1">#                shading=&#39;auto&#39;, cmap=cmap)</span>
                            <span class="c1"># plt.show(block=True)</span>
                            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">model_interp</span><span class="p">,</span>
                                                <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span>
                                                <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">obs_data</span><span class="p">,</span>
                                                <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span>
                                                <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="c1"># i_obs = np.isnan(model_interp)</span>
                            <span class="c1"># obs_data[i_obs] = np.nan</span>
                            <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">x_stddev</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">obs_data_smoothed</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
                            <span class="n">vmin</span> <span class="o">=</span> <span class="n">obs_data_smoothed</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                            <span class="n">vmax</span> <span class="o">=</span> <span class="n">obs_data_smoothed</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">obs_data_smoothed</span><span class="p">,</span>
                                                <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span>
                                                <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">obs_data_smoothed</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="o">*</span><span class="n">vmax</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">vmax</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">log_comp</span><span class="p">:</span>
                        <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">obs_error_final</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">obs_data_final</span>
                        <span class="n">obs_data_final</span><span class="p">[</span><span class="n">obs_data_final</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-100</span>
                        <span class="n">obs_data_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">obs_data_final</span><span class="p">)</span>
                        <span class="n">model_interp</span><span class="p">[</span><span class="n">model_interp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-100</span>
                        <span class="n">model_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">model_interp</span><span class="p">)</span>

                    <span class="c1"># Calculate the chi**2 and overall likelihood</span>
                    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model_interp</span><span class="p">)</span>
                    <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model_interp</span><span class="p">)</span>
                    <span class="c1"># if ((survey == &#39;COBE&#39;) or (survey == &#39;COBE-FIRAS&#39;)):</span>
                    <span class="k">if</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                        <span class="n">i_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs_data_final</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs_data_final</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="c1"># print(model_interp.shape,</span>
                        <span class="c1">#       obs_data_final.shape,</span>
                        <span class="c1">#       obs_error_final.shape,</span>
                        <span class="c1">#       model_interp[i_signal].shape,</span>
                        <span class="c1">#       obs_data_final[i_signal].shape,</span>
                        <span class="c1">#       obs_error_final[i_signal].shape</span>
                        <span class="c1">#       )</span>
                    <span class="c1"># print(obs_data_final[i_signal].size - len(param))</span>
                    <span class="c1"># print((obs_data_final[i_signal] - model_interp[i_signal]).any())</span>
                    <span class="c1"># print(((obs_data_final[i_signal] - model_interp[i_signal])** 2 / \</span>
                    <span class="c1">#                  obs_error_final[i_signal] ** 2).max())</span>
                    <span class="c1"># print(&#39;chi2, i_signal, obs_data_final, model_interp, obs_error_final\n&#39;,</span>
                    <span class="c1">#       chi2.shape, np.shape(i_signal), obs_data_final.shape,</span>
                    <span class="c1">#       model_interp.shape, obs_error_final.shape)</span>
                    <span class="n">chi2</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_data_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">-</span> <span class="n">model_interp</span><span class="p">[</span><span class="n">i_signal</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> \
                                     <span class="n">obs_error_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="n">loglikelihood</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">chi2</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> \
                                              <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">obs_error_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># elif survey == &#39;Planck&#39;:</span>
                    <span class="c1">#     i_signal = np.where(obs_data_final &gt; obs_error_final)</span>
                    <span class="c1">#     chi2[i_signal] = (obs_data_final[i_signal] - model_interp[i_signal]) ** 2 / \</span>
                    <span class="c1">#                      obs_error_final[i_signal] ** 2</span>
                    <span class="c1">#     loglikelihood[i_signal] = -chi2[i_signal] / 2 \</span>
                    <span class="c1">#                               - 0.5 * np.log10(np.sqrt(2 * np.pi) * obs_error_final[i_signal])</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     # i_signal = np.where(obs_data_temp &gt;= obs_data_temp.min())</span>
                    <span class="c1">#     i_signal = np.where(obs_data_final &gt; obs_error_final)</span>
                    <span class="c1">#     chi2[i_signal] = (obs_data_final[i_signal] - model_interp[i_signal]) ** 2 \</span>
                    <span class="c1">#                      / obs_error_final[i_signal] ** 2</span>
                    <span class="c1">#     loglikelihood[i_signal] = -chi2[i_signal] / 2 \</span>
                    <span class="c1">#                               - 0.5 * np.log10(np.sqrt(2 * np.pi) * obs_error_final[i_signal])</span>

                    <span class="c1"># print(model_interp)</span>
                    <span class="c1"># print(obs_data[~np.isnan(obs_data)])</span>
                    <span class="c1"># print(chi2)</span>
                    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">loglikelihood</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># likelihood[likelihood == 0] = 1e10</span>
                    <span class="c1"># input()</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_chi2.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                                                             <span class="n">transition</span><span class="p">,</span> <span class="n">dir_model</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                                                             <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;channel_intensity.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                                                             <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">),</span>
                            <span class="n">chi2</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_loglikelihood.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                                                                      <span class="n">transition</span><span class="p">,</span>
                                                                                      <span class="n">dir_model</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                                                                      <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;channel_intensity.fits&#39;</span><span class="p">,</span>
                                                                                               <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">),</span>
                            <span class="n">loglikelihood</span><span class="p">)</span>

                    <span class="n">chi2_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi2</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="n">loglikelihood_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loglikelihood</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="c1">#                             print(&#39;  &#39;, likelihood.min())</span>

                    <span class="c1"># print(obs_data.min(), obs_data.max())</span>

                    <span class="k">if</span> <span class="n">PLOT</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">):</span>
                            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
                            <span class="n">fig2</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
                            <span class="n">cm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_model</span><span class="p">,</span> <span class="n">lat_model</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_interp</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                                            <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                                   <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">))</span>
                            <span class="n">cm2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_obs</span><span class="p">,</span> <span class="n">lat_obs</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">obs_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">])],</span>
                                              <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                                     <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
                            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
                            <span class="n">cb2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cm2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Longitude ($^\circ$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Latitude ($^\circ$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Longitude ($^\circ$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Latitude ($^\circ$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># vel_grid, lon_grid = np.meshgrid(vel, lon)</span>
                            <span class="c1"># model_interp = f_model_interp(vel_grid, lon_grid)</span>
                            <span class="c1"># print(0.1*vmax)</span>
                            <span class="n">i_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_data</span><span class="p">)</span>
                            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
                            <span class="n">fig2</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
                            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span><span class="c1">#mission == &#39;COGAL&#39;:</span>
                                <span class="n">cm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon_model</span><span class="p">,</span> <span class="n">vel_model</span><span class="p">,</span> <span class="n">model_interp</span><span class="p">,</span>
                                                   <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                                          <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span>
                                                   <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
                                <span class="n">cm2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon_obs</span><span class="p">,</span> <span class="n">vel_obs</span><span class="p">,</span> <span class="n">obs_data_temp</span><span class="p">,</span>
                                                     <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                                            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span>
                                                     <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
                                <span class="c1"># extents = [lon.max(), lon.min(), vel.min(), vel.max()]</span>
                                <span class="c1"># cm = plt.imshow(model_interp, cmap=cmap, extent=extents, aspect=&#39;auto&#39;, origin=&#39;upper&#39;,</span>
                                <span class="c1">#      norm=colors.SymLogNorm(base=10, linthresh=0.1, vmin=0, vmax=vmax))</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">lon_obs</span><span class="p">,</span> <span class="n">vel_obs</span><span class="p">,</span> <span class="n">obs_data_temp</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="o">*</span><span class="n">vmax</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;xkcd:magenta&#39;</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.25</span><span class="o">*</span><span class="n">vmax</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:magenta&#39;</span><span class="p">,</span>
                                        <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">cm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">model_interp</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                                   <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">SymLogNorm</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linthresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                                          <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span>
                                                   <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;gouraud&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">obs_data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="o">*</span><span class="n">vmax</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
                            <span class="n">cb2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cm2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Longitude ($^\circ$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Radial Velocity ($\frac</span><span class="si">{km}{s}</span><span class="s1">$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Longitude ($^\circ$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Radial Velocity ($\frac</span><span class="si">{km}{s}</span><span class="s1">$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                            <span class="c1"># ax.invert_xaxis()</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                            <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/synthetic_observation_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">survey</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">transition</span><span class="p">,</span> <span class="n">dir_model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">fig2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                            <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/synthetic_observation_smoothed.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">survey</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">transition</span><span class="p">))</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

                    <span class="n">model</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="c1"># del f_model_interp</span>
                    <span class="k">del</span> <span class="n">model_interp</span>
                    <span class="k">del</span> <span class="n">chi2</span>
                    <span class="k">del</span> <span class="n">loglikelihood</span>
                    <span class="k">del</span> <span class="n">lon_model</span>
                    <span class="k">del</span> <span class="n">lat_model</span>
                    <span class="k">del</span> <span class="n">vel_model</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">loglikelihood_grid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># print(loglikelihood_grid)</span>

                <span class="n">i_bestfit2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">loglikelihood_grid</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">loglikelihood_grid</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># print(i_bestfit2)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    The best-fitting model for </span><span class="si">{}</span><span class="s1"> with transition </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">transition</span><span class="p">)</span> <span class="o">+</span>
                      <span class="s1">&#39;  has parameters &#39;</span> <span class="o">+</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="n">i_bestfit2</span><span class="p">]))</span>

                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_chi2.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                                                         <span class="n">transition</span><span class="p">,</span> <span class="n">comp</span><span class="p">),</span>
                        <span class="n">chi2_grid</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_loglikelihood.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                                                                  <span class="n">transition</span><span class="p">,</span> <span class="n">comp</span><span class="p">),</span>
                        <span class="n">loglikelihood_grid</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_parameters.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                                                               <span class="n">transition</span><span class="p">,</span> <span class="n">comp</span><span class="p">),</span>
                        <span class="n">params</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">obs</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">obs_data</span>
            <span class="k">del</span> <span class="n">obs_error</span>
            <span class="k">del</span> <span class="n">lon_obs</span>
            <span class="k">del</span> <span class="n">lat_obs</span>
            <span class="c1"># if not vel is None:</span>
            <span class="c1">#     del vel</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">i_bestfit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">chi2_grid</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">chi2_grid</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  The best-fitting model has parameters&#39;</span> <span class="o">+</span>
                  <span class="n">model_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="n">i_bestfit1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># i_bestfit2 = np.where(loglikelihood_grid == np.max(loglikelihood_grid))[0][0]</span>


    <span class="k">return</span></div>



<div class="viewcode-block" id="model_selection_new">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.model_selection_new.html#kosmatau3d.comparison.model_selection.model_selection_new">[docs]</a>
<span class="k">def</span> <span class="nf">model_selection_new</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;/mnt/yanitski_backup/yanitski/projects/pdr/KT3_history/MilkyWay&#39;</span><span class="p">,</span> <span class="n">missions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                        <span class="n">model_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">model_param</span><span class="o">=</span><span class="p">[[]],</span> <span class="n">comp_type</span><span class="o">=</span><span class="s1">&#39;pv&#39;</span><span class="p">,</span> <span class="n">log_comp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gist_ncar&#39;</span><span class="p">,</span>
                        <span class="n">spectra</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">PLOT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PRINT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Like `model_selection_old`, but using `SyntheticModel()` and `Observation` instances.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># Check that the missions are specified properly.</span>
    <span class="k">if</span> <span class="n">missions</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">missions</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">missions</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">missions</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;KT3_history&#39;</span><span class="p">,</span> <span class="s1">&#39;observational_data&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">missions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">missions</span> <span class="o">=</span> <span class="p">[</span><span class="n">missions</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">missions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Use both COBE instruments if simply &#39;COBE&#39; is specified</span>
        <span class="k">if</span> <span class="s1">&#39;COBE&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span> <span class="n">missions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span> <span class="n">missions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span>
            <span class="n">missions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">)</span>
            <span class="n">missions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please specify a list of missions to compare the models.&#39;</span><span class="p">)</span>
        <span class="k">return</span>
  
    <span class="k">if</span> <span class="n">model_dir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">model_param</span> <span class="o">==</span> <span class="p">[[]]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please specify both model_dir and model_param.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">f_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missions</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">f_idx</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f_idx</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">f_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missions</span><span class="p">)</span> <span class="o">*</span> <span class="n">f_idx</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">f_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missions</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A valid index must be specified for f_idx.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;An int or list(int) must be specified for f_idx.&#39;</span><span class="p">)</span>
        <span class="k">return</span>
  
    <span class="n">model_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">model_param</span><span class="p">)</span>
    <span class="c1"># model_params = zip(np.transpose([model_params[n].flatten() for n in range(len(model_param))]))</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">model_params</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_param</span><span class="p">))])</span>

    <span class="c1"># pprint([model_dir.format(*m) for m in model_params])</span>

    <span class="k">if</span> <span class="n">log_comp</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">comp_type</span> <span class="o">+</span> <span class="s1">&#39;_logT&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">comp_type</span>

    <span class="n">obs_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vel</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">survey</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">missions</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">  </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">survey</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;HiGAL&#39;</span><span class="p">,</span> <span class="s1">&#39;GRS&#39;</span><span class="p">,</span> <span class="s1">&#39;CGPS&#39;</span><span class="p">,</span> <span class="s1">&#39;SGPS&#39;</span><span class="p">,</span> <span class="s1">&#39;VGPS&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;KT3_history&#39;</span><span class="p">,</span> <span class="s1">&#39;observational_data&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">Observation</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;KT3_history&#39;</span><span class="p">,</span> <span class="s1">&#39;observational_data&#39;</span><span class="p">))</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">load_survey</span><span class="p">(</span><span class="n">survey</span><span class="o">=</span><span class="n">survey</span><span class="p">)</span>
        <span class="c1"># if mission == &#39;COBE-FIRAS&#39;:</span>
        <span class="c1">#     directory += &#39;temp/&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no data is available.&#39;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>

        <span class="c1"># Loop through the different models</span>
        <span class="c1"># for i_obs in range(len(obs_data)):</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">f_idx</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">file</span> <span class="ow">or</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">file</span> <span class="ow">or</span> <span class="s1">&#39;.csv&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

            <span class="n">transitions</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">obs_iid</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">transition_indeces</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">obs_i_iid</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">get_intensity</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">integrated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">get_intensity</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">integrated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">obs_data_temp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">obs_data</span><span class="p">)</span>
            <span class="n">obs_error</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">obs_error_data</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">obs_error_conf</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">obs_error_conf_data</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">obs_lon</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">lon_obs</span><span class="p">[</span><span class="n">lon_obs</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon_obs</span><span class="p">[</span><span class="n">lon_obs</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">]</span> <span class="o">-</span> <span class="mi">360</span>
            <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">obs_lat</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">vel_obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">obs_vel</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">i_lat_obs_init</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">get_obs_extent</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  fitting&#39;</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>

                <span class="n">chi2_grid</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">loglikelihood_grid</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># if (survey == &#39;COBE-DIRBE&#39;) or (survey == &#39;COBE-FIRAS&#39;):</span>
                <span class="c1">#     if &#39;.idl&#39; in file:</span>
                <span class="c1">#         # obs_error_conf = error_correction(obs_data[:, int(transition_indeces[i])],</span>
                <span class="c1">#         #                                   conf=&#39;axisymmetric&#39;)</span>
                <span class="c1">#         vmin = obs_data[:, int(transition_indeces[i])].min()</span>
                <span class="c1">#         vmax = obs_data[:, int(transition_indeces[i])].max()</span>
                <span class="c1">#     else:</span>
                <span class="c1">#         # obs_error_conf = error_correction(obs_data[int(transition_indeces[i]), :, :],</span>
                <span class="c1">#         #                                   conf=&#39;axisymmetric&#39;)</span>
                <span class="c1">#         vmin = obs_data[int(transition_indeces[i]), :, :].min()</span>
                <span class="c1">#         vmax = obs_data[int(transition_indeces[i]), :, :].max()</span>
                <span class="c1">#     # print(transition)</span>
                <span class="c1">#     # print(vmin, vmax)</span>
                <span class="c1"># elif not (survey==&#39;GOT_C+&#39; and &#39;.csv&#39; in file):</span>
                <span class="c1">#     # obs_error_conf = error_correction(obs_data, conf=&#39;axisymmetric&#39;)</span>
                <span class="c1">#     vmin = np.nanmin(obs_data)</span>
                <span class="c1">#     vmax = np.nanmax(obs_data)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     obs_error_conf = 0</span>

                <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Average error in observation: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">obs_error</span><span class="p">)))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Correction due to axisymmetry: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">obs_error_conf</span><span class="p">)))</span>
                
                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SyntheticModel</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model_params</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;    </span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

                    <span class="c1"># Check existance of model</span>
                    <span class="n">dir_model</span> <span class="o">=</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">)</span><span class="c1">#</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">dir_model</span> <span class="o">+</span> <span class="s1">&#39;synthetic_intensity.fits&#39;</span><span class="p">):</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No intensity&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Open the model</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">dir_model</span><span class="p">)</span>

                    <span class="c1"># Locate the species transition (only one dust value is considered; constant background)</span>
                    <span class="c1"># if transition in model.dust:</span>
                    <span class="c1">#     i_spec = np.where(model.dust == transition)[0]</span>
                    <span class="c1"># elif transition in model.species:</span>
                    <span class="c1">#     i_spec = np.where(model.species == transition)[0]</span>
                    <span class="c1"># elif transition == &#39;HI&#39;:</span>
                    <span class="c1">#     i_spec = np.zeros(1)</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     print(f&#39;  {transition} not in model.  &#39;)</span>
                    <span class="c1">#     break</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     i_spec = i_spec[0]</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fit_results/</span><span class="si">{</span><span class="n">survey</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fit_results/</span><span class="si">{</span><span class="n">survey</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>

                    <span class="c1"># Create arrays for the longitude and velocity axes</span>
                    <span class="n">lat_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">map_lat</span>
                    <span class="n">lon_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">map_lon</span>
                    <span class="n">vel_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">map_vel</span>

                    <span class="c1"># Identify the common latitudes between the observations and the model</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">lat</span>
                        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lat</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">lat_obs</span><span class="p">[</span><span class="n">i_lat_obs_init</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lat_obs</span><span class="p">[</span><span class="n">i_lat_obs_init</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
  
                    <span class="n">i_lon_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_model</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">i_lat_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_model</span> <span class="o">&gt;=</span> <span class="n">lat_min</span><span class="p">)</span>
                                            <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_model</span> <span class="o">&lt;=</span> <span class="n">lat_max</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># print(lat_obs, lat_model[i_lat_model])</span>
                    <span class="n">i_lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_obs</span> <span class="o">&gt;=</span> <span class="n">lat_model</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                         <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_obs</span> <span class="o">&lt;=</span> <span class="n">lat_model</span><span class="o">.</span><span class="n">max</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">ix_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">:</span>
                        <span class="n">bin_edge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="p">((</span><span class="n">lon_obs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">lon_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mf">182.5</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39; + &#39;</span> <span class="ow">in</span> <span class="n">transition</span><span class="p">:</span>
                            <span class="n">model_intensity</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_species_intensity</span><span class="p">(</span><span class="n">transition</span><span class="o">=</span><span class="n">transition</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; + &#39;</span><span class="p">),</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">integrated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">model_intensity</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_species_intensity</span><span class="p">(</span><span class="n">transition</span><span class="o">=</span><span class="n">transition</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">integrated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">lon_model_alt</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">lon_model</span><span class="p">)</span>
                        <span class="n">lon_model_alt</span><span class="p">[</span><span class="n">lon_model_alt</span><span class="o">&lt;-</span><span class="mf">177.5</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon_model_alt</span><span class="p">[</span><span class="n">lon_model_alt</span><span class="o">&lt;-</span><span class="mf">177.5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span>
                        <span class="n">model_data_temp</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">lon_model_alt</span><span class="p">,</span> <span class="n">model_intensity</span><span class="p">,</span> <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edge</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">model_data_temp</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">model_data_temp</span><span class="o">.</span><span class="n">T</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_data_temp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">[</span><span class="n">obs_data_temp</span><span class="p">[:,</span> <span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">]]])</span>
                        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_obs</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                        <span class="n">ix_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                        <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_data_temp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_error</span><span class="p">[:,</span> <span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">obs_error_conf</span><span class="p">[:,</span> <span class="n">transition_indeces</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span><span class="p">)])[</span><span class="n">ix_obs</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;GOT_C+&#39;</span> <span class="ow">and</span> <span class="s1">&#39;.csv&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                        <span class="n">obs_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lon_obs</span><span class="p">)</span>
                        <span class="n">obs_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">vel_obs</span><span class="p">)</span>
                        <span class="c1"># obs_lon[obs_lon&gt;180] = obs_lon[obs_lon&gt;180]-360</span>
                        <span class="n">bin_mid</span> <span class="o">=</span> <span class="n">obs_lon</span>
                        <span class="n">bin_edge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">bin_mid</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bin_mid</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mi">180</span><span class="p">])</span>
                        <span class="n">model_intensity</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_species_intensity</span><span class="p">(</span><span class="n">transition</span><span class="o">=</span><span class="s1">&#39;C+ 1&#39;</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">integrated</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">map_lon</span><span class="p">,</span> <span class="n">model_intensity</span><span class="p">,</span> <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edge</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model_data</span><span class="p">)</span>
                        <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model_data</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">lon</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obs_lon</span><span class="p">):</span>
                            <span class="n">obs_data</span><span class="p">[:,</span> <span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs_data_temp</span><span class="p">[</span><span class="n">lon_obs</span><span class="o">==</span><span class="n">lon</span><span class="p">]</span>
                            <span class="n">obs_error_final</span><span class="p">[:,</span> <span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_error</span><span class="p">[</span><span class="n">lon_obs</span><span class="o">==</span><span class="n">lon</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">obs_error_conf</span><span class="p">[</span><span class="n">lon_obs</span><span class="o">==</span><span class="n">lon</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                        <span class="n">ix_obs</span> <span class="o">=</span> <span class="n">ix</span>
                    <span class="k">elif</span> <span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;HI&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                            <span class="n">ix_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                            <span class="n">model_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_hi_intensity</span><span class="p">(</span><span class="n">integrated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">*</span><span class="n">obs_error</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">obs_error_conf</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))[</span><span class="n">i_obs</span><span class="p">][</span><span class="n">ix_err</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span>
                            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                            <span class="n">ix_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                            <span class="n">model_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_hi_intensity</span><span class="p">(</span><span class="n">integrated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_error</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">obs_error_conf</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="n">ix_obs</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                            <span class="n">ix_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                            <span class="n">model_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_species_intensity</span><span class="p">(</span><span class="n">transition</span><span class="o">=</span><span class="n">transition</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">integrated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">*</span><span class="n">obs_error</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">obs_error_conf</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))[</span><span class="n">ix_obs</span><span class="p">][</span><span class="n">ix_err</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span>
                            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                            <span class="n">ix_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                            <span class="n">model_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_species_intensity</span><span class="p">(</span><span class="n">transition</span><span class="o">=</span><span class="n">transition</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">integrated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_error</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">obs_error_conf</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="n">ix_obs</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">dust</span><span class="p">:</span>
                        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                        <span class="n">ix_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">)</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_dust_intensity</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">transition</span><span class="p">)</span>
                        <span class="n">obs_error_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_error</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">obs_error_conf</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="n">ix_obs</span><span class="p">][</span><span class="n">ix_err</span><span class="p">]</span>

                    <span class="n">model_interp</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                    <span class="n">obs_data_final</span> <span class="o">=</span> <span class="n">obs_data</span><span class="p">[</span><span class="n">ix_obs</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span>
  
                    <span class="n">model_interp</span><span class="p">[</span><span class="n">model_interp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_data_final</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Observation improperly indexed!&#39;</span><span class="p">)</span>
                        <span class="k">break</span>

                    <span class="c1"># if ((survey == &#39;COBE&#39;) or (survey == &#39;COBE-FIRAS&#39;)):</span>
                    <span class="k">if</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                        <span class="n">i_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="p">((</span><span class="n">obs_data_final</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_data_final</span><span class="p">)</span>
                                              <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">model_interp</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="p">((</span><span class="n">obs_data_final</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_data_final</span><span class="p">)</span>
                                              <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">model_interp</span><span class="p">)))</span>
                    
                    <span class="k">if</span> <span class="n">log_comp</span><span class="p">:</span>
                        <span class="n">obs_error_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs_error_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">obs_data_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span>
                        <span class="n">obs_data_final</span><span class="p">[</span><span class="n">obs_data_final</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-100</span>
                        <span class="n">obs_data_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">obs_data_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">])</span>
                        <span class="n">model_interp</span><span class="p">[</span><span class="n">model_interp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-100</span>
                        <span class="n">model_interp</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">model_interp</span><span class="p">[</span><span class="n">i_signal</span><span class="p">])</span>

                    <span class="c1"># Calculate the chi**2 and overall likelihood</span>
                    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model_interp</span><span class="p">)</span>
                    <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model_interp</span><span class="p">)</span>
                        
                    <span class="n">chi2</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_data_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">-</span> <span class="n">model_interp</span><span class="p">[</span><span class="n">i_signal</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> \
                                    <span class="n">obs_error_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="n">loglikelihood</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">chi2</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> \
                                            <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">obs_error_final</span><span class="p">[</span><span class="n">i_signal</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    
                    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">loglikelihood</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="k">if</span> <span class="o">~</span><span class="n">chi2</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">chi2</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">dir_model</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Observation improperly indexed -- all NaN!&#39;</span><span class="p">)</span>
                        <span class="k">return</span>
                    
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fit_results/</span><span class="si">{</span><span class="n">survey</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">/&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_model</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;channel_intensity.fits&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">comp</span><span class="si">}</span><span class="s2">_chi2.npy&quot;</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fit_results/</span><span class="si">{</span><span class="n">survey</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">/&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_model</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;channel_intensity.fits&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">comp</span><span class="si">}</span><span class="s2">_loglikelihood.npy&quot;</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>

                    <span class="n">chi2_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chi2</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="n">loglikelihood_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loglikelihood</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
  
                    <span class="c1"># model.close()</span>
                    <span class="c1"># del f_model_interp</span>
                    <span class="k">del</span> <span class="n">model_interp</span>
                    <span class="k">del</span> <span class="n">chi2</span>
                    <span class="k">del</span> <span class="n">loglikelihood</span>
                    <span class="k">del</span> <span class="n">lon_model</span>
                    <span class="k">del</span> <span class="n">lat_model</span>
                    <span class="k">del</span> <span class="n">vel_model</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">loglikelihood_grid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># print(loglikelihood_grid)</span>

                <span class="n">i_bestfit2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">loglikelihood_grid</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">loglikelihood_grid</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># print(i_bestfit2)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">    The best-fitting model for </span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> with transition </span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;  </span><span class="se">\n</span><span class="s2">    has parameters </span><span class="si">{</span><span class="n">model_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="n">i_bestfit2</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fit_results/</span><span class="si">{</span><span class="n">survey</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">_chi2.npy&quot;</span><span class="p">,</span> <span class="n">chi2_grid</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fit_results/</span><span class="si">{</span><span class="n">survey</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">_loglikelihood.npy&quot;</span><span class="p">,</span> <span class="n">loglikelihood_grid</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fit_results/</span><span class="si">{</span><span class="n">survey</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">_parameters.npy&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

            <span class="c1"># if &#39;.fits&#39; in file:</span>
            <span class="c1">#     obs.close()</span>
            <span class="k">del</span> <span class="n">obs_data</span>
            <span class="k">del</span> <span class="n">obs_error</span>
            <span class="k">del</span> <span class="n">lon_obs</span>
            <span class="k">del</span> <span class="n">lat_obs</span>
  
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i_bestfit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">chi2_grid</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">chi2_grid</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">  The best-fitting model has parameters   </span><span class="si">{</span><span class="n">model_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="n">i_bestfit1</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span></div>



<div class="viewcode-block" id="line_ratio_comparison">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.line_ratio_comparison.html#kosmatau3d.comparison.model_selection.line_ratio_comparison">[docs]</a>
<span class="k">def</span> <span class="nf">line_ratio_comparison</span><span class="p">(</span><span class="n">obs_path</span><span class="o">=</span><span class="s1">&#39;/mnt/hpc_backup/yanitski/projects/pdr/observational_data/MilkyWay/&#39;</span><span class="p">,</span>
                          <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;/mnt/hpc_backup/yanitski/projects/pdr/KT3_history/fit_results/MilkyWay/&#39;</span><span class="p">,</span>
                          <span class="n">missions</span><span class="o">=</span><span class="p">[],</span> <span class="n">transitions</span><span class="o">=</span><span class="p">[],</span> <span class="n">survey_files</span><span class="o">=</span><span class="p">[],</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">model_param</span><span class="o">=</span><span class="p">[[]],</span>
                          <span class="n">log_comp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comp_type</span><span class="o">=</span><span class="s1">&#39;integrated&#39;</span><span class="p">,</span>
                          <span class="n">figsize</span><span class="o">=</span><span class="p">(),</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">boxwidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                          <span class="n">label_rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">label_fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                          <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span>
                          <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">violin_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">violin_spacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot comparison of line ratios.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">survey_paths</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>  <span class="c1"># list for paths to plotted data (in order observed, synthetic)</span>
    <span class="n">survey_maps</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>   <span class="c1"># list for unprocessed (pre-calculation) data to plot (in order observed, synthetic)</span>
    <span class="n">survey_i_lat_init</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list for initial observed lattitude indeces where there is an observation</span>
    <span class="n">survey_i_vel_init</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list for initial observed velocity indeces where there is an observation</span>
    <span class="n">survey_ix</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>     <span class="c1"># list of indeces used in comparison (in order observed, synthetic)</span>
    <span class="n">survey_ratios</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span> <span class="c1"># list of processed (post-calculation) data to plot (in order observed, synthetic)</span>
    <span class="c1"># list of labels for each ratio (in order observed, synthetic)</span>
    <span class="n">survey_labels</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missions</span><span class="p">)],</span> <span class="p">[]]</span>
    <span class="c1"># list of available transitions in the data (in order observed, synthetic; used for debugging)</span>
    <span class="n">survey_transitions</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
    <span class="n">survey_lons</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>   <span class="c1"># list of data longitude (in order observed, synthetic)</span>
    <span class="n">survey_lats</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>   <span class="c1"># list of data lattitude (in order observed, synthetic)</span>
    <span class="n">survey_vels</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>   <span class="c1"># list of data velocities (in order observed, synthetic; 0 for 2D maps)</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;Planck&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">):</span>
        <span class="n">comp_type</span> <span class="o">=</span> <span class="s1">&#39;integrated&#39;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">survey</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">missions</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span>
        <span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_path</span> <span class="o">+</span> <span class="n">missions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span> <span class="n">survey_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">survey_transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)))</span>
            <span class="n">i_trans_obs</span> <span class="o">=</span> <span class="n">survey_transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">transitions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i_trans_obs</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid transition </span><span class="si">{}</span><span class="s1"> for file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">survey_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">return</span>
            <span class="n">survey_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                              <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]))</span>
            <span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                              <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">:</span>
                <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i_trans_obs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">:</span>
                <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i_trans_obs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">:</span>
                <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:])</span>
                <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;Planck&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">)</span> <span class="ow">or</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span>
                <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">survey_i_vel_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;Enter a valid string for `comp_type`: &#39;integrated&#39; for a 2D comparison of maps &#39;&#39;&#39;</span>
                      <span class="o">+</span> <span class="s1">&#39;&#39;&#39;and &#39;pv&#39; for a 3D comparison of spectroscopic data.&#39;&#39;&#39;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">survey_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">])</span>
            <span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">survey_transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i_trans_obs</span> <span class="o">=</span> <span class="n">cobe_idl_transitions</span> <span class="o">==</span> <span class="n">transitions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i_trans_obs</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">][:,</span> <span class="n">i_trans_obs</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.9979</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                                   <span class="o">*</span> <span class="p">(</span><span class="n">cobe_idl_linfrq</span><span class="p">[</span><span class="n">i_trans_obs</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">1.38</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid mission path </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">i_lon_obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i_lon_model</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i_lat_obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i_lat_model</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;Planck&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">)):</span>
        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">([</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">survey_i_lat_init</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">survey_i_lat_init</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span>
        <span class="n">vel_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">([</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">survey_i_vel_init</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
        <span class="n">vel_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">survey_i_vel_init</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>

    <span class="n">model_param_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_param</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">model_param_grid</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_param_grid</span><span class="p">))])</span>

    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model_params</span><span class="p">:</span>

        <span class="n">survey_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">))</span>
        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">model_path</span> <span class="o">+</span> <span class="n">survey_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;synthetic_intensity.fits&#39;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>

        <span class="c1"># Create arrays for the longitude and velocity axes of the synthetic observation if required</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">survey_lons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="c1"># if not (mission == &#39;COGAL&#39;):</span>
            <span class="c1">#     lon_model[lon_model&lt;0] += 360</span>
            <span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS4&#39;</span><span class="p">]))</span>

        <span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;Dust&#39;</span><span class="p">:</span>
                <span class="n">survey_transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DUST&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)))</span>
                <span class="c1"># survey_maps[1][-1].append(deepcopy(model[2].data[0, :, :, 0]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">survey_transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SPECIES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)))</span>
                <span class="n">i_transition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">survey_transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">transition</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i_transition</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;Planck&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">):</span>
                    <span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">i_transition</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
                                                       <span class="c1"># - model[2].data[:, :, :, 0], survey_vels[1][0], axis=0))</span>
                                                       <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">i_transition</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">i_transition</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
                                              <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Transition </span><span class="si">{}</span><span class="s1"> not found in model&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transition</span><span class="p">))</span>
                    <span class="k">return</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">i_lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">survey_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">survey_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">i_lon_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">survey_lons</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">survey_lons</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">i_lat_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lat_min</span><span class="p">)</span>
                                       <span class="o">&amp;</span> <span class="p">(</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lat_max</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">i_lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                     <span class="o">&amp;</span> <span class="p">(</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span> <span class="c1">#compare 2D maps</span>
                    <span class="n">survey_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_obs</span><span class="p">))</span>
                    <span class="n">survey_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="c1">#compare 3D maps</span>
                    <span class="n">i_vel_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">vel_min</span><span class="p">)</span>
                                           <span class="o">&amp;</span> <span class="p">(</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">vel_max</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">i_vel_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_vel_model</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                         <span class="o">&amp;</span> <span class="p">(</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_vel_model</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">survey_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_vel_obs</span><span class="p">,</span> <span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_obs</span><span class="p">))</span>
                    <span class="n">survey_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_vel_model</span><span class="p">,</span> <span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">survey_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">survey_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                                     <span class="o">/</span> <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">survey_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="c1"># for i in range(len(survey_maps[1])):</span>
        <span class="n">survey_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">survey_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                                 <span class="o">/</span> <span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">survey_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">survey_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">survey_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">violin_spacing</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)),</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">violin_spacing</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">violin_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">violin_spacing</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">violin_spacing</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log_comp</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="s1">&#39;_logT&#39;</span>
        <span class="n">i_nan_obs</span> <span class="o">=</span> <span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">i_nan_model</span> <span class="o">=</span> <span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="o">~</span><span class="n">i_nan_obs</span><span class="p">]),</span>
                <span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="o">~</span><span class="n">i_nan_model</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">violin_positions</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="n">violin_width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$log_</span><span class="si">{10}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\left( \varpi_{&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;} \ / \ \varpi_{&#39;</span>
                          <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;} \right)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$log_</span><span class="si">{10}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\left( T_\mathrm{B, &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;} \ / \ \varpi_{&#39;</span>
                          <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;} \right)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">violin_positions</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="n">violin_width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\varpi_{&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;} \ / \ \varpi_{&#39;</span>
                          <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$T_\mathrm{B, &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;} \ / \ \varpi_{&#39;</span>
                          <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ylim</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">violin_positions</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelrotation</span><span class="o">=</span><span class="n">label_rotation</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">label_fontsize</span><span class="p">)</span>
    <span class="c1">#xticknames = ax.get_xticklabels()</span>
    <span class="c1">#plt.setp(xticknames, rotation=label_rotation, fontsize=label_fontsize)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ylim</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">transitions</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="c1">#plt.tight_layout()</span>
    <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_file</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">current_output_file</span> <span class="o">=</span> <span class="s1">&#39;boxplot_ratio_</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                                        <span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                        <span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                                        <span class="n">transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span> <span class="o">+</span> <span class="n">comp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_output_file</span> <span class="o">=</span> <span class="n">output_file</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">model_path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/Plots/</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_output_file</span><span class="p">,</span> <span class="n">output_format</span><span class="p">),</span>
                    <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span></div>



<div class="viewcode-block" id="violin_comparison">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.violin_comparison.html#kosmatau3d.comparison.model_selection.violin_comparison">[docs]</a>
<span class="k">def</span> <span class="nf">violin_comparison</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;/mnt/hpc_backup/yanitski/projects/pdr/observational_data/MilkyWay/&#39;</span><span class="p">,</span> 
                      <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">surveys</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_param</span><span class="o">=</span><span class="p">[[]],</span> <span class="n">log_comp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comp_type</span><span class="o">=</span><span class="s1">&#39;integrated&#39;</span><span class="p">,</span>
                      <span class="n">ylim</span><span class="o">=</span><span class="p">[],</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">violin_width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">violin_spacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">showextrema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                      <span class="n">label_rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">label_fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                      <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span>
                      <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compare models and observation as violin plots.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Check that the missions are specified properly.</span>
    <span class="k">if</span> <span class="n">surveys</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">surveys</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">surveys</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">surveys</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surveys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">surveys</span> <span class="o">=</span> <span class="p">[</span><span class="n">surveys</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surveys</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Use both COBE instruments if simply &#39;COBE&#39; is specified</span>
        <span class="k">if</span> <span class="s1">&#39;COBE&#39;</span> <span class="ow">in</span> <span class="n">surveys</span><span class="p">:</span>
            <span class="n">survey</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;COBE&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">surveys</span><span class="p">:</span> <span class="n">surveys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">in</span> <span class="n">surveys</span><span class="p">:</span> <span class="n">surveys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span>
            <span class="n">surveys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">)</span>
            <span class="n">surveys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please specify a list of missions to compare the models.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">model_param</span> <span class="o">==</span> <span class="p">[[]]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please specify both file_format and model_param.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">log_comp</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">comp_type</span> <span class="o">+</span> <span class="s1">&#39;_logT&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">comp_type</span>

    <span class="n">model_param_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_param</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">model_param_grid</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_param_grid</span><span class="p">))])</span>

    <span class="k">for</span> <span class="n">survey</span> <span class="ow">in</span> <span class="n">surveys</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Plots&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">obs_directory</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span>

        <span class="c1"># if verbose:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;_files&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;_files&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">survey_files</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;_files&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;_files&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">survey_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;_files&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Incorrect files specified for survey </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">))</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">survey_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">survey_files</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;observational_data&#39;</span><span class="p">,</span> <span class="s1">&#39;KT3_history&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;fit_results/&#39;</span> <span class="o">+</span> <span class="n">survey</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;observational_data&#39;</span><span class="p">,</span> <span class="s1">&#39;KT3_history&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;fit_results/&#39;</span> <span class="o">+</span> <span class="n">survey</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;Plots&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;observational_data&#39;</span><span class="p">,</span> <span class="s1">&#39;KT3_history&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;fit_results/&#39;</span> <span class="o">+</span> <span class="n">survey</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;observational_data&#39;</span><span class="p">,</span> <span class="s1">&#39;KT3_history&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;fit_results/&#39;</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/Plots/&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">survey_file</span> <span class="ow">in</span> <span class="n">survey_files</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey_file</span><span class="p">))</span>

            <span class="k">if</span> <span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span> <span class="ow">or</span> <span class="s1">&#39;.FITS&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span><span class="p">:</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">obs_directory</span> <span class="o">+</span> <span class="n">survey_file</span><span class="p">)</span>
                <span class="n">obs_error</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">obs_directory</span> <span class="o">+</span> <span class="n">survey_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_error.fits&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">elif</span> <span class="s1">&#39;.sav&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span> <span class="ow">or</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span><span class="p">:</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">obs_directory</span> <span class="o">+</span> <span class="n">survey_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">survey_file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid: Unknown file type in observation folder.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">survey_file</span> <span class="o">==</span> <span class="s1">&#39;craig.idl&#39;</span><span class="p">:</span>

                    <span class="c1"># This file requires a comparison to the galactic plane</span>
                    <span class="c1"># lat = 0</span>

                    <span class="c1"># these values are hard-coded since the data is not in the file</span>
                    <span class="n">linfrq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">115.3</span><span class="p">,</span> <span class="mf">230.5</span><span class="p">,</span> <span class="mf">345.8</span><span class="p">,</span> <span class="mf">424.8</span><span class="p">,</span> <span class="mf">461.0</span><span class="p">,</span> <span class="mf">492.2</span><span class="p">,</span> <span class="mf">556.9</span><span class="p">,</span> <span class="mf">576.3</span><span class="p">,</span> <span class="mf">691.5</span><span class="p">,</span> <span class="mf">808.1</span><span class="p">,</span>
                                       <span class="mi">1113</span><span class="p">,</span> <span class="mi">1460</span><span class="p">,</span> <span class="mi">2226</span><span class="p">,</span> <span class="mi">1901</span><span class="p">,</span> <span class="mi">2060</span><span class="p">,</span> <span class="mi">2311</span><span class="p">,</span> <span class="mi">2459</span><span class="p">,</span> <span class="mi">2589</span><span class="p">,</span> <span class="mf">921.8</span><span class="p">])</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;CO 1&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 2&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 3&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 4&#39;</span><span class="p">,</span> <span class="s1">&#39;C 3&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 5&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;CO 6&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 7 + C 1&#39;</span><span class="p">,</span> <span class="s1">&#39;C+ 1&#39;</span><span class="p">,</span> <span class="s1">&#39;O 1&#39;</span><span class="p">,</span> <span class="s1">&#39;CO 8&#39;</span><span class="p">])</span>
                    <span class="n">transition_indeces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">18</span><span class="p">])</span>

                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.9979</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">linfrq</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">1.38</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span>
                    <span class="n">obs_error</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.9979</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">linfrq</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">1.38</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span>
                    <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span>
                    <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">i_lat_obs_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                    <span class="n">comp_type</span> <span class="o">=</span> <span class="s1">&#39;integrated&#39;</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">pprint</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                    <span class="c1"># obs_error = obs[0].header[&#39;OBSERR&#39;].split()</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                    <span class="n">transition_indeces</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                    <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                          <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                          <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
                    <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                          <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                          <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                    <span class="n">i_lat_obs_init</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">comp_type</span> <span class="o">=</span> <span class="s1">&#39;pv&#39;</span>

            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">:</span>
                <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">pprint</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="c1"># obs_error = obs[0].header[&#39;OBSERR&#39;].split()</span>
                <span class="n">transitions</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                <span class="n">transition_indeces</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                      <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
                <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                      <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                <span class="n">i_lat_obs_init</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">comp_type</span> <span class="o">=</span> <span class="s1">&#39;pv&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">pprint</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="c1"># obs_error = obs[0].header[&#39;OBSERR&#39;]</span>
                <span class="n">transitions</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                <span class="n">transition_indeces</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                      <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
                <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                      <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
                <span class="n">vel_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                      <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span>
                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">obs_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">vel_obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">i_lat_obs_init</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i_trans_obs</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>

                <span class="nb">print</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>

                <span class="n">map_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">obs_data</span><span class="p">)]</span>
                <span class="n">map_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">transition</span><span class="p">]</span>
                <span class="n">i_model</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">model_params</span><span class="p">):</span>

                    <span class="n">map_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">))</span>
                    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;observational_data&#39;</span><span class="p">,</span> <span class="s1">&#39;KT3_history&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">map_labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> \
                                <span class="o">+</span> <span class="s1">&#39;synthetic_intensity.fits&#39;</span>

                    <span class="n">model</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>

                    <span class="c1"># Create arrays for the longitude and velocity axes</span>
                    <span class="n">lat_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                    <span class="n">lon_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                    <span class="c1"># if not (mission == &#39;COGAL&#39;):</span>
                    <span class="c1">#     lon_model[lon_model&lt;0] += 360</span>
                    <span class="n">vel_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS4&#39;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;Dust&#39;</span><span class="p">:</span>
                        <span class="c1"># map_list.append(deepcopy(model[2].data[0, :, :, 0]))</span>
                        <span class="n">map_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i_transition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SPECIES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">))</span> <span class="o">==</span> <span class="n">transition</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">i_transition</span><span class="o">.</span><span class="n">size</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span>
                            <span class="n">map_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">i_transition</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                                            <span class="c1"># model[2].data[:, :, :, 0], vel_model, axis=0))</span>
                                            <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">i_transition</span><span class="o">.</span><span class="n">size</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                            <span class="n">map_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">i_transition</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                                                     <span class="c1"># model[2].data[:, :, :, 0], vel_model, axis=0))</span>
                                                     <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vel_model</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Transition </span><span class="si">{}</span><span class="s1"> not found in file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transition</span><span class="p">,</span> <span class="n">survey_file</span><span class="p">))</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span> <span class="ow">and</span>
                        <span class="ow">not</span> <span class="p">(</span><span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">)):</span>
                        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">lat</span>
                        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lat</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">lat_obs</span><span class="p">[</span><span class="n">i_lat_obs_init</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lat_obs</span><span class="p">[</span><span class="n">i_lat_obs_init</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                    <span class="n">i_vel_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vel_obs</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">vel_obs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                    <span class="n">i_vel_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">vel_model</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                    <span class="n">i_lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon_obs</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">lon_obs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                    <span class="n">i_lon_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lon_model</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">lon_model</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;DOBE-DIRBE&#39;</span> <span class="ow">or</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">:</span>
                        <span class="n">i_lat_model</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_model</span> <span class="o">&gt;=</span> <span class="n">lat_min</span><span class="p">)</span> \
                                      <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_model</span> <span class="o">&lt;=</span> <span class="n">lat_max</span><span class="p">)</span>
                        <span class="n">i_lat_obs</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_obs</span> <span class="o">&gt;=</span> <span class="n">lat_model</span><span class="p">[</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> \
                                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_obs</span> <span class="o">&lt;=</span> <span class="n">lat_model</span><span class="p">[</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i_lat_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_model</span> <span class="o">&gt;=</span> <span class="n">lat_min</span><span class="p">)</span>
                                               <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_model</span> <span class="o">&lt;=</span> <span class="n">lat_max</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">i_lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lat_obs</span> <span class="o">&gt;=</span> <span class="n">lat_model</span><span class="p">[</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                             <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_obs</span> <span class="o">&lt;=</span> <span class="n">lat_model</span><span class="p">[</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span>
                        <span class="n">i_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_vel_obs</span><span class="p">,</span> <span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_obs</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                        <span class="n">i_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_obs</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">survey_file</span> <span class="o">==</span> <span class="s1">&#39;craig.idl&#39;</span><span class="p">:</span>
                        <span class="n">i_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">([</span><span class="n">i_trans_obs</span><span class="p">],</span> <span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_obs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lon_obs</span><span class="p">,</span> <span class="p">[</span><span class="n">i_trans_obs</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">survey</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">,</span> <span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">,</span> <span class="s1">&#39;Planck&#39;</span><span class="p">]:</span>
                        <span class="n">i_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_vel_model</span><span class="p">,</span> <span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                        <span class="n">i_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">map_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No models used in comparison...&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of maps and labels: </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">map_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">map_labels</span><span class="p">)))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;observation&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  full map size: </span><span class="si">{}</span><span class="s1">, indexed map size: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">map_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                                                             <span class="n">map_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i_obs</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">map_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  full map size: </span><span class="si">{}</span><span class="s1">, indexed map size: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">map_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                                                                 <span class="n">map_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i_model</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">violin_spacing</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">map_list</span><span class="p">),</span> <span class="mi">7</span><span class="p">))</span>
                <span class="n">violin_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">violin_spacing</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">map_labels</span><span class="p">),</span> <span class="n">violin_spacing</span><span class="p">)</span>
                <span class="n">i_nan_obs</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i_obs</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">map_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i_obs</span><span class="p">])</span>
                <span class="n">i_nan_model</span> <span class="o">=</span> <span class="p">[((</span><span class="n">m</span><span class="p">[</span><span class="n">i_model</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i_model</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">map_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
                <span class="k">if</span> <span class="n">log_comp</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># map_list[0] = np.nan_to_num(map_list[0], nan=0)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">map_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i_obs</span><span class="p">][</span><span class="o">~</span><span class="n">i_nan_obs</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span>
                            <span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i_model</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="o">~</span><span class="n">i_nan_model</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                              <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">map_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">violin_positions</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="n">violin_width</span><span class="p">,</span> 
                                  <span class="n">showextrema</span><span class="o">=</span><span class="n">showextrema</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$log_</span><span class="si">{10}</span><span class="s1"> (\varpi) \ \left( K \frac</span><span class="si">{km}{s}</span><span class="s1"> \right)$&#39;</span><span class="p">,</span> 
                                      <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$log_</span><span class="si">{10}</span><span class="s1"> (T_\mathrm</span><span class="si">{B}</span><span class="s1">) \ \left( K \right)$&#39;</span><span class="p">,</span>
                                      <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">map_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i_obs</span><span class="p">][</span><span class="o">~</span><span class="n">i_nan_obs</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> 
                            <span class="o">*</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">i_model</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="o">~</span><span class="n">i_nan_model</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                              <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">map_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">violin_positions</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="n">violin_width</span><span class="p">,</span>
                                  <span class="n">showextrema</span><span class="o">=</span><span class="n">showextrema</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\varpi \ \left( K \frac</span><span class="si">{km}{s}</span><span class="s1"> \right)$&#39;</span><span class="p">,</span> 
                                      <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$T_\mathrm</span><span class="si">{B}</span><span class="s1"> \ \left( K \right)$&#39;</span><span class="p">,</span> 
                                      <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">violin_positions</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">map_labels</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelrotation</span><span class="o">=</span><span class="n">label_rotation</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">label_fontsize</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">label_fontsize</span><span class="p">)</span>
                <span class="c1">#xticknames = ax.get_xticklabels()</span>
                <span class="c1">#plt.setp(xticknames, rotation=label_rotation, fontsize=label_fontsize)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ylim</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39; -- &#39;</span> <span class="o">+</span> <span class="n">transition</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">output_file</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">current_output_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;observational_data&#39;</span><span class="p">,</span> <span class="s1">&#39;KT3_history&#39;</span><span class="p">)</span> <span class="o">+</span> \
                                              <span class="sa">f</span><span class="s1">&#39;fit_results/</span><span class="si">{</span><span class="n">survey</span><span class="si">}</span><span class="s1">/Plots/violinplot_</span><span class="si">{</span><span class="n">survey_file</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">comp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">current_output_file</span> <span class="o">=</span> <span class="n">output_file</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_output_file</span><span class="p">,</span> <span class="n">output_format</span><span class="p">),</span>
                                <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span></div>



<div class="viewcode-block" id="double_line_plot">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.double_line_plot.html#kosmatau3d.comparison.model_selection.double_line_plot">[docs]</a>
<span class="k">def</span> <span class="nf">double_line_plot</span><span class="p">(</span><span class="n">obs_path</span><span class="o">=</span><span class="s1">&#39;/mnt/hpc_backup/yanitski/projects/pdr/observational_data/MilkyWay/&#39;</span><span class="p">,</span>
                     <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;/mnt/hpc_backup/yanitski/projects/pdr/KT3_history/fit_results/MilkyWay/&#39;</span><span class="p">,</span>
                     <span class="n">missions</span><span class="o">=</span><span class="p">[],</span> <span class="n">transitions</span><span class="o">=</span><span class="p">[],</span> <span class="n">survey_files</span><span class="o">=</span><span class="p">[],</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">model_param</span><span class="o">=</span><span class="p">[[]],</span>
                     <span class="n">log_comp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comp_type</span><span class="o">=</span><span class="s1">&#39;integrated&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                     <span class="n">cmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(),</span> 
                     <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">label_rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">label_fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                     <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span>
                     <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot two lines against each other. Not setup well for comparing model grids.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">survey_paths</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>  <span class="c1"># list for paths to plotted data (in order observed, synthetic)</span>
    <span class="n">survey_maps</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>   <span class="c1"># list for unprocessed (pre-calculation) data to plot (in order observed, synthetic)</span>
    <span class="n">survey_i_lat_init</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list for initial observed lattitude indeces where there is an observation</span>
    <span class="n">survey_i_vel_init</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list for initial observed velocity indeces where there is an observation</span>
    <span class="n">survey_ix</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>     <span class="c1"># list of indeces used in comparison (in order observed, synthetic)</span>
    <span class="n">survey_ratios</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span> <span class="c1"># list of processed (post-calculation) data to plot (in order observed, synthetic)</span>
    <span class="c1"># list of labels for each ratio (in order observed, synthetic)</span>
    <span class="n">survey_labels</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missions</span><span class="p">)],</span> <span class="p">[]]</span>
    <span class="c1"># list of available transitions in the data (in order observed, synthetic; used for debugging)</span>
    <span class="n">survey_transitions</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
    <span class="n">survey_lons</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>   <span class="c1"># list of data longitude (in order observed, synthetic)</span>
    <span class="n">survey_lats</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>   <span class="c1"># list of data lattitude (in order observed, synthetic)</span>
    <span class="n">survey_vels</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>   <span class="c1"># list of data velocities (in order observed, synthetic; 0 for 2D maps)</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;Planck&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">):</span>
        <span class="n">comp_type</span> <span class="o">=</span> <span class="s1">&#39;integrated&#39;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">survey</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">missions</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span>
        <span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_path</span> <span class="o">+</span> <span class="n">missions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/regridded/temp/&#39;</span> <span class="o">+</span> <span class="n">survey_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">survey_transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRANSL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)))</span>
            <span class="n">i_trans_obs</span> <span class="o">=</span> <span class="n">survey_transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">transitions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i_trans_obs</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid transition </span><span class="si">{}</span><span class="s1"> for file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">survey_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">return</span>
            <span class="n">survey_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]),</span>
                                              <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]))</span>
            <span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                              <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]),</span>
                                              <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">:</span>
                <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i_trans_obs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">:</span>
                <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i_trans_obs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Planck&#39;</span><span class="p">:</span>
                <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:])</span>
                <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;Planck&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">)</span> <span class="ow">or</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span>
                <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span>
                <span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                                  <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]),</span>
                                                  <span class="n">num</span><span class="o">=</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">survey_i_vel_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;Enter a valid string for `comp_type`: &#39;integrated&#39; for a 2D comparison of maps &#39;&#39;&#39;</span>
                      <span class="o">+</span> <span class="s1">&#39;&#39;&#39;and &#39;pv&#39; for a 3D comparison of spectroscopic data.&#39;&#39;&#39;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="s1">&#39;.idl&#39;</span> <span class="ow">in</span> <span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">survey_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">])</span>
            <span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">survey_transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i_trans_obs</span> <span class="o">=</span> <span class="n">cobe_idl_transitions</span> <span class="o">==</span> <span class="n">transitions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i_trans_obs</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">][:,</span> <span class="n">i_trans_obs</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.9979</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                                   <span class="o">*</span> <span class="p">(</span><span class="n">cobe_idl_linfrq</span><span class="p">[</span><span class="n">i_trans_obs</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">1.38</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">survey_i_lat_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid mission path </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">i_lon_obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i_lon_model</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i_lat_obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i_lat_model</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;Planck&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">)):</span>
        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">lat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lat_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">([</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">survey_i_lat_init</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
        <span class="n">lat_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">survey_i_lat_init</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span>
        <span class="n">vel_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">([</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">survey_i_vel_init</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
        <span class="n">vel_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">survey_i_vel_init</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>

    <span class="n">model_param_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_param</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">model_param_grid</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_param_grid</span><span class="p">))])</span>

    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model_params</span><span class="p">:</span>

        <span class="n">survey_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">))</span>
        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">model_path</span> <span class="o">+</span> <span class="n">survey_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;synthetic_intensity.fits&#39;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>

        <span class="c1"># Create arrays for the longitude and velocity axes of the synthetic observation if required</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">survey_lons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="c1"># if not (mission == &#39;COGAL&#39;):</span>
            <span class="c1">#     lon_model[lon_model&lt;0] += 360</span>
            <span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL4&#39;</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT4&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX4&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">),</span>
                            <span class="n">num</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS4&#39;</span><span class="p">]))</span>

        <span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">transition</span> <span class="o">==</span> <span class="s1">&#39;Dust&#39;</span><span class="p">:</span>
                <span class="n">survey_transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DUST&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)))</span>
                <span class="c1"># survey_maps[1][-1].append(deepcopy(model[2].data[0, :, :, 0]))</span>
                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">survey_transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SPECIES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)))</span>
                <span class="n">i_transition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">survey_transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">transition</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i_transition</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span>
                                               <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span> <span class="ow">or</span> <span class="s1">&#39;Planck&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">)):</span>
                    <span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">i_transition</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
                                                       <span class="c1"># - model[2].data[:, :, :, 0], survey_vels[1][0], axis=0))</span>
                                                       <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">i_transition</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">i_transition</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
                                              <span class="c1"># - model[2].data[:, :, :, 0])</span>
                                              <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Transition </span><span class="si">{}</span><span class="s1"> not found in model&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transition</span><span class="p">))</span>
                    <span class="k">return</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">i_lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">survey_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">survey_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">i_lon_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">survey_lons</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">survey_lons</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">i_lat_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lat_min</span><span class="p">)</span>
                                       <span class="o">&amp;</span> <span class="p">(</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lat_max</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">i_lat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                     <span class="o">&amp;</span> <span class="p">(</span><span class="n">survey_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">survey_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_lat_model</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;integrated&#39;</span><span class="p">:</span> <span class="c1">#compare 2D maps</span>
                    <span class="n">survey_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_obs</span><span class="p">))</span>
                    <span class="n">survey_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">comp_type</span> <span class="o">==</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="c1">#compare 3D maps</span>
                    <span class="n">i_vel_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">vel_min</span><span class="p">)</span>
                                           <span class="o">&amp;</span> <span class="p">(</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">vel_max</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">i_vel_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_vel_model</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                                         <span class="o">&amp;</span> <span class="p">(</span><span class="n">survey_vels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">survey_vels</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_vel_model</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">survey_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_vel_obs</span><span class="p">,</span> <span class="n">i_lat_obs</span><span class="p">,</span> <span class="n">i_lon_obs</span><span class="p">))</span>
                    <span class="n">survey_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i_vel_model</span><span class="p">,</span> <span class="n">i_lat_model</span><span class="p">,</span> <span class="n">i_lon_model</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">survey_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">survey_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                    <span class="n">survey_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">survey_ix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
        <span class="c1"># for i in range(len(survey_maps[1])):</span>
        <span class="n">survey_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">survey_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                <span class="n">survey_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">survey_ix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="mi">10</span><span class="p">)</span>
    <span class="c1">#fig, ax = plt.subplots(1, 1, figsize=figsize)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">survey_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">survey_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">log_comp</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="s1">&#39;_logT&#39;</span>
        <span class="n">i_nan_obs</span> <span class="o">=</span> <span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">survey_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="o">~</span><span class="n">i_nan_obs</span><span class="p">]),</span>
                <span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">survey_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">survey_ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]]</span>
        <span class="c1">#ax.boxplot(data, labels=labels, widths=boxwidth, notch=notch)</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$log_</span><span class="si">{10}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\left( \varpi_{&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
                     <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;} \right)$&#39;</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$log_</span><span class="si">{10}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\left( \varpi_{&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> \
                     <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;} \right)$&#39;</span>
        <span class="c1">#else:</span>
        <span class="c1">#    ax.set_xlabel(xlabel)</span>
        <span class="c1">#    ax.set_ylabel(ylabel)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">survey_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">survey_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1">#ax.boxplot(data, labels=labels, widths=boxwidth, notch=notch)</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\varpi_{&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}$&#39;</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;%\varpi_{&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;}$&#39;</span>
        <span class="c1">#else:</span>
        <span class="c1">#    ax.set_xlabel(xlabel)</span>
        <span class="c1">#    ax.set_ylabel(ylabel)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lines</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=</span><span class="n">cmax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ylim</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="c1">#xticknames = ax.get_xticklabels()</span>
        <span class="c1">#plt.setp(xticknames, rotation=label_rotation, fontsize=label_fontsize)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">transitions</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_file</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="c1">#filename = &#39;_&#39;.join(file_format.replace(&#39;/&#39;, &#39;&#39;).split(&#39;_&#39;)[1:]).replace(&#39;{}&#39;, &#39;_&#39;)</span>
                <span class="n">output_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">survey_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transitions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">current_output_file</span> <span class="o">=</span> <span class="s1">&#39;line_comp_</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">==&gt;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">output_args</span><span class="p">)</span> <span class="o">+</span> <span class="n">comp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_output_file</span> <span class="o">=</span> <span class="n">output_file</span> <span class="o">+</span> <span class="s1">&#39;==&gt;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">model_path</span> <span class="o">+</span> <span class="s1">&#39;fit_results/Plots/</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_output_file</span><span class="p">,</span> <span class="n">output_format</span><span class="p">),</span>
                        <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span></div>




<div class="viewcode-block" id="plot_comparison">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.comparison.model_selection.plot_comparison.html#kosmatau3d.comparison.model_selection.plot_comparison">[docs]</a>
<span class="k">def</span> <span class="nf">plot_comparison</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;/mnt/hpc_backup/yanitski/projects/pdr/KT3_history/MilkyWay/fit_results/&#39;</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">missions</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_param</span><span class="o">=</span><span class="p">[[]],</span> <span class="n">transitions</span><span class="o">=</span><span class="p">[],</span> <span class="n">i_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stat_lim</span><span class="o">=</span><span class="mf">1e100</span><span class="p">,</span> 
                    <span class="n">comp_type</span><span class="o">=</span><span class="s1">&#39;pv&#39;</span><span class="p">,</span> <span class="n">log_comp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">likelihood</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">contour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">cb_aspect</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                    <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">xrot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">yrot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">supxlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">supylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                    <span class="n">clabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">clabel_xa</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">clabel_ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">offset_idx</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">ax_aspect</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
                    <span class="n">pad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pad_left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_right</span><span class="o">=</span><span class="mf">0.125</span><span class="p">,</span> <span class="n">pad_bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_top</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot heatmaps of a test statistic to exaimine over model grid.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Check that the missions are specified properly.</span>
    <span class="k">if</span> <span class="n">missions</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">missions</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">missions</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">missions</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">missions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">missions</span> <span class="o">=</span> <span class="p">[</span><span class="n">missions</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">missions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Use both COBE instruments if simply &#39;COBE&#39; is specified</span>
        <span class="k">if</span> <span class="s1">&#39;COBE&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;COBE-FIRAS&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span> <span class="n">missions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;COBE-DIRBE&#39;</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span> <span class="n">missions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span>
            <span class="n">missions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;COBE-FIRAS&#39;</span><span class="p">)</span>
            <span class="n">missions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;COBE-DIRBE&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please specify a list of missions to compare the models.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">transitions_all</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">model_param</span> <span class="o">==</span> <span class="p">[[]]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please specify both file_format and model_param.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">log_comp</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">comp_type</span> <span class="o">+</span> <span class="s1">&#39;_logT&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">comp_type</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">clabel</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">likelihood</span><span class="p">:</span>
            <span class="n">clabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$log_</span><span class="si">{10}</span><span class="s1">(\mathcal</span><span class="si">{L}</span><span class="s1">)$&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\chi^2_\mathrm</span><span class="si">{min}</span><span class="s1">$&#39;</span>

    <span class="n">dimensions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_param</span><span class="p">)</span>
    <span class="n">naxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dimensions</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">naxis</span><span class="p">[[</span><span class="n">i_x</span><span class="p">,</span> <span class="n">i_y</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># print(model_param)</span>
    <span class="n">lenaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">model_param</span><span class="p">])</span>

    <span class="n">model_param_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_param</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="n">naxis</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">i_x</span> <span class="o">&lt;</span> <span class="n">i_y</span><span class="p">:</span>
        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">model_param_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="n">model_param_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">model_param_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="n">model_param_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">naxis</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sub_params</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">naxis</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">sub_params</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_param</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="o">~</span><span class="n">naxis</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sub_params</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_param</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="o">~</span><span class="n">naxis</span><span class="p">])))</span>

    <span class="c1"># Detemine the size of the subplot grid, for now allow a maximum of 2 additional parameters.</span>
    <span class="k">if</span> <span class="n">naxis</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sub_x</span><span class="p">,</span> <span class="n">sub_y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">naxis</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">sub_x</span> <span class="o">=</span> <span class="n">lenaxis</span><span class="p">[</span><span class="o">~</span><span class="n">naxis</span><span class="p">]</span>
        <span class="n">sub_y</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">naxis</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">sub_x</span><span class="p">,</span> <span class="n">sub_y</span> <span class="o">=</span> <span class="n">lenaxis</span><span class="p">[</span><span class="o">~</span><span class="n">naxis</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too many dimensions in grid.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Initialise the tick labels</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xticks</span><span class="p">):</span>
        <span class="n">xtick_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lenaxis</span><span class="p">[</span><span class="n">i_x</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">xticks</span><span class="p">))</span>
        <span class="n">xtick_labels</span> <span class="o">=</span> <span class="n">xticks</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xtick_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lenaxis</span><span class="p">[</span><span class="n">i_x</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">lenaxis</span><span class="p">[</span><span class="n">i_x</span><span class="p">])</span>
        <span class="n">xtick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">model_param</span><span class="p">[</span><span class="n">i_x</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yticks</span><span class="p">):</span>
        <span class="n">ytick_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lenaxis</span><span class="p">[</span><span class="n">i_y</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">yticks</span><span class="p">))</span>
        <span class="n">ytick_labels</span> <span class="o">=</span> <span class="n">yticks</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ytick_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lenaxis</span><span class="p">[</span><span class="n">i_y</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">lenaxis</span><span class="p">[</span><span class="n">i_y</span><span class="p">])</span>
        <span class="n">ytick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">model_param</span><span class="p">[</span><span class="n">i_y</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">contour</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xtick_base</span> <span class="o">+=</span> <span class="mf">0.5</span>
        <span class="n">ytick_base</span> <span class="o">+=</span> <span class="mf">0.5</span>

    <span class="c1"># Initialise likelihood and figure for plot analysing all missions</span>
    <span class="n">loglikelihood_overall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="o">*</span><span class="n">x_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sub_y</span><span class="p">,</span> <span class="n">sub_x</span><span class="p">))</span>
    <span class="n">overall_dof</span> <span class="o">=</span> <span class="mi">1</span><span class="c1">#0</span>
    <span class="n">fig_overall</span><span class="p">,</span> <span class="n">axes_overall</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">sub_y</span><span class="p">,</span> <span class="n">sub_x</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axes_overall</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">axes_overall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">axes_overall</span><span class="p">]])</span>
    <span class="k">elif</span> <span class="n">axes_overall</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes_overall</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">survey</span> <span class="ow">in</span> <span class="n">missions</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;Plots&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># if verbose:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;_files&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;_files&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">survey_files</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;_files&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;_files&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">survey_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;_files&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Incorrect files specified for survey </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey</span><span class="p">))</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">survey_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;Plots&#39;</span> <span class="ow">in</span> <span class="n">survey_files</span><span class="p">:</span>
            <span class="n">survey_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;Plots&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;Plots&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/Plots/&#39;</span><span class="p">)</span>

        <span class="n">file_transitions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">file_transition_plots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">file_transition_log_likelihood</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;survey files: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey_files</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">figsize</span><span class="p">:</span>
            <span class="n">subgrid_aspect</span> <span class="o">=</span> <span class="n">sub_x</span><span class="o">/</span><span class="n">sub_y</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">subgrid_aspect</span><span class="o">*</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">sub_y</span><span class="p">,</span> <span class="n">sub_x</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">axes</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">axes</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sub_params</span><span class="p">):</span>

            <span class="c1"># Calculate likelihood</span>
            <span class="c1"># --------------------</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

            <span class="n">survey_dof</span> <span class="o">=</span> <span class="mi">1</span><span class="c1">#0</span>
            <span class="n">file_dof</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="c1">#[0] * len(survey_files)</span>

            <span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">survey_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">survey_files</span><span class="p">):</span>

                <span class="k">if</span> <span class="s1">&#39;.png&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span> <span class="ow">or</span> <span class="s1">&#39;Plots&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span> <span class="ow">or</span> <span class="s1">&#39;.npy&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span> \
                        <span class="ow">or</span> <span class="s1">&#39;.npz&#39;</span> <span class="ow">in</span> <span class="n">survey_file</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">survey_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">{}</span><span class="s1"> not available for survey </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">survey_file</span><span class="p">,</span> <span class="n">survey</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">survey_file</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitions_all</span><span class="p">):</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">transitions_all</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">transitions</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">survey_file</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">copy</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s1">&#39;.npy&#39;</span> <span class="ow">in</span> <span class="n">_</span> <span class="ow">or</span> <span class="s1">&#39;.npz&#39;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">:</span>
                            <span class="n">transitions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
                    <span class="c1">#if f&#39;{output_file}_comparison.npy&#39; in transitions:</span>
                    <span class="c1">#    transitions.remove(f&#39;{output_file}_comparison.npy&#39;)</span>

                    <span class="n">transitions_skipped</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">copy</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">survey_file</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">transitions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                            <span class="n">transitions_skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  transitions compared: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">  transitions skipped: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitions</span><span class="p">,</span>
                                                                                                 <span class="n">transitions_skipped</span><span class="p">))</span>
                <span class="n">file_transitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">transitions</span><span class="p">))</span>
                <span class="c1">#survey_dof += len(transitions)</span>
                <span class="c1">#file_dof[f] = len(transitions)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitions_skipped</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  transitions </span><span class="si">{}</span><span class="s1"> not available.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">transitions_skipped</span><span class="p">)))</span>

                <span class="n">transition_plots</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">transition_log_likelihood</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
                    <span class="n">t_fig</span><span class="p">,</span> <span class="n">t_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">sub_y</span><span class="p">,</span> <span class="n">sub_x</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="n">t_axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">t_axes</span><span class="p">]])</span>
                    <span class="k">elif</span> <span class="n">t_axes</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">t_axes</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">transition_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">copy</span><span class="p">(</span><span class="n">t_fig</span><span class="p">),</span> <span class="n">copy</span><span class="p">(</span><span class="n">t_axes</span><span class="p">)))</span>
                    <span class="n">transition_log_likelihood</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">t_fig</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">log_likelihood</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">log_likelihood</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

                        <span class="n">file_format_param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">naxis</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
                        <span class="n">file_format_param</span><span class="p">[</span><span class="n">i_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                        <span class="n">file_format_param</span><span class="p">[</span><span class="n">i_y</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">file_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">file_format_param</span><span class="p">)</span> \
                                  <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">_chi2.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">naxis</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">file_format_param</span><span class="p">[</span><span class="o">~</span><span class="n">naxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
                        <span class="k">if</span> <span class="n">likelihood</span><span class="p">:</span>
                            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">file_format_param</span><span class="p">)</span> \
                                       <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">_loglikelihood.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_type</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">file_format_param</span><span class="p">)</span> \
                                       <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">_chi2.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
                            <span class="c1"># filename = file_format.format(x_grid[i, j], y_grid[i, j]) \</span>
                            <span class="c1">#            + &#39;_{}_loglikelihood.npy&#39;.format(comp_type)</span>
                        <span class="n">param_log_likelihood</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">survey_file</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                                                            <span class="n">t</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">]</span>
                        <span class="c1"># filter out unnecessary pixels</span>
                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_log_likelihood</span><span class="p">)):</span>
                            <span class="n">param_log_likelihood</span><span class="p">[</span><span class="n">_</span><span class="p">][</span><span class="n">param_log_likelihood</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="n">param_log_likelihood</span><span class="p">[</span><span class="n">_</span><span class="p">][</span><span class="n">param_log_likelihood</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">stat_lim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">log_likelihood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_likelihood</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">param_log_likelihood</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transitions</span><span class="p">)):</span>
                            <span class="n">transition_log_likelihood</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition_log_likelihood</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> \
                                                                 <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">param_log_likelihood</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

                <span class="n">file_transition_plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">transition_plots</span><span class="p">))</span>
                <span class="n">file_transition_log_likelihood</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">transition_log_likelihood</span><span class="p">))</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}{</span><span class="n">survey</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">survey_file</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">output_file</span><span class="si">}</span><span class="s1">_comparison.npz&#39;</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="n">file_transitions</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">file_transition_log_likelihood</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">log_likelihood</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">log_likelihood</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">log_likelihood</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">log_likelihood</span> <span class="o">/</span> <span class="n">log_likelihood</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">survey_files</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_transitions</span><span class="p">[</span><span class="n">f</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">log_likelihood</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> \
                                                                   <span class="o">/</span> <span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> \
                                                                   <span class="o">/</span> <span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">log_likelihood</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="o">-</span><span class="n">log_likelihood</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">survey_files</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_transitions</span><span class="p">[</span><span class="n">f</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="o">-</span><span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>

            <span class="c1"># Plot subplots</span>
            <span class="c1"># -------------</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sub_indeces</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_param</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="o">~</span><span class="n">naxis</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
                <span class="n">x_param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y_param</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">elif</span> <span class="n">axes</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sub_indeces</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span>
                                    <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_param</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="o">~</span><span class="n">naxis</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">x_param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">y_param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sub_indeces</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">x_param</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">y_param</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="c1"># Add likelihood in overall array</span>
            <span class="n">loglikelihood_overall</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">sub_indeces</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sub_indeces</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> \
                <span class="o">=</span> <span class="n">loglikelihood_overall</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">sub_indeces</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sub_indeces</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">log_likelihood</span>
            
            <span class="c1"># Update overall degrees of freedom</span>
            <span class="c1">#overall_dof += np.sum(file_dof)</span>

            <span class="c1"># Minimum chi^2</span>
            <span class="n">minval</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_likelihood</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">file_dof</span><span class="p">))</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="c1"># minval = np.around(minval/(10**np.floor(np.log10(minval))), 3) * 10**np.floor(np.log10(minval))</span>

            <span class="k">if</span> <span class="n">contour</span><span class="p">:</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">((</span><span class="n">log_likelihood</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">file_dof</span><span class="p">)</span><span class="o">-</span><span class="n">minval</span><span class="p">)</span><span class="o">/</span><span class="n">minval</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">log_likelihood</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">file_dof</span><span class="p">),</span>
                                              <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lenaxis</span><span class="p">[</span><span class="n">i_x</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lenaxis</span><span class="p">[</span><span class="n">i_y</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="n">lenaxis</span><span class="p">[</span><span class="n">i_x</span><span class="p">]</span><span class="o">/</span><span class="n">ax_aspect</span><span class="o">/</span><span class="n">lenaxis</span><span class="p">[</span><span class="n">i_y</span><span class="p">])</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="n">fraction</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">cb_aspect</span><span class="p">)</span>
            <span class="c1"># cb.ax.ticklabel_format(useOffset=minval, style=&#39;plain&#39;, useMathText=True)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">,</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#cb.ax.yaxis.offsetText.set_text(&#39;&#39;)</span>
            <span class="c1">#offsetx, offsety = cb.ax.yaxis.offsetText.get_position()</span>
            <span class="c1"># axes[sub_indeces].text(1.1, 1.0, f&#39;{cb.ax.yaxis.major.formatter.offset:1.3e}&#39;, transform=axes[sub_indeces].transAxes, fontsize=labelsize, ha=&#39;left&#39;, va=&#39;bottom&#39;)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">*</span><span class="n">offset_idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">minval</span><span class="si">:</span><span class="s1">1.3e</span><span class="si">}</span><span class="s1"> +&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
            <span class="c1">#cb.ax.yaxis.major.formatter.set_useOffset(False)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span>
            <span class="c1">#cb.ax.yaxis.offsetText.set_fontsize(labelsize)</span>
            <span class="c1">#cb.ax.yaxis.offsetText.set_ha(&#39;left&#39;)</span>
            <span class="c1">#cb.ax.yaxis.offsetText.set_va(&#39;bottom&#39;)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;face&quot;</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1e-16</span><span class="p">)</span>

            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xtick_base</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xtick_labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">xrot</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ytick_base</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ytick_labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">yrot</span><span class="p">)</span>
            <span class="c1"># if contour:</span>
                <span class="c1"># axes[sub_indeces].set_xticks(np.arange(lenaxis[i_x]))</span>
                <span class="c1"># axes[sub_indeces].set_xticklabels([str(par) for par in model_param[i_x]])</span>
                <span class="c1"># axes[sub_indeces].set_yticks(np.arange(lenaxis[i_y]))</span>
                <span class="c1"># axes[sub_indeces].set_yticklabels([str(par) for par in model_param[i_y]])</span>
            <span class="c1"># else:</span>
                <span class="c1"># axes[sub_indeces].set_xticks(np.arange(lenaxis[i_x])+0.5)</span>
                <span class="c1"># axes[sub_indeces].set_xticklabels([str(par) for par in model_param[i_x]])</span>
                <span class="c1"># axes[sub_indeces].set_yticks(np.arange(lenaxis[i_y])+0.5)</span>
                <span class="c1"># axes[sub_indeces].set_yticklabels([str(par) for par in model_param[i_y][::-1]])</span>

            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">axes</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">supylabel</span><span class="p">,</span> <span class="n">y_param</span><span class="p">,</span> <span class="n">supxlabel</span><span class="p">,</span> <span class="n">x_param</span><span class="p">),</span>
                                            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
            <span class="c1"># cb.ax.set_ylabel(clabel, fontsize=fontsize-4)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File transitions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_transitions</span><span class="p">))</span>

            <span class="c1"># For parameter comparisons split by transition and survey</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">survey_files</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_transitions</span><span class="p">[</span><span class="n">f</span><span class="p">])):</span>
                    
                    <span class="c1"># Minimum chi^2</span>
                    <span class="n">minval</span> <span class="o">=</span> <span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="c1"># minval = np.around(minval/(10**np.floor(np.log10(minval))), 3) * 10**np.floor(np.log10(minval))</span>

                    <span class="k">if</span> <span class="n">contour</span><span class="p">:</span>
                        <span class="n">cm</span> <span class="o">=</span> <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">((</span><span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">-</span><span class="n">minval</span><span class="p">)</span><span class="o">/</span><span class="n">minval</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
                                                                                  <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cm</span> <span class="o">=</span> <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">file_transition_log_likelihood</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">],</span>
                                                                                <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lenaxis</span><span class="p">[</span><span class="n">i_x</span><span class="p">],</span>
                                                                                        <span class="mi">0</span><span class="p">,</span> <span class="n">lenaxis</span><span class="p">[</span><span class="n">i_y</span><span class="p">]],</span>
                                                                                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="n">lenaxis</span><span class="p">[</span><span class="n">i_x</span><span class="p">]</span><span class="o">/</span><span class="n">ax_aspect</span><span class="o">/</span><span class="n">lenaxis</span><span class="p">[</span><span class="n">i_y</span><span class="p">])</span>
                    <span class="n">cb</span> <span class="o">=</span> <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">],</span>
                                                                 <span class="n">fraction</span><span class="o">=</span><span class="n">fraction</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">cb_aspect</span><span class="p">)</span>
                    <span class="c1"># cb.ax.ticklabel_format(useOffset=minval, style=&#39;plain&#39;, useMathText=True)</span>
                    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">,</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1">#cb.ax.yaxis.offsetText.set_text(&#39;&#39;)</span>
                    <span class="c1">#offsetx, offsety = cb.ax.yaxis.offsetText.get_position()</span>
                    <span class="c1"># cb.ax.text(-1.5, 1.0, f&#39;{cb.ax.yaxis.major.formatter.offset:1.3e}&#39;, fontsize=labelsize, ha=&#39;center&#39;, va=&#39;bottom&#39;)</span>
                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">*</span><span class="n">offset_idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">minval</span><span class="si">:</span><span class="s1">1.3e</span><span class="si">}</span><span class="s1"> +&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> 
                                                                     <span class="n">fontsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
                    <span class="c1">#cb.ax.yaxis.major.formatter.set_useOffset(False)</span>
                    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span>
                    <span class="c1">#cb.ax.yaxis.offsetText.set_fontsize(labelsize)</span>
                    <span class="c1">#cb.ax.yaxis.offsetText.set_ha(&#39;left&#39;)</span>
                    <span class="c1">#cb.ax.yaxis.offsetText.set_va(&#39;bottom&#39;)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;face&quot;</span><span class="p">)</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1e-16</span><span class="p">)</span>

                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xtick_base</span><span class="p">)</span>
                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xtick_labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">xrot</span><span class="p">)</span>
                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ytick_base</span><span class="p">)</span>
                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ytick_labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">yrot</span><span class="p">)</span>
                    <span class="c1"># if contour:</span>
                    <span class="c1">#     file_transition_plots[f][t][1][sub_indeces].set_xticks(np.arange(lenaxis[i_x]))</span>
                    <span class="c1">#     file_transition_plots[f][t][1][sub_indeces].set_xticklabels([str(param) for</span>
                    <span class="c1">#                                                                  param in model_param[i_x]])</span>
                    <span class="c1">#     file_transition_plots[f][t][1][sub_indeces].set_yticks(np.arange(lenaxis[i_y]))</span>
                    <span class="c1">#     file_transition_plots[f][t][1][sub_indeces].set_yticklabels([str(param) for</span>
                    <span class="c1">#                                                                  param in model_param[i_y]])</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     file_transition_plots[f][t][1][sub_indeces].set_xticks(np.arange(lenaxis[i_x])+0.5)</span>
                    <span class="c1">#     file_transition_plots[f][t][1][sub_indeces].set_xticklabels([str(param) for</span>
                    <span class="c1">#                                                                  param in model_param[i_x]])</span>
                    <span class="c1">#     file_transition_plots[f][t][1][sub_indeces].set_yticks(np.arange(lenaxis[i_y])+0.5)</span>
                    <span class="c1">#     file_transition_plots[f][t][1][sub_indeces].set_yticklabels([str(param) for</span>
                    <span class="c1">#                                                                  param in model_param[i_y][::-1]])</span>

                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span>
                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">supylabel</span><span class="p">,</span> <span class="n">y_param</span><span class="p">,</span>
                                                                                                    <span class="n">supxlabel</span><span class="p">,</span> <span class="n">x_param</span><span class="p">),</span>
                                                                              <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">likelihood</span><span class="p">:</span>
                <span class="n">suptitle</span> <span class="o">=</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39; likelihood&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">suptitle</span> <span class="o">=</span> <span class="n">survey</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39; $\chi^2$&#39;</span>
            <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
                <span class="n">suptitle</span> <span class="o">+=</span> <span class="s1">&#39;, normalised&#39;</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">suptitle</span> <span class="o">+=</span> <span class="s1">&#39;, logged&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suptitle</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">clabel</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clabel</span> <span class="o">=</span> <span class="s1">&#39;Value&#39;</span>
        <span class="c1"># fig.supylabel(clabel, x=clabel_xa, ha=clabel_ha, fontsize=fontsize)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">clabel_xa</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">clabel</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">clabel_ha</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">suptitle</span><span class="p">:</span>
            <span class="n">fig_top</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pad</span><span class="o">*</span><span class="n">pad_top</span>
        <span class="k">if</span> <span class="n">clabel</span><span class="p">:</span>
            <span class="n">fig_right</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pad</span><span class="o">*</span><span class="n">pad_right</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">pad</span><span class="o">*</span><span class="n">pad_left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">fig_right</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">pad</span><span class="o">*</span><span class="n">pad_bottom</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">fig_top</span><span class="p">,</span>
                            <span class="n">wspace</span><span class="o">=</span><span class="n">wspace</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="n">hspace</span><span class="p">)</span>
        <span class="c1"># fig.tight_layout(pad=pad)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_file</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">output_file</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">output_file</span> <span class="o">=</span> <span class="n">file_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">likelihood</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/Plots/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_loglikelihood.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">output_format</span><span class="p">),</span>
                            <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/Plots/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_chi2.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">output_format</span><span class="p">),</span>
                            <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="c1"># For parameter comparisons split by transition and survey</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">survey_files</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_transitions</span><span class="p">[</span><span class="n">f</span><span class="p">])):</span>

                <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">likelihood</span><span class="p">:</span>
                        <span class="n">suptitle</span> <span class="o">=</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">file_transitions</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; likelihood&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">suptitle</span> <span class="o">=</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">file_transitions</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39; $\chi^2$&#39;</span>
                    <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
                        <span class="n">suptitle</span> <span class="o">+=</span> <span class="s1">&#39;, normalised&#39;</span>
                    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                        <span class="n">suptitle</span> <span class="o">+=</span> <span class="s1">&#39;, logged&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">suptitle</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">clabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">clabel</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">clabel</span> <span class="o">=</span> <span class="s1">&#39;Value&#39;</span>
                <span class="c1"># file_transition_plots[f][t][0].supylabel(clabel, x=clabel_xa, ha=clabel_ha, fontsize=fontsize)</span>
                <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">clabel_xa</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">clabel</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">clabel_ha</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">suptitle</span><span class="p">:</span>
                    <span class="n">fig_top</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pad</span><span class="o">*</span><span class="n">pad_top</span>
                <span class="k">if</span> <span class="n">clabel</span><span class="p">:</span>
                    <span class="n">fig_right</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pad</span><span class="o">*</span><span class="n">pad_right</span>
                <span class="c1"># file_transition_plots[f][t][0].tick_params(labelsize=labelsize)</span>
                <span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">pad</span><span class="o">*</span><span class="n">pad_left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">fig_right</span><span class="p">,</span>
                                                               <span class="n">bottom</span><span class="o">=</span><span class="n">pad</span><span class="o">*</span><span class="n">pad_bottom</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">fig_top</span><span class="p">,</span>
                                                               <span class="n">wspace</span><span class="o">=</span><span class="n">wspace</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="n">hspace</span><span class="p">)</span>
                <span class="c1"># file_transition_plots[f][t][0].tight_layout()</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">output_file</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">output_file</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">output_file</span> <span class="o">=</span> <span class="n">file_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">likelihood</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/Plots/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_loglikelihood.</span><span class="si">{}</span><span class="s1">&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">file_transitions</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span>
                                            <span class="n">comp</span><span class="p">,</span> <span class="n">output_format</span><span class="p">),</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">survey</span> <span class="o">+</span> <span class="s1">&#39;/Plots/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_chi2.</span><span class="si">{}</span><span class="s1">&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">file_transitions</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span>
                                            <span class="n">comp</span><span class="p">,</span> <span class="n">output_format</span><span class="p">),</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">file_transition_plots</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">t</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># For parameter comparisons including all transitions/surveys</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sub_params</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sub_indeces</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_param</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="o">~</span><span class="n">naxis</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
            <span class="n">x_param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_param</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">axes</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sub_indeces</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">arr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">model_param</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="o">~</span><span class="n">naxis</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x_param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y_param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sub_indeces</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">x_param</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">y_param</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># minimum chi^2</span>
        <span class="n">minval</span> <span class="o">=</span> <span class="p">(</span><span class="n">loglikelihood_overall</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">sub_indeces</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sub_indeces</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">/</span><span class="n">overall_dof</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="c1"># minval = np.around(minval/(10**np.floor(np.log10(minval))), 3) * 10**np.floor(np.log10(minval))</span>
        
        <span class="k">if</span> <span class="n">contour</span><span class="p">:</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">((</span><span class="n">loglikelihood_overall</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">sub_indeces</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sub_indeces</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                                                     <span class="o">/</span> <span class="n">overall_dof</span> <span class="o">-</span> <span class="n">minval</span><span class="p">)</span><span class="o">/</span><span class="n">minval</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">loglikelihood_overall</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">sub_indeces</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sub_indeces</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                                                  <span class="o">/</span> <span class="n">overall_dof</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lenaxis</span><span class="p">[</span><span class="n">i_x</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lenaxis</span><span class="p">[</span><span class="n">i_y</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="n">lenaxis</span><span class="p">[</span><span class="n">i_x</span><span class="p">]</span><span class="o">/</span><span class="n">ax_aspect</span><span class="o">/</span><span class="n">lenaxis</span><span class="p">[</span><span class="n">i_y</span><span class="p">])</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">fig_overall</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="n">fraction</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">cb_aspect</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">,</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#cb.ax.yaxis.offsetText.set_text(&#39;&#39;)</span>
        <span class="c1">#offsetx, offsety = cb.ax.yaxis.offsetText.get_position()</span>
        <span class="c1"># cb.ax.text(-1.5, 1.0, f&#39;{cb.ax.yaxis.major.formatter.offset:1.3e}&#39;, fontsize=labelsize, ha=&#39;center&#39;, va=&#39;bottom&#39;)</span>
        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">*</span><span class="n">offset_idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">minval</span><span class="si">:</span><span class="s1">1.3e</span><span class="si">}</span><span class="s1"> +&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="c1">#cb.ax.yaxis.major.formatter.set_useOffset(False)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span>
        <span class="c1">#cb.ax.yaxis.offsetText.set_fontsize(labelsize)</span>
        <span class="c1">#cb.ax.yaxis.offsetText.set_ha(&#39;left&#39;)</span>
        <span class="c1">#cb.ax.yaxis.offsetText.set_va(&#39;bottom&#39;)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;face&quot;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1e-16</span><span class="p">)</span>

        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xtick_base</span><span class="p">)</span>
        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xtick_labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">xrot</span><span class="p">)</span>
        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ytick_base</span><span class="p">)</span>
        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ytick_labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">yrot</span><span class="p">)</span>
        <span class="c1"># if contour:</span>
        <span class="c1">#     axes_overall[sub_indeces].set_xticks(np.arange(lenaxis[i_x]))</span>
        <span class="c1">#     axes_overall[sub_indeces].set_xticklabels([str(param) for param in model_param[i_x]])</span>
        <span class="c1">#     axes_overall[sub_indeces].set_yticks(np.arange(lenaxis[i_y]))</span>
        <span class="c1">#     axes_overall[sub_indeces].set_yticklabels([str(param) for param in model_param[i_y]])</span>
        <span class="c1"># else:</span>
        <span class="c1">#     axes_overall[sub_indeces].set_xticks(np.arange(lenaxis[i_x]) + 0.5)</span>
        <span class="c1">#     axes_overall[sub_indeces].set_xticklabels([str(param) for param in model_param[i_x]])</span>
        <span class="c1">#     axes_overall[sub_indeces].set_yticks(np.arange(lenaxis[i_y]) + 0.5)</span>
        <span class="c1">#     axes_overall[sub_indeces].set_yticklabels([str(param) for param in model_param[i_y][::-1]])</span>

        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span>
        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axes_overall</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes_overall</span><span class="p">[</span><span class="n">sub_indeces</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">supylabel</span><span class="p">,</span> <span class="n">y_param</span><span class="p">,</span> <span class="n">supxlabel</span><span class="p">,</span> <span class="n">x_param</span><span class="p">),</span>
                                                <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">likelihood</span><span class="p">:</span>
            <span class="n">suptitle</span> <span class="o">=</span> <span class="s1">&#39;Total (all lines/missions) likelihood&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suptitle</span> <span class="o">=</span> <span class="s1">&#39;Total (all lines/missions) &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\chi^2$&#39;</span>
        <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
            <span class="n">suptitle</span> <span class="o">+=</span> <span class="s1">&#39;, normalised&#39;</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">suptitle</span> <span class="o">+=</span> <span class="s1">&#39;, logged&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">suptitle</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">fig_overall</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">clabel</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clabel</span> <span class="o">=</span> <span class="s1">&#39;Value&#39;</span>
    <span class="c1"># fig_overall.supylabel(clabel, x=clabel_xa, ha=clabel_ha, fontsize=fontsize)</span>
    <span class="n">fig_overall</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">clabel_xa</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">clabel</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">clabel_ha</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">suptitle</span><span class="p">:</span>
        <span class="n">fig_top</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pad</span> <span class="o">*</span> <span class="n">pad_top</span>
    <span class="k">if</span> <span class="n">clabel</span><span class="p">:</span>
        <span class="n">fig_right</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pad</span> <span class="o">*</span> <span class="n">pad_right</span>
    <span class="n">fig_overall</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">pad</span> <span class="o">*</span> <span class="n">pad_left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">fig_right</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">pad</span> <span class="o">*</span> <span class="n">pad_bottom</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">fig_top</span><span class="p">,</span>
                                <span class="n">wspace</span><span class="o">=</span><span class="n">wspace</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="n">hspace</span><span class="p">)</span>
    <span class="c1"># fig_overall.tight_layout(pad=pad)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig_overall</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;Plots&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/Plots/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_file</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">output_file</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">file_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">likelihood</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/Plots/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_loglikelihood.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">output_format</span><span class="p">),</span>
                        <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/Plots/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_chi2.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">output_format</span><span class="p">),</span>
                        <span class="nb">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

    <span class="k">return</span></div>


</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2023, Craig Yanitski.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>