<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>kosmatau3d.models.voxel &mdash; kosmatau3d 1.0.3 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/readthedocs-custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/documentation_options.js?v=baaebd52"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            kosmatau3d
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Sections:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../properties.html">Clump Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voxel.html">Voxels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model.html">3D Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../comparison.html">Comparison to Observations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Future Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/kosmatau3d.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acknowledgements.html">Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">kosmatau3d</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../models.html">kosmatau3d.models</a></li>
      <li class="breadcrumb-item active">kosmatau3d.models.voxel</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for kosmatau3d.models.voxel</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">A module containing the :code:`Voxel` class.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">importlib</span> <span class="k">as</span> <span class="nn">il</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">getLogger</span><span class="p">,</span> <span class="n">DEBUG</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="n">WARNING</span>

<span class="kn">from</span> <span class="nn">kosmatau3d.models</span> <span class="kn">import</span> <span class="p">(</span>
  <span class="n">constants</span><span class="p">,</span>
  <span class="n">interpolations</span><span class="p">,</span>
  <span class="n">observations</span><span class="p">,</span>
  <span class="n">species</span><span class="p">,</span>
  <span class="n">ensemble</span><span class="p">,</span>
  <span class="n">combinations</span><span class="p">,</span>
  <span class="n">masspoints</span><span class="p">)</span>


<div class="viewcode-block" id="Voxel">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel">[docs]</a>
<span class="k">class</span> <span class="nc">Voxel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is a class to handle each voxel in KOSMA-tau^3. It contains ensembles</span>
<span class="sd">    of spherical PDR simulations (to mimic the fractal structure of PDRs), a FUV</span>
<span class="sd">    field element, and element absorption, separated for dust and transitions. It</span>
<span class="sd">    should have one clump ensemble and one interclump ensemble. This is to account</span>
<span class="sd">    for the diffuse surroundings of a clump.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># PRIVATE</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debugging</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
      
        <span class="bp">self</span><span class="o">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">index</span>  <span class="c1"># index of voxel in VoxelGrid, sort of like its ID in the overall model</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__debugging</span> <span class="o">=</span> <span class="n">debugging</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># velocity of mass at voxel point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_dispersion</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># dispersion of velocity at voxel point</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__hi_mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__h2_mass</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocity_indeces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__model_mass</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># intensity of species transitions in voxel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># optical depth of species transitions in voxel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># intensity of dust continuum in voxel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># optical depth of dust continuum in voxel</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__fuv</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__taufuv</span> <span class="o">=</span> <span class="mf">0.</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__z</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__r</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__phi</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># testing flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_calc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_opacity</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_pexp</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_fv</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span>
  
    <span class="k">def</span> <span class="nf">__set_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clump_mass</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
  
    <span class="k">def</span> <span class="nf">__set_clump_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="p">[</span><span class="n">interpolations</span><span class="o">.</span><span class="n">interpolate_h2_mass</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">interpolations</span><span class="o">.</span><span class="n">interpolate_hi_mass</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__clump_mass</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_factor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span>
  
    <span class="k">def</span> <span class="nf">__setVelocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">velocity</span> <span class="o">=</span> <span class="n">interpolations</span><span class="o">.</span><span class="n">interpolate_galaxy_rotation</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">from_earth</span><span class="p">:</span>
    
            <span class="c1"># Calculate the correction to the voxel velocity vectors</span>
            <span class="n">relativeRpol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__x</span><span class="o">-</span><span class="n">constants</span><span class="o">.</span><span class="n">r_gal_earth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">__y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">relativePhi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__x</span><span class="o">-</span><span class="n">constants</span><span class="o">.</span><span class="n">r_gal_earth</span><span class="p">)</span>
            <span class="n">relativeSigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__r</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">relativeRpol</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">constants</span><span class="o">.</span><span class="n">r_gal_earth</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                                      <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__r</span><span class="o">*</span><span class="n">relativeRpol</span><span class="p">))</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__z</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__x</span><span class="o">-</span><span class="n">constants</span><span class="o">.</span><span class="n">r_gal_earth</span><span class="p">))</span>
      
            <span class="c1"># Correct the relative velocity of the voxel</span>
            <span class="n">velocityEarth</span> <span class="o">=</span> <span class="n">interpolations</span><span class="o">.</span><span class="n">interpolate_galaxy_rotation</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">r_gal_Earth</span><span class="p">)</span>
            <span class="n">velocityCirc</span> <span class="o">=</span> <span class="n">velocity</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">velocityEarth</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__r</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">r_gal_earth</span>
      
            <span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">relativePhi</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocityCirc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">relativeSigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
      
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># self.__velocity = (velocity.mean()) * np.sin(self.__phi)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
    
        <span class="c1"># Use this to check the evaluation of the velocity field. It is still not working correctly...</span>
        <span class="c1"># print(self.__velocity)</span>
    
        <span class="n">ensembleDispersion</span> <span class="o">=</span> <span class="n">interpolations</span><span class="o">.</span><span class="n">interpolate_velocity_dispersion</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_dispersion</span> <span class="o">=</span> <span class="n">ensembleDispersion</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">return</span>
  
    <span class="k">def</span> <span class="nf">__set_ensemble_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">density</span> <span class="o">=</span> <span class="n">interpolations</span><span class="o">.</span><span class="n">interpolate_number_density</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_density</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">density_factor</span><span class="o">*</span><span class="n">density</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span>
  
    <span class="k">def</span> <span class="nf">__set_taufuv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__taufuv</span> <span class="o">=</span> <span class="n">interpolations</span><span class="o">.</span><span class="n">interpolate_taufuv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensembleDensity</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">__clumpMass</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">__interclumpMass</span><span class="p">)</span>
        <span class="k">return</span>
  
    <span class="k">def</span> <span class="nf">__set_fuv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This is in units of the Draine field</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fuv</span> <span class="o">=</span> <span class="n">interpolations</span><span class="o">.</span><span class="n">interpolate_fuv</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">u_draine0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fuv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">fuv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1">#self.__fuv = FUVfield(fuv)</span>
        <span class="k">return</span>
  
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;Voxel </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__index</span><span class="p">)</span>

    <span class="c1"># PUBLIC</span>
  
    <span class="c1"># def reloadModules(self):</span>
    <span class="c1">#   il.reload(Ensemble)</span>
    <span class="c1">#   il.reload(FUVfield)</span>
    <span class="c1">#   self.__clump.reloadModules()</span>
    <span class="c1">#   self.__interclump.reloadModules()</span>
    <span class="c1">#   return</span>
  
<div class="viewcode-block" id="Voxel.set_index">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.set_index">[docs]</a>
    <span class="k">def</span> <span class="nf">set_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">return</span></div>

  
<div class="viewcode-block" id="Voxel.get_index">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_index">[docs]</a>
    <span class="k">def</span> <span class="nf">get_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__index</span></div>

  
<div class="viewcode-block" id="Voxel.set_position">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.set_position">[docs]</a>
    <span class="k">def</span> <span class="nf">set_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__phi</span> <span class="o">=</span> <span class="n">phi</span>
        <span class="k">return</span></div>

  
<div class="viewcode-block" id="Voxel.get_fuv">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_fuv">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fuv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fuv</span></div>

  
<div class="viewcode-block" id="Voxel.set_properties">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.set_properties">[docs]</a>
    <span class="k">def</span> <span class="nf">set_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">voxel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transitions</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">dust</span><span class="o">=</span><span class="s1">&#39;PAH&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.84</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">2.31</span><span class="p">,</span> 
                       <span class="n">clump_tau_grid_file</span><span class="o">=</span><span class="s1">&#39;clump_tau_LineCenter.dat&#39;</span><span class="p">,</span> 
                       <span class="n">clump_tb_grid_file</span><span class="o">=</span><span class="s1">&#39;clump_Tmb_LineCenter.dat&#39;</span><span class="p">,</span> 
                       <span class="n">clump_taufuv_grid_file</span><span class="o">=</span><span class="s1">&#39;RhoMassAFUV.dat&#39;</span><span class="p">,</span>
                       <span class="n">clump_column_density_file</span><span class="o">=</span><span class="s1">&#39;clumpMeanCols.dat&#39;</span><span class="p">,</span>
                       <span class="n">clump_temperature_file</span><span class="o">=</span><span class="s1">&#39;clumpTemperatures_filled.dat&#39;</span><span class="p">,</span>
                       <span class="n">interclump_tau_grid_file</span><span class="o">=</span><span class="s1">&#39;interclumpTauLineCenter.dat&#39;</span><span class="p">,</span> 
                       <span class="n">interclump_dust_tau_grid_file</span><span class="o">=</span><span class="s1">&#39;interclumpDustTau.dat&#39;</span><span class="p">,</span> 
                       <span class="n">interclump_tb_grid_file</span><span class="o">=</span><span class="s1">&#39;interclumpTmbLineCenter.dat&#39;</span><span class="p">,</span> 
                       <span class="n">interclump_dust_tb_grid_file</span><span class="o">=</span><span class="s1">&#39;interclumpDustSED.dat&#39;</span><span class="p">,</span> 
                       <span class="n">interclump_taufuv_grid_file</span><span class="o">=</span><span class="s1">&#39;interclumpTauFUV.dat&#39;</span><span class="p">,</span>
                       <span class="n">interclump_column_density_file</span><span class="o">=</span><span class="s1">&#39;interclumpMeanCols.dat&#39;</span><span class="p">,</span>
                       <span class="n">interclump_temperature_file</span><span class="o">=</span><span class="s1">&#39;interclumpTemperatures_filled.dat&#39;</span><span class="p">,</span>
                       <span class="n">abundances</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ELECTR&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="s1">&#39;H+&#39;</span><span class="p">],</span> 
                       <span class="n">clump_mass_number</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">clump_mass_range</span><span class="o">=</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">3</span><span class="p">]),</span> <span class="n">clump_n_max</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> 
                       <span class="n">interclump_idx</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span> <span class="n">interclump_wnm_idx</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> 
                       <span class="n">velocity_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">velocity_number</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> 
                       <span class="n">velocity</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">velocity_resolution</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                       <span class="n">ensemble_mass</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">40</span><span class="p">),</span> <span class="n">ensemble_dispersion</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                       <span class="n">volume_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voxel_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ensemble_density</span><span class="o">=</span><span class="p">(</span><span class="mf">1e5</span><span class="p">,</span> <span class="mi">1911</span><span class="p">),</span>
                       <span class="n">fuv</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">crir</span><span class="o">=</span><span class="mf">2e-16</span><span class="p">,</span>
                       <span class="n">suggested_calc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">from_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">new_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">change_interpolation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dilled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">timed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">          This method calculates the radii assuming an origin of (0,0). It then averages</span>
<span class="sd">         over a subgrid of 3x3. It might be improved later by having functionality to</span>
<span class="sd">         change the subgrid dimensions.</span>
<span class="sd">    </span>
<span class="sd">         There are a few kwargs that can be used to initialise a Voxel instance:</span>
<span class="sd">    </span>
<span class="sd">         MODEL PARAMETERS</span>
<span class="sd">    </span>
<span class="sd">         alpha: The power law distribution required for initial mass function dN(M)/dM = M^-alpha.</span>
<span class="sd">                The default is 1.84 as determined in Heithausen et al. (1998).</span>
<span class="sd">         gamma: The power law mass-size relation satisfying M = C R^gamma. The default is 2.31 as</span>
<span class="sd">                determined in Heithausen et al. (1998).</span>
<span class="sd">         velocityRange: The range (list) of the observed radial velocities. By default it</span>
<span class="sd">                        is [-10, 10].</span>
<span class="sd">         velocityNumber: The number of observed velocities in the specified range (including</span>
<span class="sd">                         endpoints). The default is 51.</span>
<span class="sd">         clumpMassNumber: The number of clump masses for each set. This should be a list of</span>
<span class="sd">                          integers with the same length as clumpMassRange. The default is</span>
<span class="sd">                          [3, 1].</span>
<span class="sd">         clumpMassRange: The range (list) of clump masses for each set. This is a list of</span>
<span class="sd">                         ranges with the same length as clumpMassNumber. The ranges can have</span>
<span class="sd">                         length 1, in which case it only evaluates that clump mass. The</span>
<span class="sd">                         masses are in units of dex(Msol). By default it is [[0, 2], [-2]].</span>
<span class="sd">         clumpDensity: This changes the default clump density in the constants module. This</span>
<span class="sd">                       overrides the voxel density kwarg, and is useful for creating interclumps</span>
<span class="sd">                       medium that is not scaled according to the clumps. the default is</span>
<span class="sd">                       [None, 1911], so the first clump set takes the voxel density. This is in</span>
<span class="sd">                       units of cm^-3.</span>
<span class="sd">         clumpFUV: This changes the default clump FUV in the constants module. This overrides</span>
<span class="sd">                   the voxel FUV kwarg. It is a list of length of the number of clump sets.</span>
<span class="sd">                   Use a value of None to use the voxel FUV field. The default is [None, 1], in</span>
<span class="sd">                   units of the Draine field.</span>
<span class="sd">         clumpNmax: The maximum number of the largest clump in the ensemble. This helps to limit</span>
<span class="sd">                    the calculation of a large combination of clumps by rescaling the voxel (thus</span>
<span class="sd">                    eliminating any change to the brightness temperature). Larger combinations are used</span>
<span class="sd">                    if the rescaled voxel is smaller than the largest clump. The default is [1, 100].</span>
<span class="sd">         voxel_size: The voxel size in parsecs. The default is 1 pc.</span>
<span class="sd">         transitions: The transitions included in the model. This is a list of strings, where each</span>
<span class="sd">                    string has the element name (as in the grid) followed by the transition</span>
<span class="sd">                    number (Which is taken from KOSMA-tau). It is set to the first transition</span>
<span class="sd">                    of C+, C, and CO by default.</span>
<span class="sd">         dust: This is a string to limit how much of the dust continuum is included. The</span>
<span class="sd">               available continuum ranges from 1 nm to 3.1 mm. This can be limited to the range</span>
<span class="sd">               of molecular lines by setting dust=&#39;molecular&#39; (22 dust lines), or to the range of</span>
<span class="sd">               PAH dust features by setting dust=&#39;PAH&#39; (201 dust lines). All dust lines (333)</span>
<span class="sd">               will be calculated if dust=&#39;&#39;</span>
<span class="sd">    </span>
<span class="sd">         VOXEL PROPERTIES</span>
<span class="sd">    </span>
<span class="sd">         ensembleMass: This can be either a float or list of floats, depending on how many clump</span>
<span class="sd">                      sets you have. The default is 100 Msol.</span>
<span class="sd">         velocity: The radial velocity of the observed Voxel instance. This is used with the</span>
<span class="sd">                   model velocities to determine the number of clumps seen at a given velocity.</span>
<span class="sd">                   The default is 0 km/s.</span>
<span class="sd">         ensembleDispersion: The velocity dispersion of the ensemble. This is used with the</span>
<span class="sd">                             model velocities to determine the number of clumps at a given</span>
<span class="sd">                             velocity. The default is 1 km/s.</span>
<span class="sd">         ensembleDensity: The observed hydrogen density in the voxel. This is different from and overridden by</span>
<span class="sd">                  any default density specified in the constants module. the default is</span>
<span class="sd">                  15000 cm^-3.</span>
<span class="sd">         FUV: The FUV field of the voxel. All clumps are isotropically radiated with this</span>
<span class="sd">              field. It is different from and overridden by any default FUV field specified</span>
<span class="sd">              in the constants module. The default is 20000 Draine units.</span>
<span class="sd">         crir: The primary cosmic ray ionisation rate with respect to molecular hydrogen (zeta_H2). By default,</span>
<span class="sd">               the local rate is used (2e-16).</span>
<span class="sd">    </span>
<span class="sd">         GENERAL FLAGS</span>

<span class="sd">         suggested_calc: This flag is used to specify the corrected version of the calculation</span>
<span class="sd">                         should be used. It is True by default.</span>
<span class="sd">         fromFile: This flag can be set to retrieve the voxel properties from a file. It is</span>
<span class="sd">                   False by default.</span>
<span class="sd">         verbose: This is mainly used for debugging purposes. It prints various statements</span>
<span class="sd">                  as the code is evaluated</span>
<span class="sd">    </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># print(&#39;Voxel instance initialised&#39;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">timed</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span> <span class="o">=</span> <span class="n">suggested_calc</span>
    
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__x</span><span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">__x</span><span class="o">+</span><span class="mf">.5</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__y</span><span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="p">,</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">__y</span><span class="o">+</span><span class="mf">.5</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_grid</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span> <span class="o">!=</span> <span class="n">voxel_size</span><span class="p">:</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span> <span class="o">=</span> <span class="n">voxel_size</span>

            <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="n">alpha</span> <span class="ow">or</span> <span class="n">constants</span><span class="o">.</span><span class="n">gamma</span> <span class="o">!=</span> <span class="n">gamma</span><span class="p">:</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">change_mass_function_parameters</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">velocity_bin</span> <span class="o">!=</span> <span class="n">velocity_range</span> <span class="ow">or</span> <span class="n">constants</span><span class="o">.</span><span class="n">velocity_number</span> <span class="o">!=</span> <span class="n">velocity_number</span><span class="p">:</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">change_velocity_range</span><span class="p">(</span><span class="n">velocity_range</span><span class="p">)</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">change_velocity_number</span><span class="p">(</span><span class="n">velocity_number</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">velocity_resolution</span> <span class="o">!=</span> <span class="n">velocity_resolution</span><span class="p">:</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">velocity_resolution</span> <span class="o">=</span> <span class="n">velocity_resolution</span>

            <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">clump_log_mass_range</span> <span class="o">!=</span> <span class="n">clump_mass_range</span> \
                    <span class="ow">or</span> <span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span> <span class="o">!=</span> <span class="n">clump_mass_number</span> \
                    <span class="ow">or</span> <span class="n">constants</span><span class="o">.</span><span class="n">clump_n_max</span> <span class="o">!=</span> <span class="n">clump_n_max</span><span class="p">:</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">add_clumps</span><span class="p">(</span><span class="n">mass_range</span><span class="o">=</span><span class="n">clump_mass_range</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">clump_mass_number</span><span class="p">,</span> 
                                     <span class="n">n_max</span><span class="o">=</span><span class="n">clump_n_max</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">interclump_idx</span> <span class="o">!=</span> <span class="n">interclump_idx</span><span class="p">:</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">set_interclump_ensemble</span><span class="p">(</span><span class="n">interclump_idx</span><span class="p">)</span>
                <span class="n">change_interpolation</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">interclump_wnm_idx</span> <span class="o">!=</span> <span class="n">interclump_idx</span><span class="p">:</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">set_interclump_wnm</span><span class="p">(</span><span class="n">interclump_wnm_idx</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;ELECTR&#39;</span> <span class="ow">in</span> <span class="n">abundances</span><span class="p">:</span>
                <span class="n">abundances</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;ELECTR&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">abundances</span><span class="p">:</span>
                <span class="n">abundances</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;H2&#39;</span> <span class="ow">in</span> <span class="n">abundances</span><span class="p">:</span>
                <span class="n">abundances</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;H2&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;H+&#39;</span> <span class="ow">in</span> <span class="n">abundances</span><span class="p">:</span>
                <span class="n">abundances</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;H+&#39;</span><span class="p">)</span>
            <span class="n">abun</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ELECTR&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="s1">&#39;H+&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">abundances</span><span class="p">:</span>
                <span class="n">abun</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
            <span class="n">constants</span><span class="o">.</span><span class="n">abundances</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">abun</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">new_grid</span> <span class="ow">or</span> <span class="n">change_interpolation</span> <span class="ow">or</span> \
                    <span class="ow">not</span> <span class="n">interpolations</span><span class="o">.</span><span class="n">initialised</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">observations</span><span class="o">.</span><span class="n">grid_initialised</span> <span class="ow">or</span> \
                    <span class="n">dust</span> <span class="o">!=</span> <span class="n">constants</span><span class="o">.</span><span class="n">dust</span><span class="p">:</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">change_dust_wavelengths</span><span class="p">(</span><span class="n">dust</span><span class="p">)</span>
                <span class="n">observations</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">initialise_grid</span><span class="p">(</span><span class="n">clump_tau_grid_file</span><span class="o">=</span><span class="n">clump_tau_grid_file</span><span class="p">,</span>
                                                     <span class="n">interclump_tau_grid_file</span><span class="o">=</span><span class="n">interclump_tau_grid_file</span><span class="p">,</span>
                                                     <span class="n">interclump_dust_tau_grid_file</span><span class="o">=</span><span class="n">interclump_dust_tau_grid_file</span><span class="p">,</span>
                                                     <span class="n">clump_tb_grid_file</span><span class="o">=</span><span class="n">clump_tb_grid_file</span><span class="p">,</span>
                                                     <span class="n">interclump_tb_grid_file</span><span class="o">=</span><span class="n">interclump_tb_grid_file</span><span class="p">,</span>
                                                     <span class="n">interclump_dust_tb_grid_file</span><span class="o">=</span><span class="n">interclump_dust_tb_grid_file</span><span class="p">,</span>
                                                     <span class="n">clump_taufuv_grid_file</span><span class="o">=</span><span class="n">clump_taufuv_grid_file</span><span class="p">,</span>
                                                     <span class="n">interclump_taufuv_grid_file</span><span class="o">=</span><span class="n">interclump_taufuv_grid_file</span><span class="p">,</span>
                                                     <span class="n">clump_column_density_file</span><span class="o">=</span><span class="n">clump_column_density_file</span><span class="p">,</span>
                                                     <span class="n">interclump_column_density_file</span><span class="o">=</span><span class="n">interclump_column_density_file</span><span class="p">,</span>
                                                     <span class="n">clump_temperature_file</span><span class="o">=</span><span class="n">clump_temperature_file</span><span class="p">,</span>
                                                     <span class="n">interclump_temperature_file</span><span class="o">=</span><span class="n">interclump_temperature_file</span><span class="p">)</span>
                <span class="n">species</span><span class="o">.</span><span class="n">add_transitions</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>
                <span class="n">species</span><span class="o">.</span><span class="n">add_transitions</span><span class="p">(</span><span class="n">transitions</span><span class="p">,</span> <span class="n">interclump</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">interpolations</span><span class="o">.</span><span class="n">initialise_grid</span><span class="p">(</span><span class="n">dilled</span><span class="o">=</span><span class="n">dilled</span><span class="p">)</span>

        <span class="c1">#print(&#39;interpolation initialised:&#39;, (time()-t0)/60)</span>

        <span class="k">if</span> <span class="n">timed</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Model setup: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>

        <span class="n">masspoints</span><span class="o">.</span><span class="n">reinitialise</span><span class="p">()</span>
        <span class="n">combinations</span><span class="o">.</span><span class="n">reinitialise</span><span class="p">()</span>
        <span class="n">ensemble</span><span class="o">.</span><span class="n">reinitialise</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span> <span class="o">=</span> <span class="n">velocity</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensemble_mass</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span> <span class="o">=</span> <span class="n">ensemble_mass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span> <span class="o">=</span> <span class="p">[</span><span class="n">ensemble_mass</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensemble_dispersion</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_dispersion</span> <span class="o">=</span> <span class="n">ensemble_dispersion</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_dispersion</span> <span class="o">=</span> <span class="p">[</span><span class="n">ensemble_dispersion</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">voxel_factor</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__voxel_filling_factor</span> <span class="o">=</span> <span class="p">[</span><span class="n">voxel_factor</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__voxel_filling_factor</span> <span class="o">=</span> <span class="n">voxel_factor</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">volume_factor</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">volume_factor</span> <span class="o">=</span> <span class="p">[</span><span class="n">volume_factor</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">volume_factor</span><span class="p">:</span>
            <span class="n">ensemble_density</span> <span class="o">=</span> <span class="p">[</span><span class="n">ensemble_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">mass_solar</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">mass_h</span>
                                <span class="o">/</span><span class="n">volume_factor</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">pc</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">100</span><span class="o">**</span><span class="mi">3</span>
                                <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensemble_density</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_density</span> <span class="o">=</span> <span class="n">ensemble_density</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_density</span> <span class="o">=</span> <span class="p">[</span><span class="n">ensemble_density</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fuv</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fuv</span> <span class="o">=</span> <span class="n">fuv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fuv</span> <span class="o">=</span> <span class="p">[</span><span class="n">fuv</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">clump_mass_number</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__crir</span> <span class="o">=</span> <span class="n">crir</span>

        <span class="n">velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span>
    
        <span class="c1"># This will allow the code to reuse the standard clump density constants for voxel sets (ie. do not alter the model constants)</span>
        <span class="c1"># density = copy(constants.clumpDensity)</span>
        <span class="c1"># fuv = copy(constants.clumpFUV)</span>
        <span class="c1"># for i in range(len(density)):</span>
            <span class="c1"># if density[i]==&#39;auto&#39;: density[i] = self.__ensembleDensity</span>
            <span class="c1"># if fuv[i]==None: fuv[i] = self.__FUV</span>

        <span class="c1">#print(&#39;properties set:&#39;, (time()-t0)/60)</span>
    
        <span class="n">masspoints</span><span class="o">.</span><span class="n">set_masspoint_data</span><span class="p">(</span><span class="n">density</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_density</span><span class="p">,</span> <span class="n">fuv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__fuv</span><span class="p">,</span> <span class="n">crir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__crir</span><span class="p">)</span>
        <span class="c1">#print(&#39;  masspoints:&#39;, (time()-t0)/60)</span>
        <span class="n">ensemble</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">ensembledispersion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_dispersion</span><span class="p">,</span> 
                            <span class="n">ensemblemass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span><span class="p">,</span>
                            <span class="n">suggested_calc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">)</span>
        <span class="c1">#print(&#39;  ensemble:&#39;, (time()-t0)/60)</span>
        <span class="n">combinations</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">clump_combination</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ensemble</span><span class="o">.</span><span class="n">clumpCombinations</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpLargestIndex</span><span class="p">[</span><span class="n">ens</span><span class="p">]]</span> 
                <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))],</span>
                <span class="n">total_combination</span><span class="o">=</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">CLmaxCombinations</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
                <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))])</span>

        <span class="c1"># self.__hi_mass = </span>
        
        <span class="c1">#print(&#39;probabilities calculated:&#39;, (time()-t0)/60)</span>
        <span class="c1">#print(&#39;ensemble velocities:&#39;, ensemble.clumpVelocities)</span>

        <span class="k">if</span> <span class="n">timed</span><span class="p">:</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Modules initialised:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__hi_mass</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__h2_mass</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span>
    
        <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_dispersion</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">constants</span><span class="o">.</span><span class="n">clump_dispersion</span><span class="p">:</span>
                    <span class="n">dispersion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_dispersion</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_dispersion</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__model_mass</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpDeltaNji</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                             <span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="n">dispersion</span>
                                             <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_dispersion</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_dispersion</span>
                                             <span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_log_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__model_mass</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpDeltaNji</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                             <span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_dispersion</span>
                                             <span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_log_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__model_mass</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpDeltaNji</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                         <span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_log_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpNj</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>
                                        <span class="o">*</span><span class="p">(</span><span class="n">masspoints</span><span class="o">.</span><span class="n">clump_radius</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                                       <span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__model_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">suggested_calc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ERROR: Voxel </span><span class="si">{}</span><span class="s1"> mass difference for clump set </span><span class="si">{}</span><span class="s1"> greater than 10%&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__index</span><span class="p">,</span> <span class="n">ens</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    
        <span class="c1"># clumpAfuv,interclumpAfuv = combinations.getAfuv()</span>
        <span class="c1"># clumpAfuv *= ensemble.CLmaxProbability</span>
        <span class="c1"># interclumpAfuv *= ensemble.ICmaxProbability</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocities</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpVelocities</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocity_indeces</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">)</span>   <span class="c1"># all list entries should be the same</span>

        <span class="k">if</span> <span class="n">suggested_calc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                                      <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                               <span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> 
                                              <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                                   <span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> 
                                                  <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_hi</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                             <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_hi</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                                 <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                                      <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                               <span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> 
                                              <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                                   <span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> 
                                                  <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_dust</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_hi</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_hi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_hi</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_hi</span><span class="p">)</span>
    
        <span class="c1"># This gives an error if there are too many clumps in a line-of-sight; tau_FUV is too large for this equation...</span>
        <span class="n">Afuv</span> <span class="o">=</span> <span class="n">combinations</span><span class="o">.</span><span class="n">get_fuv_extinction</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__taufuv</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">ensemble</span><span class="o">.</span><span class="n">CLmaxProbability</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Afuv</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                         <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
        
        <span class="k">if</span> <span class="n">timed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;setProperties() time of execution:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>

        <span class="c1">#print(&#39;voxel initialised:&#39;, (time()-t0)/60)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;voxel initialised&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>

  
<div class="viewcode-block" id="Voxel.get_position">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_position">[docs]</a>
    <span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__z</span><span class="p">])</span></div>

  
<div class="viewcode-block" id="Voxel.get_density">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_density">[docs]</a>
    <span class="k">def</span> <span class="nf">get_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_density</span></div>

  
<div class="viewcode-block" id="Voxel.get_ensemble_mass">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_ensemble_mass">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ensemble_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span></div>

  
<div class="viewcode-block" id="Voxel.get_model_mass">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_model_mass">[docs]</a>
    <span class="k">def</span> <span class="nf">get_model_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__model_mass</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__model_mass</span></div>


<div class="viewcode-block" id="Voxel.get_hi_mass">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_hi_mass">[docs]</a>
    <span class="k">def</span> <span class="nf">get_hi_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__hi_mass</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hi_mass</span></div>


<div class="viewcode-block" id="Voxel.get_h2_mass">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_h2_mass">[docs]</a>
    <span class="k">def</span> <span class="nf">get_h2_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__h2_mass</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__h2_mass</span></div>

  
<div class="viewcode-block" id="Voxel.get_volume_filling_factor">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_volume_filling_factor">[docs]</a>
    <span class="k">def</span> <span class="nf">get_volume_filling_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span></div>

  
<div class="viewcode-block" id="Voxel.get_voxel_filling_factor">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_voxel_filling_factor">[docs]</a>
    <span class="k">def</span> <span class="nf">get_voxel_filling_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__voxel_filling_factor</span></div>

  
<div class="viewcode-block" id="Voxel.get_velocity">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_velocity">[docs]</a>
    <span class="k">def</span> <span class="nf">get_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_dispersion</span></div>

  
<div class="viewcode-block" id="Voxel.get_clump_velocity">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_clump_velocity">[docs]</a>
    <span class="k">def</span> <span class="nf">get_clump_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocities</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocity_indeces</span></div>

  
<div class="viewcode-block" id="Voxel.get_taufuv">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_taufuv">[docs]</a>
    <span class="k">def</span> <span class="nf">get_taufuv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__taufuv</span></div>


<div class="viewcode-block" id="Voxel.get_species_number">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_species_number">[docs]</a>
    <span class="k">def</span> <span class="nf">get_species_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nref</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">abundances</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">species</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">nref</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nref</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nref</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">nref</span> <span class="o">=</span> <span class="p">[</span><span class="n">nref</span><span class="p">]</span>

        <span class="n">N_species</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">abun</span><span class="p">:</span>
                <span class="n">N_0</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">nref</span><span class="p">:</span>
                    <span class="n">N_0</span> <span class="o">+=</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">clump_N_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">constants</span><span class="o">.</span><span class="n">abundances</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">N_0</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">N_sp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">species</span><span class="p">:</span>
                <span class="n">N_sp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clump_N_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">constants</span><span class="o">.</span><span class="n">abundances</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span><span class="o">/</span><span class="n">N_0</span><span class="p">)</span>

            <span class="n">N_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">N_sp</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N_species</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">N_species</span></div>


<div class="viewcode-block" id="Voxel.get_abundances">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_abundances">[docs]</a>
    <span class="k">def</span> <span class="nf">get_abundances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_number</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">abun</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Voxel.get_dust_temperature">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_dust_temperature">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dust_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_dust</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> \
                    <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_dust</span></div>


<div class="viewcode-block" id="Voxel.get_gas_temperature">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_gas_temperature">[docs]</a>
    <span class="k">def</span> <span class="nf">get_gas_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_gas</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> \
                    <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_mass</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_gas</span></div>

  
    <span class="c1"># @jit</span>
<div class="viewcode-block" id="Voxel.calculate_emission">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.calculate_emission">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_emission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taufuv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                           <span class="n">test_calc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_opacity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_pexp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_fv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_calc</span> <span class="o">=</span> <span class="n">test_calc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_opacity</span> <span class="o">=</span> <span class="n">test_opacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_pexp</span> <span class="o">=</span> <span class="n">test_pexp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_fv</span> <span class="o">=</span> <span class="n">test_fv</span>

        <span class="c1">#if timed:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># reinitialise properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                              <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                           <span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> 
                                          <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                               <span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> 
                                              <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_hi</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                         <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_hi</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">_</span><span class="p">]),</span>
                                             <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
        
        <span class="n">masspoints</span><span class="o">.</span><span class="n">calculate_emission</span><span class="p">(</span><span class="n">taufuv</span><span class="o">=</span><span class="n">taufuv</span><span class="p">,</span> <span class="n">timed</span><span class="o">=</span><span class="n">timed</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">timed</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Masspoint emission calculated: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
        <span class="c1">#print(&#39;masspoint emission calculated:&#39;, (time()-t0)/60)</span>

        <span class="n">combinations</span><span class="o">.</span><span class="n">calculate_emission</span><span class="p">(</span><span class="n">test_calc</span><span class="o">=</span><span class="n">test_calc</span><span class="p">,</span> <span class="n">test_opacity</span><span class="o">=</span><span class="n">test_opacity</span><span class="p">,</span>
                                        <span class="n">test_fv</span><span class="o">=</span><span class="n">test_fv</span><span class="p">,</span> <span class="n">f_v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span><span class="p">,</span>
                                        <span class="n">suggested_calc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">timed</span><span class="p">:</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Combination emission calculated: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">))</span>
        <span class="c1">#print(&#39;combination emission calculated:&#39;, (time()-t0)/60)</span>

        <span class="n">clumpIntensity</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
        <span class="n">clumpOpticalDepth</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
        <span class="n">clumpIntensityDust</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
        <span class="n">clumpOpticalDepthDust</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
        
        <span class="n">clumpIntensityHI</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
        <span class="n">clumpOpticalDepthHI</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
    
        <span class="c1"># interclumpIntensity = []</span>
        <span class="c1"># interclumpOpticalDepth = []</span>
    
        <span class="n">iDust</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">f_ds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span> 
                <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
    
        <span class="c1"># Clump</span>
        <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">):</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">__hi_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">masspoints</span><span class="o">.</span><span class="n">clump_hi_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">*</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpNj</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__h2_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">masspoints</span><span class="o">.</span><span class="n">clump_h2_mass</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">*</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpNj</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
            <span class="n">vel</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span>   <span class="c1"># v_obs</span>
            <span class="n">clumpVel</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">clumpVelocities</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>   <span class="c1"># v_sys</span>
            <span class="c1"># print(vel.shape, clumpVel.shape)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
                <span class="c1">#print(&#39;new calculation:&#39;, (time()-t0)/60)</span>
                <span class="c1"># dust calculation</span>
                <span class="n">optical_depth_comb_dust</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">combinations</span><span class="o">.</span><span class="n">clump_dust_optical_depth</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="n">intensity_comb_dust</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">combinations</span><span class="o">.</span><span class="n">clump_dust_intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="n">i_nan</span> <span class="o">=</span> <span class="n">optical_depth_comb_dust</span> <span class="o">&lt;</span> <span class="mf">1e-16</span>
                <span class="n">intensity_comb_dust</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">intensity_comb_dust</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">]</span>
                                               <span class="o">/</span> <span class="n">optical_depth_comb_dust</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">]</span>
                                               <span class="c1">#*constants.voxel_size</span>
                                               <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">optical_depth_comb_dust</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">])))</span>
                <span class="n">intensity_comb_dust</span><span class="p">[</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity_comb_dust</span><span class="p">[</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                <span class="n">p_tot</span> <span class="o">=</span> <span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">CLmaxProbability</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                         <span class="o">/</span><span class="n">ensemble</span><span class="o">.</span><span class="n">CLmaxProbability</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                         <span class="p">)</span>
                <span class="n">clumpIntensityDust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p_tot</span> <span class="o">*</span> <span class="n">intensity_comb_dust</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">optical_depth_exp_dust</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">optical_depth_comb_dust</span><span class="p">)</span>
                <span class="n">optical_depth_exp_dust</span><span class="p">[</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">optical_depth_prob_dust</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_tot</span> <span class="o">*</span> <span class="n">optical_depth_exp_dust</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">i_zero</span> <span class="o">=</span> <span class="p">(</span><span class="n">optical_depth_exp_dust</span><span class="o">%</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">clumpOpticalDepthDust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">optical_depth_prob_dust</span><span class="p">))</span>
                <span class="n">clumpOpticalDepthDust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i_zero</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1">#clumpOpticalDepthDust[ens].append(-np.log((p_tot * np.exp(-optical_depth_comb_dust.T)).sum(1)))</span>
                <span class="c1"># transition calculation</span>
                <span class="n">optical_depth_comb</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">combinations</span><span class="o">.</span><span class="n">clump_species_optical_depth</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="n">intensity_comb</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">combinations</span><span class="o">.</span><span class="n">clump_species_intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="n">optical_depth_hi_comb</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">combinations</span><span class="o">.</span><span class="n">clump_hi_tau</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="n">intensity_hi_comb</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">combinations</span><span class="o">.</span><span class="n">clump_hi_tb</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="n">i_nan</span> <span class="o">=</span> <span class="n">optical_depth_comb</span> <span class="o">&lt;</span> <span class="mf">1e-16</span>
                <span class="n">i_nan_hi</span> <span class="o">=</span> <span class="n">optical_depth_hi_comb</span> <span class="o">&lt;</span> <span class="mf">1e-16</span>
                <span class="n">optical_depth_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">optical_depth_comb</span><span class="p">)</span>
                <span class="n">optical_depth_exp</span><span class="p">[</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">optical_depth_hi_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">optical_depth_hi_comb</span><span class="p">)</span>
                <span class="n">optical_depth_hi_exp</span><span class="p">[</span><span class="n">i_nan_hi</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">intensity_comb</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">intensity_comb</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">]</span>
                                          <span class="o">/</span> <span class="n">optical_depth_comb</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">]</span><span class="c1">#*constants.voxel_size</span>
                                          <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">optical_depth_comb</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">])))</span>
                <span class="n">intensity_comb</span><span class="p">[</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity_comb</span><span class="p">[</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                <span class="n">intensity_hi_comb</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan_hi</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">intensity_hi_comb</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan_hi</span><span class="p">]</span>
                                          <span class="o">/</span> <span class="n">optical_depth_hi_comb</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan_hi</span><span class="p">]</span><span class="c1">#*constants.voxel_size</span>
                                          <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">optical_depth_hi_comb</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan_hi</span><span class="p">])))</span>
                <span class="n">intensity_hi_comb</span><span class="p">[</span><span class="n">i_nan_hi</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity_hi_comb</span><span class="p">[</span><span class="n">i_nan_hi</span><span class="p">]</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">probability</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpProbability</span><span class="p">[</span><span class="n">ens</span><span class="p">]):</span>
                    <span class="n">p_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">probability</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                           <span class="o">/</span> <span class="n">probability</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                           <span class="p">)</span>
                    <span class="c1">#clumpIntensity[ens].append((probability.prod(1)#/probability.prod(1).sum(0)</span>
                    <span class="c1">#                            intensity_comb.T))</span>
                    <span class="n">clumpIntensity</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p_i</span> <span class="o">*</span> <span class="n">intensity_comb</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">optical_depth_prob</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_i</span> <span class="o">*</span> <span class="n">optical_depth_exp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">clumpIntensityHI</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p_i</span> <span class="o">*</span> <span class="n">intensity_hi_comb</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">optical_depth_hi_prob</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_i</span> <span class="o">*</span> <span class="n">optical_depth_hi_exp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">i_zero</span> <span class="o">=</span> <span class="p">(</span><span class="n">optical_depth_comb</span><span class="o">%</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">i_zero_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">optical_depth_hi_comb</span><span class="o">%</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">clumpOpticalDepth</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">optical_depth_prob</span><span class="p">))</span>
                    <span class="n">clumpOpticalDepth</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i_zero</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">clumpOpticalDepthHI</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">optical_depth_hi_prob</span><span class="p">))</span>
                    <span class="n">clumpOpticalDepthHI</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i_zero_hi</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1">#clumpOpticalDepth[ens].append(-np.log((probability.prod(1)#/probability.prod(1).sum(0)</span>
                    <span class="c1">#                                       * np.exp(-optical_depth_comb.T)).sum(1)))</span>

                <span class="c1"># Transitions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clumpIntensity</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clumpOpticalDepth</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">/</span><span class="n">f_ds</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>
                <span class="n">i_undef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-16</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">]</span>
                                                  <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">])))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i_undef</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i_undef</span><span class="p">]</span>

                <span class="c1"># Dust</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clumpIntensityDust</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clumpOpticalDepthDust</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">/</span><span class="n">f_ds</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>
                <span class="n">i_undef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">]</span>
                                               <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">])))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i_undef</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i_undef</span><span class="p">]</span>

                <span class="c1"># HI</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clumpIntensityHI</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clumpOpticalDepthHI</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">/</span><span class="n">f_ds</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>
                <span class="n">i_undef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-16</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">]</span>
                                                  <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_undef</span><span class="p">])))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i_undef</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i_undef</span><span class="p">]</span>

            <span class="c1"># The old computation that will soon be removed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vel</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ensemble_dispersion</span><span class="p">[</span><span class="n">ens</span><span class="p">],</span>
                                                                 <span class="n">constants</span><span class="o">.</span><span class="n">clump_dispersion</span><span class="p">)</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_dispersion</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> \
                         <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">nv</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">clumpVel</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                                  <span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_dispersion</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># clumpIntensity[ens] = np.zeros((ensemble.clumpVelocities[ens].size,</span>
                <span class="c1">#                                 constants.velocityRange.size,</span>
                <span class="c1">#                                 combinations.clumpIntensity[ens].shape[0],</span>
                <span class="c1">#                                 combinations.clumpIntensity[ens].shape[1]))</span>
                <span class="c1"># clumpIntensityDust[ens] = np.zeros((constants.velocityRange.size,</span>
                <span class="c1">#                                     combinations.clumpIntensity[ens].shape[0],</span>
                <span class="c1">#                                     combinations.clumpIntensity[ens].shape[1]))</span>
                <span class="c1"># clumpOpticalDepth[ens] = np.zeros((ensemble.clumpVelocities[ens].size,</span>
                <span class="c1">#                                    constants.velocityRange.size,</span>
                <span class="c1">#                                    combinations.clumpIntensity[ens].shape[0],</span>
                <span class="c1">#                                    combinations.clumpIntensity[ens].shape[1]))</span>
                <span class="c1"># clumpOpticalDepthDust[ens] = np.zeros((constants.velocityRange.size,</span>
                <span class="c1">#                                        combinations.clumpIntensity[ens].shape[0],</span>
                <span class="c1">#                                        combinations.clumpIntensity[ens].shape[1]))</span>

                <span class="n">p_tot</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">CLmaxProbability</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">ensemble</span><span class="o">.</span><span class="n">CLmaxProbability</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">nv</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">probability</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpProbability</span><span class="p">[</span><span class="n">ens</span><span class="p">]):</span>

                        <span class="k">if</span> <span class="n">timed</span><span class="p">:</span>
                            <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start I_xi calculation:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t3</span><span class="o">-</span><span class="n">t2</span><span class="p">))</span>

                        <span class="n">p_i</span> <span class="o">=</span> <span class="n">probability</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">probability</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                        <span class="n">intensity</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">combinations</span><span class="o">.</span><span class="n">clump_species_intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                        <span class="c1"># shape (v_obs, combination, wavelength)</span>
                        <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">intensity</span><span class="o">*</span><span class="n">factor</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">j</span><span class="p">]</span>
                                              <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
                        <span class="c1"># shape (v_sys, v_obs, combination, wavelength)</span>
                        <span class="n">clumpIntensity</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">p_i</span> <span class="o">*</span> <span class="n">intensity</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                                                             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span>
                        <span class="c1"># shape (combination, wavelength)</span>
                        <span class="n">intensityDust</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">combinations</span><span class="o">.</span><span class="n">clump_dust_intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                        <span class="c1"># shape (v_obs, combination, wavelength)</span>
                        <span class="n">clumpIntensityDust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p_tot</span> <span class="o">*</span> <span class="n">intensityDust</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

                        <span class="n">opticalDepth</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">combinations</span><span class="o">.</span><span class="n">clump_species_optical_depth</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                        <span class="n">opticalDepth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">opticalDepth</span><span class="o">*</span><span class="n">factor</span><span class="p">[</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">j</span><span class="p">]</span>
                                                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
                        <span class="n">opticalDepthDust</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">combinations</span><span class="o">.</span><span class="n">clump_dust_optical_depth</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_pexp</span><span class="p">:</span>
                            <span class="n">clumpOpticalDepthDust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p_tot</span> <span class="o">*</span> <span class="n">opticalDepthDust</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                            <span class="n">clumpOpticalDepth</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">p_i</span> <span class="o">*</span> <span class="n">opticalDepth</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                                                                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_opacity</span><span class="p">:</span>
                            <span class="n">clumpOpticalDepthDust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p_tot</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">opticalDepthDust</span><span class="o">.</span><span class="n">T</span>
                                                                        <span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">*</span><span class="n">f_ds</span><span class="p">[</span><span class="n">ens</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                            <span class="n">clumpOpticalDepth</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">p_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">opticalDepth</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                                                                              <span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">*</span><span class="n">f_ds</span><span class="p">[</span><span class="n">ens</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
                                                                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">clumpOpticalDepthDust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p_tot</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">opticalDepthDust</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                            <span class="n">clumpOpticalDepth</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">p_i</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">opticalDepth</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                                                                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span>

                        <span class="k">if</span> <span class="n">timed</span><span class="p">:</span>
                            <span class="n">t4</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;End I_xi calculation:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t4</span><span class="o">-</span><span class="n">t3</span><span class="p">))</span>

                    <span class="c1"># All of these have shape (velocity, wavelength)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">nv</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">nv</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> \
                                                           <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clumpIntensity</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                                            <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="c1"># self.__intensityDust[ens][:,:] = self.__intensityDust[ens][:,:] +</span>
                    <span class="c1">#                                  np.array([np.array(clumpIntensityDust[ens]).sum(1).sum(0)</span>
                    <span class="c1">#                                  for _ in range(factor.shape[1])]).astype(constants.dtype)</span>
                    <span class="c1"># self.__opticalDepthDust[ens][:,:] = self.__opticalDepthDust[ens][:,:] +</span>
                    <span class="c1">#                                     np.array([-np.log(np.array(clumpOpticalDepthDust[ens]).sum(1)).sum(0)</span>
                    <span class="c1">#                                     for _ in range(factor.shape[1])]).astype(constants.dtype)</span>
                    <span class="c1">#                                     (factor.shape[1])]).astype(constants.dtype)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="p">:]</span> <span class="o">+</span>
                                                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clumpIntensityDust</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                                                 <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                                                 <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_pexp</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">nv</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">nv</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> \
                                                                 <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clumpOpticalDepth</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                                                  <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="p">:]</span> <span class="o">+</span>
                                                              <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clumpOpticalDepthDust</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                                                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                                                        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">nv</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">nv</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> \
                                                                 <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clumpOpticalDepth</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                                                                  <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="p">:]</span> <span class="o">+</span>
                                                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clumpOpticalDepthDust</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                                                                <span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                                                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                                                        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">iDust</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">intensityDustInterp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                        <span class="n">opticalDepthDustInterp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">iDust</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intensityDustInterp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">opticalDepthDustInterp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Voxel with velocity </span><span class="si">{}</span><span class="s1"> not within given observing velocity range.&#39;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="c1"># Handled above</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_calc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_dust</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_fv</span><span class="p">:</span>
            <span class="n">f_ds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span> <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">/</span><span class="n">f_ds</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>
                                         <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_dust</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">/</span><span class="n">f_ds</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>
                                      <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                                         <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_dust</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                                      <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_Number</span><span class="p">))]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="c1"># Handled above</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_opacity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_fv</span><span class="p">:</span>
            <span class="n">f_ds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span> <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">/</span><span class="n">f_ds</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>
                                         <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="o">/</span><span class="n">f_ds</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>
                                      <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                                         <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                                      <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">))]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t_gas</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpNj</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_log_mass</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="o">*</span><span class="n">masspoints</span><span class="o">.</span><span class="n">clump_t_gas</span><span class="p">[</span><span class="n">_</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                      <span class="o">/</span> <span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpNj</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_log_mass</span><span class="p">[</span><span class="n">_</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_dust</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpNj</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_log_mass</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="o">*</span><span class="n">masspoints</span><span class="o">.</span><span class="n">clump_t_dust</span><span class="p">[</span><span class="n">_</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                       <span class="o">/</span> <span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpNj</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_log_mass</span><span class="p">[</span><span class="n">_</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clump_N_species</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpNj</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">masspoints</span><span class="o">.</span><span class="n">clump_N_species</span><span class="p">[</span><span class="n">_</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NaN in species intensity: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NaN in species optical depth: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NaN in dust intensity: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NaN in dust optical depth: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()))</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Voxel emission calculated.&#39;</span><span class="p">)</span>
          
        <span class="k">if</span> <span class="n">timed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;calculateEmission() time of execution:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
        
        <span class="k">return</span></div>


<div class="viewcode-block" id="Voxel.gaussian">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.gaussian">[docs]</a>
    <span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span></div>


<div class="viewcode-block" id="Voxel.two_gaussians">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.two_gaussians">[docs]</a>
    <span class="k">def</span> <span class="nf">two_gaussians</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">g1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">g2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">))</span></div>


<div class="viewcode-block" id="Voxel.get_species_emissivity">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_species_emissivity">[docs]</a>
    <span class="k">def</span> <span class="nf">get_species_emissivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="n">epsilon_species</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">include_dust</span><span class="p">:</span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">epsilon_dust</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dust_emissivity</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">epsilon_dust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_emissivity</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
                    <span class="n">clump_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocities</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocity_indeces</span><span class="p">[</span><span class="n">ens</span><span class="p">]]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span>
                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                        <span class="n">eps</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                            <span class="n">diff_eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">diff_kap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">diff_eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">diff_kap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">diff_eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">diff_kap</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                <span class="n">a_eps</span><span class="p">,</span> <span class="n">a_kap</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">two_gaussians</span><span class="p">,</span> <span class="n">clump_vel</span><span class="p">,</span>
                                                                <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])),</span>
                                                                <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ensembleDispersion</span><span class="p">[</span><span class="n">ens</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">eps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="p">,</span> <span class="n">a_eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">eps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="p">))</span>
                        <span class="n">epsilon_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># eps = []</span>
                        <span class="c1"># for i in range(self.__emissivity_species[ens].shape[1]):</span>
                        <span class="c1">#     fn = interp1d(clump_vel, self.__emissivity_species[ens][:, i],</span>
                        <span class="c1">#                   kind=kind, fill_value=0, bounds_error=False)</span>
                        <span class="c1">#     eps.append(fn(constants.velocityRange))</span>
                        <span class="c1"># epsilon_species.append(np.asarray(eps).T)</span>
                        <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                            <span class="n">fn</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">clump_vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">],</span>
                                          <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fn</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">clump_vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">],</span>
                                          <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">epsilon_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">include_dust</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="n">epsilon_dust_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                           <span class="n">epsilon_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                <span class="n">epsilon_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">epsilon_dust_interp</span><span class="p">(</span><span class="mf">0.21106</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                                    <span class="n">epsilon_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">epsilon_dust_interp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                <span class="n">epsilon_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">epsilon_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)):</span>
                                    <span class="n">epsilon_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">epsilon_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                        <span class="n">epsilon_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">epsilon_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epsilon_species</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_dust</span><span class="p">:</span>
                <span class="n">epsilon_dust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_dust</span>
                <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">epsilon_dust_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                       <span class="n">epsilon_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">epsilon_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">epsilon_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">epsilon_dust_interp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)):</span>
                            <span class="n">epsilon_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">epsilon_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">epsilon_species</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">epsilon_species</span><span class="p">)</span></div>

  
<div class="viewcode-block" id="Voxel.get_species_absorption">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_species_absorption">[docs]</a>
    <span class="k">def</span> <span class="nf">get_species_absorption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                               <span class="n">hi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="n">kappa_species</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">include_dust</span><span class="p">:</span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">kappa_dust</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dust_absorption</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kappa_dust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_absorption</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
                    <span class="n">clump_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocities</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocity_indeces</span><span class="p">[</span><span class="n">ens</span><span class="p">]]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span>
                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                        <span class="n">kap</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                            <span class="n">diff_eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">diff_kap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">diff_eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">diff_kap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">diff_eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">diff_kap</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                    <span class="n">a_eps</span><span class="p">,</span> <span class="n">a_kap</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">two_gaussians</span><span class="p">,</span> <span class="n">clump_vel</span><span class="p">,</span>
                                                                    <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])),</span>
                                                                    <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ensembleDispersion</span><span class="p">[</span><span class="n">ens</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">a_eps</span><span class="p">,</span> <span class="n">a_kap</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">two_gaussians</span><span class="p">,</span> <span class="n">clump_vel</span><span class="p">,</span>
                                                                    <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])),</span>
                                                                    <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ensembleDispersion</span><span class="p">[</span><span class="n">ens</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">kap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="p">,</span> <span class="n">a_kap</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">kap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="p">))</span>
                        <span class="n">kappa_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">kap</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># kap = []</span>
                        <span class="c1"># for i in range(self.__absorption_species[ens].shape[1]):</span>
                        <span class="c1">#     fn = interp1d(clump_vel, self.__absorption_species[ens][:, i],</span>
                        <span class="c1">#                   kind=kind, fill_value=0, bounds_error=False)</span>
                        <span class="c1">#     kap.append(fn(constants.velocityRange))</span>
                        <span class="c1"># kappa_species.append(np.asarray(kap).T)</span>
                        <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                            <span class="n">fn</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">clump_vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">],</span>
                                          <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fn</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">clump_vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">],</span>
                                          <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">kappa_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">include_dust</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="n">kappa_dust_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                         <span class="n">kappa_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                <span class="n">kappa_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">kappa_dust_interp</span><span class="p">(</span><span class="mf">0.21106</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                                    <span class="n">kappa_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">kappa_dust_interp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                <span class="n">kappa_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">kappa_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)):</span>
                                    <span class="n">kappa_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">kappa_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                        <span class="n">kappa_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__absorption_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kappa_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kappa_species</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_dust</span><span class="p">:</span>
                <span class="n">kappa_dust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span>
                <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">kappa_dust_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                     <span class="n">kappa_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">kappa_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">kappa_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">kappa_dust_interp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)):</span>
                            <span class="n">kappa_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">kappa_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">kappa_species</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">kappa_species</span><span class="p">)</span></div>


<div class="viewcode-block" id="Voxel.get_species_optical_depth">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_species_optical_depth">[docs]</a>
    <span class="k">def</span> <span class="nf">get_species_optical_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                  <span class="n">hi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="n">tau_species</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">include_dust</span><span class="p">:</span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">tau_dust</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dust_optical_depth</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tau_dust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_optical_depth</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
                    <span class="n">clump_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocities</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocity_indeces</span><span class="p">[</span><span class="n">ens</span><span class="p">]]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span>
                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                        <span class="n">tau</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                            <span class="n">diff_eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">diff_kap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">diff_eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">diff_kap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__opticalDepthSpecies</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">diff_eps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">diff_kap</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                    <span class="n">a_eps</span><span class="p">,</span> <span class="n">a_kap</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">two_gaussians</span><span class="p">,</span> <span class="n">clump_vel</span><span class="p">,</span>
                                                                    <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])),</span>
                                                                    <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ensembleDispersion</span><span class="p">[</span><span class="n">ens</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">a_eps</span><span class="p">,</span> <span class="n">a_kap</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">two_gaussians</span><span class="p">,</span> <span class="n">clump_vel</span><span class="p">,</span>
                                                                    <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])),</span>
                                                                    <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ensembleDispersion</span><span class="p">[</span><span class="n">ens</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">tau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="p">,</span> <span class="n">a_kap</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">tau</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="p">))</span>
                        <span class="n">tau_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># tau = []</span>
                        <span class="c1"># for i in range(self.__opticalDepthSpecies[ens].shape[1]):</span>
                        <span class="c1">#     fn = interp1d(clump_vel, self.__opticalDepthSpecies[ens][:, i],</span>
                        <span class="c1">#                   kind=kind, fill_value=0, bounds_error=False)</span>
                        <span class="c1">#     tau.append(fn(constants.velocityRange))</span>
                        <span class="c1"># tau_species.append(np.asarray(tau).T)</span>
                        <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                            <span class="n">fn</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">clump_vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">],</span>
                                          <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fn</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">clump_vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">],</span>
                                          <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">tau_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">include_dust</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="n">tau_dust_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                           <span class="n">tau_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                <span class="n">tau_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tau_dust_interp</span><span class="p">(</span><span class="mf">0.21106</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                                    <span class="n">tau_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tau_dust_interp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                <span class="n">tau_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tau_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)):</span>
                                    <span class="n">tau_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tau_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                        <span class="n">tau_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_hi</span><span class="p">[</span><span class="n">ens</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tau_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]))</span>
        <span class="c1">#else:</span>
        <span class="c1">#    return</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tau_species</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tau_species</span><span class="p">)</span></div>

  
<div class="viewcode-block" id="Voxel.get_species_intensity">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_species_intensity">[docs]</a>
    <span class="k">def</span> <span class="nf">get_species_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integrated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                              <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">total</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">integrated</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fit</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot return total intensity without first fitting. Returning fitted intensity instead.&#39;</span><span class="p">)</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">intensity_final</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span><span class="c1">#total:</span>
                <span class="n">epsilon_species</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_species_emissivity</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="n">include_dust</span><span class="p">,</span>
                                                               <span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="n">hi</span><span class="p">)]</span>
                <span class="n">kappa_species</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_species_absorption</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="n">include_dust</span><span class="p">,</span>
                                                             <span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="n">hi</span><span class="p">)]</span>
                <span class="n">tau_species</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_species_optical_depth</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="n">include_dust</span><span class="p">,</span>
                                                              <span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="n">hi</span><span class="p">)]</span>
                <span class="n">ensembles</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epsilon_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_emissivity</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                              <span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="n">hi</span><span class="p">)</span>
                <span class="n">kappa_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_absorption</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="n">hi</span><span class="p">)</span>
                <span class="n">tau_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_optical_depth</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                             <span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="n">hi</span><span class="p">)</span>
                <span class="n">intensity_dust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_intensity</span><span class="p">(</span><span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ensembles</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span>
            <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ensembles</span><span class="p">):</span>
                <span class="n">clump_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocities</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">__clump_velocity_indeces</span><span class="p">[</span><span class="n">ens</span><span class="p">]]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">__velocity</span>
                <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
                    <span class="n">vel</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span>
                    <span class="c1">#if kind == &#39;gaussian&#39;:</span>
                    <span class="n">i_nan</span> <span class="o">=</span> <span class="n">kappa_species</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-16</span>
                    <span class="n">intensity</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">epsilon_species</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                    <span class="n">intensity</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="o">~</span><span class="n">i_nan</span><span class="p">]</span><span class="o">/</span><span class="n">kappa_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">*</span> \
                                        <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tau_species</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="o">~</span><span class="n">i_nan</span><span class="p">]))</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     intensity_species = self.__intensity_species[ens]</span>
                    <span class="c1">#     intensity_interp = interp1d(clump_vel, intensity_species,</span>
                    <span class="c1">#                                 kind=kind, fill_value=0, bounds_error=False, axis=0)</span>
                    <span class="c1">#     intensity = intensity_interp(vel)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vel</span> <span class="o">=</span> <span class="n">clump_vel</span>
                    <span class="n">intensity</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_species</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">integrated</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">intensity_dust_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                         <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                            <span class="n">intensity</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">intensity_dust_interp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)):</span>
                            <span class="n">intensity</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">intensity_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">include_dust</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="n">intensity_dust_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                             <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                <span class="n">intensity_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intensity_dust_interp</span><span class="p">(</span><span class="mf">0.21106</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                                    <span class="n">intensity_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intensity_dust_interp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                <span class="n">intensity_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)):</span>
                                    <span class="n">intensity_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">include_dust</span><span class="p">:</span>
                        <span class="n">intensity_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">intensity</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">intensity_dust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_intensity</span><span class="p">(</span><span class="n">fit</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">intensity_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">intensity</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="n">intensity_dust_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                             <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                <span class="n">intensity_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">intensity_dust_interp</span><span class="p">(</span><span class="mf">0.21106</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                                    <span class="n">intensity_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">intensity_dust_interp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">hi</span><span class="p">:</span>
                                <span class="n">intensity_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">)):</span>
                                    <span class="n">intensity_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_species_emissivity</span><span class="p">(</span><span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)]</span>
                <span class="n">kappa</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_species_absorption</span><span class="p">(</span><span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)]</span>
                <span class="n">intensity_dust</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dust_intensity</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_emissivity</span><span class="p">(</span><span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
                <span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_absorption</span><span class="p">(</span><span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
                <span class="n">intensity_dust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_intensity</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
            <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_fv</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                <span class="n">intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">kappa</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">*</span><span class="n">ds</span><span class="p">))</span>
                <span class="n">i_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="n">intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i_nan</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">include_dust</span> <span class="ow">or</span> <span class="p">(</span><span class="n">include_dust</span> <span class="ow">and</span> <span class="n">integrated</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">intensity_dust_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                       <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">intensity_dust_interp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">-=</span> <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">integrated</span><span class="p">:</span>
                <span class="n">intensity_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">intensity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intensity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)):</span>
                    <span class="n">intensity_final</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">],</span> <span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">include_dust</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">intensity_dust_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span>
                                                           <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">):</span>
                                <span class="n">intensity_final</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intensity_dust_interp</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">intensity_final</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intensity_final</span> <span class="o">=</span> <span class="n">intensity</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">intensity_final</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">intensity_final</span><span class="p">)</span></div>

  
<div class="viewcode-block" id="Voxel.get_dust_emissivity">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_dust_emissivity">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dust_emissivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
                <span class="n">emissivity</span> <span class="o">=</span> <span class="p">[([</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">emissivity</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_dust</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">emissivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__emissivity_dust</span>
        <span class="k">if</span> <span class="n">minimal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">emissivity</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">emissivity</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">emissivity</span><span class="p">)</span></div>

  
<div class="viewcode-block" id="Voxel.get_dust_absorption">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_dust_absorption">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dust_absorption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
                <span class="n">absorption</span> <span class="o">=</span> <span class="p">[([</span><span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">absorption</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">absorption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__absorption_dust</span>
        <span class="k">if</span> <span class="n">minimal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">absorption</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">absorption</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">absorption</span><span class="p">)</span></div>


<div class="viewcode-block" id="Voxel.get_dust_optical_depth">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_dust_optical_depth">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dust_optical_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
                <span class="n">optical_depth</span> <span class="o">=</span> <span class="p">[([</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">optical_depth</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optical_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optical_depth_dust</span>
        <span class="k">if</span> <span class="n">minimal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">optical_depth</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">optical_depth</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">optical_depth</span><span class="p">)</span></div>

  
<div class="viewcode-block" id="Voxel.get_dust_intensity">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.get_dust_intensity">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dust_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
                    <span class="n">intensity</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([([</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([([</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                                          <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
                    <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">intensity</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__intensity_dust</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span><span class="c1">#total:</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dust_emissivity</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)]</span>
                <span class="n">kappa</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dust_absorption</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_emissivity</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
                <span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_absorption</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
            <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_mass_number</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_fv</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__volume_factor</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">voxel_size</span>
                <span class="n">intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">/</span><span class="n">kappa</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">*</span><span class="n">ds</span><span class="p">))</span>
                <span class="n">i_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
                <span class="n">intensity</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i_nan</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">i_nan</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">minimal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span></div>


<div class="viewcode-block" id="Voxel.plot_clump_number">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.plot_clump_number">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_clump_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">effective</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$v_i \ \left( \mathrm{\frac</span><span class="si">{km}{s}</span><span class="s1">} \right)$&#39;</span>
        <span class="k">if</span> <span class="n">effective</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mathcal</span><span class="si">{N}</span><span class="s1">_mathrm</span><span class="si">{eff}</span><span class="s1">$&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Clump ensemble </span><span class="si">{}</span><span class="s1"> effective number&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mathcal</span><span class="si">{N}</span><span class="s1">$&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Clump ensemble </span><span class="si">{}</span><span class="s1"> number&#39;</span>

        <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">):</span>
            <span class="n">dNj_dvi</span> <span class="o">=</span> <span class="n">combinations</span><span class="o">.</span><span class="n">clump_combination</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Sum over clump types</span>
            <span class="k">if</span> <span class="n">effective</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_calc</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dNj_dvi</span> <span class="o">=</span> <span class="n">dNj_dvi</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">clump_dispersion</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">pji</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpProbability</span><span class="p">[</span><span class="n">ens</span><span class="p">])</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpVelocities</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">ensemble</span><span class="o">.</span><span class="n">clumpIndeces</span><span class="p">[</span><span class="n">ens</span><span class="p">]])</span>
            <span class="n">N</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">probability</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pji</span><span class="p">):</span>
                <span class="n">pi</span> <span class="o">=</span> <span class="n">probability</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">probability</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Product over clump types and normalise</span>
                <span class="n">N</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pi</span> <span class="o">*</span> <span class="n">dNj_dvi</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>  <span class="c1"># Sum over combinations</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total number: </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">vel</span><span class="p">)))</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ens</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ax</span></div>

  
<div class="viewcode-block" id="Voxel.plot_transition">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.plot_transition">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transition</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">logscale</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plot the transition emission with respect to the voxel velocity structure</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    
        <span class="k">if</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transition</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="p">[</span><span class="n">transition</span><span class="p">]</span>
    
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transition</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">pass</span>
    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span>
    
        <span class="k">if</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;emissivity&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_emissivity</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="n">include_dust</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\epsilon_{\lambda} \ \left( \mathrm{\frac</span><span class="si">{K}{pc}</span><span class="s1">} \right)$&#39;</span>
        <span class="k">elif</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;absorption&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_absorption</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="n">include_dust</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\kappa_{\lambda} \ \left( \mathrm{\frac</span><span class="si">{1}{pc}</span><span class="s1">} \right)$&#39;</span>
        <span class="k">elif</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;optical depth&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_optical_depth</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="n">include_dust</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\tau_{\lambda} \ \left( \mathrm{N/A} \right)$&#39;</span>
        <span class="k">elif</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;intensity&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_intensity</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="n">include_dust</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$I_{\lambda} \ \left( \mathrm</span><span class="si">{K}</span><span class="s1"> \right)$&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Quantity </span><span class="si">{}</span><span class="s1"> not available.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quantity</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
    
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
    
        <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
    
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>
      
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span>
      
            <span class="n">vel</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">velocity_range</span>  <span class="c1"># [self.__clumpVelocityIndeces[ens]]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
      
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">trans</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transition</span><span class="p">):</span>
      
                <span class="k">if</span> <span class="n">trans</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{}</span><span class="s1"> not in model.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trans</span><span class="p">))</span>
                    <span class="k">continue</span>
        
                <span class="k">if</span> <span class="n">constants</span><span class="o">.</span><span class="n">interclump_idx</span><span class="p">[</span><span class="n">ens</span><span class="p">]:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">trans</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">interclump_transitions</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">trans</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">ens</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">label</span><span class="p">:</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
      
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$V_r \ ( \mathrm{\frac</span><span class="si">{km}{s}</span><span class="s1">} )$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
      
            <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Clump set </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ens</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">quantity</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
        <span class="c1"># plt.show()</span>
    
        <span class="k">return</span> <span class="n">axes</span></div>

  
<div class="viewcode-block" id="Voxel.plot_spectrum">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.plot_spectrum">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">integrated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plot the either the intesity or optical depth spectrum at the voxel velocity (the velocity with the largest</span>
<span class="sd">        ensemble).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>

        <span class="c1"># mpl.rcParams[&#39;text.usetex&#39;] = True</span>
    
        <span class="n">species_colour</span> <span class="o">=</span> <span class="p">{</span>
                           <span class="s1">&#39;C+&#39;</span><span class="p">:</span> <span class="s1">&#39;xkcd:orange&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;xkcd:red&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="s1">&#39;xkcd:violet&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;CO&#39;</span><span class="p">:</span> <span class="s1">&#39;xkcd:maroon&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;13C+&#39;</span><span class="p">:</span> <span class="s1">&#39;xkcd:light blue&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;13C&#39;</span><span class="p">:</span> <span class="s1">&#39;xkcd:blue&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;13CO&#39;</span><span class="p">:</span> <span class="s1">&#39;xkcd:sapphire&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;HCO+&#39;</span><span class="p">:</span> <span class="s1">&#39;xkcd:neon green&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;H13CO+&#39;</span><span class="p">:</span> <span class="s1">&#39;xkcd:forrest green&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;H3O+&#39;</span><span class="p">:</span> <span class="s1">&#39;xkcd:vomit&#39;</span>
                         <span class="p">}</span>
    
        <span class="n">nDust</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    
        <span class="k">if</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;emissivity&#39;</span><span class="p">:</span>
            <span class="n">valueDust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_emissivity</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">valueSpecies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_emissivity</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\epsilon_{\lambda} \ \left( \mathrm{\frac</span><span class="si">{K}{pc}</span><span class="s1">} \right)$&#39;</span>
    
        <span class="k">elif</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;absorption&#39;</span><span class="p">:</span>
            <span class="n">valueDust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_absorption</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">valueSpecies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_absorption</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\kappa_{\lambda} \ \left( \mathrm{\frac</span><span class="si">{1}{pc}</span><span class="s1">} \right)$&#39;</span>
    
        <span class="k">elif</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;intensity&#39;</span><span class="p">:</span>
            <span class="n">valueDust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dust_intensity</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">integrated</span><span class="p">:</span>
                <span class="n">valueSpecies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_intensity</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                        <span class="n">integrated</span><span class="o">=</span><span class="n">integrated</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\varpi_{\lambda} \ \left( \mathrm{K \frac</span><span class="si">{km}{s}</span><span class="s1">} \right)$&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">valueSpecies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_intensity</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">include_dust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$I_{\lambda} \ \left( \mathrm</span><span class="si">{K}</span><span class="s1"> \right)$&#39;</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Quantity </span><span class="si">{}</span><span class="s1"> not available.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quantity</span><span class="p">))</span>
            <span class="k">return</span>
    
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">))</span>
    
        <span class="k">for</span> <span class="n">ens</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ensembles</span><span class="p">):</span>
    
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span>
      
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span>
            
            <span class="c1"># if constants.interclump_idx[ens]:</span>
            <span class="c1">#     constants.resort_wavelengths(interclump=True)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     constants.resort_wavelengths()</span>

            <span class="k">if</span> <span class="n">integrated</span> <span class="ow">and</span> <span class="n">quantity</span><span class="o">==</span><span class="s1">&#39;intensity&#39;</span><span class="p">:</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">valueSpecies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">valueSpecies</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">vel</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valueSpecies</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">valueDust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dustInterp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span> <span class="n">valueDust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">vel</span><span class="p">,</span> <span class="p">:],</span>
                                      <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="mf">1e6</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">n_dust</span><span class="p">],</span> <span class="n">valueDust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">vel</span><span class="p">,</span> <span class="p">:],</span>
                          <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;xkcd:black&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dust_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">valueDust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">vel</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="mf">1e6</span><span class="o">*</span><span class="n">constants</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">]],</span> <span class="n">dust_spectrum</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;xkcd:black&#39;</span><span class="p">)</span>
            
            <span class="n">transition_species</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">colour</span> <span class="o">=</span> <span class="p">[]</span>
      
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transitions</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">valueDust</span><span class="p">[</span><span class="n">ens</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">valTemp</span> <span class="o">=</span> <span class="n">dustInterp</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">valTemp</span> <span class="o">=</span> <span class="n">valueDust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">vel</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">transition</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">transition_species</span><span class="p">:</span>
                    <span class="n">colour</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species_colour</span><span class="p">[</span><span class="n">transition</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">transition_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">([</span><span class="mf">1e6</span><span class="o">*</span><span class="n">species</span><span class="o">.</span><span class="n">clump_transition_wavelengths</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">valTemp</span><span class="p">,</span> <span class="n">valueSpecies</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">vel</span><span class="p">,</span> <span class="n">i</span><span class="p">]],</span>
                          <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colour</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
      
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">species_colour</span><span class="p">[</span><span class="n">transition</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">transition_species</span><span class="p">]</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">transition_species</span><span class="p">,</span> <span class="n">handles</span><span class="o">=</span><span class="n">lines</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\lambda \ (\mu \mathrm</span><span class="si">{m}</span><span class="s1">)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">valueDust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">vel</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">10e-3</span><span class="p">,</span> <span class="n">valueDust</span><span class="p">[</span><span class="n">ens</span><span class="p">][</span><span class="n">vel</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">10e3</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="c1"># plt.setp(ax.get_xticklabels(), fontsize=14)</span>
            <span class="c1"># plt.setp(ax.get_yticklabels(), fontsize=14)</span>
      
            <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Clump Set </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> spectrum&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ens</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">quantity</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        
        <span class="c1"># fig.tight_layout()</span>
    
        <span class="c1"># plt.show()</span>
    
        <span class="k">return</span> <span class="n">axes</span></div>

      
<div class="viewcode-block" id="Voxel.printVoxel">
<a class="viewcode-back" href="../../../_autosummary/kosmatau3d.models.voxel.Voxel.html#kosmatau3d.models.voxel.Voxel.printVoxel">[docs]</a>
    <span class="k">def</span> <span class="nf">printVoxel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Coming soon...</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span></div>
</div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Craig Yanitski.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>